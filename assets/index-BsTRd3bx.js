import{ab as fe,r as V,_ as I,F as S,c as v,J as T,l as _,d as C,U as P,V as A,k as c,e as u,g as U,N as B,h as R,n as ve,f as E,j as te,am as ge,W as F,T as O,Y as le,v as ne,w as ae}from"./index-DWtISIBF.js";/* empty css             */import{c as ye}from"./header-BNIxu-rR.js";import{E as se,a as ie}from"./col-Dnq3X4bl.js";import{E as ue}from"./empty-CAh1XabF.js";import{d as M}from"./dayjs.min-t3tQ4ZJg.js";import{E as Z}from"./card-Cr9tAXzl.js";/* empty css                */import{E as ce}from"./popper-BNb2tGl7.js";import{_ as be}from"./AnimatedNumber--zZLZDKs.js";import{g as re}from"./price-BqtQkkR2.js";import{c as H}from"./calculateCompare-BbnJreb3.js";import{u as L,E as he}from"./divider-CpdfInjN.js";import{E as $}from"./button-DfREtLL_.js";import{u as J}from"./area-CDc72icr.js";import{u as oe,b as K,p as Q}from"./meter-BWYCtTLu.js";import{h as N}from"./handleError-BsBqXgSR.js";import{u as Y,a as X}from"./energyUser-BdZ99M0S.js";import{E as we}from"./dialog-DnmK2X7S.js";import"./overlay-BY0G5ok6.js";import{E as Se,a as Ce}from"./form-item-ijUMtc9_.js";import"./input-B0bTKLmJ.js";import{E as Ue}from"./input-number-BcqdprSj.js";/* empty css            */import{E as de,a as me}from"./select-DYqyOwb9.js";import"./scrollbar-BMOxp_jN.js";import{E as Ve,a as ke}from"./radio-group-QDHk4pt3.js";/* empty css              */import{E as xe}from"./index-CuP5NVML.js";/* empty css             *//* empty css                 */import{_ as De}from"./设置-D6o4v_fI.js";import{E as Ee}from"./index-CZh1RU_w.js";import{C as Re}from"./CustomDatePicker-DTvPnXeh.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DibVzrKz.js";import"./index-CVAPKPs0.js";import"./use-form-item-CuJrx89H.js";import"./aria-BUADUvnR.js";import"./focus-trap-D8pg8SM_.js";import"./index-DjvbDGpK.js";import"./icon-Cc3ZZocH.js";/* empty css                        */import"./index-DYLzNb0k.js";import"./index-DxRU3L2W.js";import"./scroll-DMdoCUCr.js";import"./vnode-BIvhTfyw.js";import"./refs-BfLSHSPd.js";import"./castArray-6TPyo715.js";import"./_Uint8Array-DaZSNKBQ.js";import"./_initCloneObject-ChNElRpx.js";import"./index-CeeR5a7H.js";import"./index-0A8HTOTd.js";import"./isEqual-DqXByToB.js";import"./_baseIteratee-FAqII4j1.js";import"./index-DfeXTFmx.js";import"./date-picker-B_H4_mfX.js";const j=fe("waterPrice",()=>{const x=V([]),t=V([]);return{priceDetail:x,lastPriceDetail:t,getPriceDetail:async f=>{let i=await re(f);f.area_id&&(i.data={...i.data,areas:[i.data]}),console.log(i.data),x.value=i.data},getLastPriceDetail:async f=>{let i=await re(f);t.value=i.data}}}),Pe={__name:"StatisticsCard",setup(x,{expose:t}){t();let s=j(),e=L(),f=S(()=>{var h,k;let r=((k=(h=s.priceDetail)==null?void 0:h.areas)==null?void 0:k.map(b=>b.rule_id))??[];return[...new Set(r)].map(b=>({type:e.getPriceRuleNameById(b),price:e.getPriceRulePriceById(b),color:"#409EFF"}))});const i=S(()=>{var r,y,h,k;return{waterUsage:{current:((r=s==null?void 0:s.priceDetail)==null?void 0:r.usage)??0,lastYear:((y=s==null?void 0:s.lastPriceDetail)==null?void 0:y.usage)??0},waterCost:{current:((h=s==null?void 0:s.priceDetail)==null?void 0:h.price)??0,lastYear:((k=s==null?void 0:s.lastPriceDetail)==null?void 0:k.price)??0},prices:f.value}}),m=r=>r>0?"compare-up":"compare-down",a=r=>r>0?"fa fa-arrow-up":"fa fa-arrow-down",l=S(()=>[{title:"用水单价",hasPrices:!0,icon:"fa fa-dollar",colorClass:"text-danger"},{title:"用水量",value:i.value.waterUsage.current,prefix:"",unit:"m³",icon:"fa fa-tint",colorClass:"text-success",compare:{value:H(+i.value.waterUsage.current,+i.value.waterUsage.lastYear),lastYear:i.value.waterUsage.lastYear}},{title:"用水费用",value:i.value.waterCost.current,prefix:"¥",icon:"fa fa-money",colorClass:"text-primary",compare:{value:H(+i.value.waterCost.current,+i.value.waterCost.lastYear),lastYear:i.value.waterCost.lastYear}}]),n={get waterPriceStore(){return s},set waterPriceStore(r){s=r},get priceRuleStore(){return e},set priceRuleStore(r){e=r},get prices(){return f},set prices(r){f=r},staticData:i,getCompareClass:m,getCompareIcon:a,costStatistics:l,computed:S,AnimatedNumber:be,get useWaterPriceStore(){return j},get calculateCompare(){return H},get usePriceRuleStore(){return L}};return Object.defineProperty(n,"__isScriptSetup",{enumerable:!1,value:!0}),n}},We={class:"stat-header"},Te={class:"stat-title"},Me={key:1,class:"prices-grid"},Ae={class:"type-text"},Fe={class:"price-value"},Oe={key:2,class:"stat-compare"},Le={class:"compare-current"},Ye={class:"compare-last"};function je(x,t,s,e,f,i){const m=ce,a=Z,l=se,n=ie;return v(),T(n,{gutter:20,class:"statistics"},{default:_(()=>[(v(!0),C(P,null,A(e.costStatistics,r=>(v(),T(l,{span:8,key:r.title},{default:_(()=>[c(a,{shadow:"hover",class:"stat-card"},{default:_(()=>[u("div",We,[u("div",Te,U(r.title),1),u("div",{class:B(["stat-icon",r.colorClass])},[u("i",{class:B(r.icon)},null,2)],2)]),r.hasPrices?R("",!0):(v(),C("div",{key:0,class:B(["stat-value",r.colorClass])},[c(e.AnimatedNumber,{value:r.value,prefix:r.prefix,suffix:r.unit},null,8,["value","prefix","suffix"])],2)),r.hasPrices?(v(),C("div",Me,[(v(!0),C(P,null,A(e.staticData.prices,y=>(v(),C("div",{key:y.type,class:"price-item"},[u("div",{class:"price-circle",style:ve({backgroundColor:y.color})},[c(m,{content:y.type,placement:"top"},{default:_(()=>[u("span",Ae,U(y.type.slice(0,2)),1)]),_:2},1032,["content"])],4),u("div",Fe,"¥"+U(y.price)+"/m³",1)]))),128))])):R("",!0),r.compare?(v(),C("div",Oe,[u("div",Le,[t[0]||(t[0]=u("span",{class:"compare-label"},"同比",-1)),u("span",{class:B(["compare-value",e.getCompareClass(r.compare.value)])},[u("i",{class:B(e.getCompareIcon(r.compare.value))},null,2),E(" "+U(r.compare.value)+"% ",1)],2)]),u("div",Ye," 去年同期："+U(r.prefix)+U(r.compare.lastYear)+U(r.unit),1)])):R("",!0)]),_:2},1024)]),_:2},1024))),128))]),_:1})}const Ie=I(Pe,[["render",je],["__scopeId","data-v-1dd6c197"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/StatisticsCard.vue"]]),Be={__name:"WaterUsageTable",props:{dateRange:{type:Array,default:[]}},setup(x,{expose:t}){t();let s=j(),e=L(),f=J(),i=x;const m=V(),a=S(()=>{var p;const b=((p=s==null?void 0:s.priceDetail)==null?void 0:p.areas)??[],D=i.dateRange;return b.map(w=>({date:`${M(D[0]).format("YYYY-MM-DD")}至${M(D[1]).format("YYYY-MM-DD")}`,area:f.getAreaNameById(w.area_id),waterType:e.getPriceRuleNameById(w.rule_id),price:+e.getPriceRulePriceById(w.rule_id),usage:+w.usage,fee:+w.price}))}),l=S(()=>a.value.length?[{row:0,col:0,rowspan:a.value.length,colspan:1}]:[]),n=()=>a.value.reduce((D,p)=>D+p.usage,0).toFixed(2),r=()=>a.value.reduce((D,p)=>D+p.fee,0).toFixed(2),y=V([{date:"合计",usage:S(()=>n()),fee:S(()=>r())}]),k={get waterPriceStore(){return s},set waterPriceStore(b){s=b},get priceRuleStore(){return e},set priceRuleStore(b){e=b},get areaStore(){return f},set areaStore(b){f=b},get props(){return i},set props(b){i=b},tableRef:m,tableData:a,computedMergeCells:l,getTotalUsage:n,getTotalFee:r,footerData:y,exportEvent:()=>{const b=m.value;b&&b.openExport({filename:"水费明细表",type:"xlsx",exportMethod:({options:D})=>b.exportData(Object.assign({},D,{original:!1,formatter:!0,footer:!0,columnFilterMethod:({column:p})=>p.property!=="seq"}))})},get useAreaStore(){return J},get usePriceRuleStore(){return L},get useWaterPriceStore(){return j},get dayjs(){return M},ref:V,computed:S};return Object.defineProperty(k,"__isScriptSetup",{enumerable:!1,value:!0}),k}};function Ne(x,t,s,e,f,i){const m=$,a=te("vxe-column"),l=te("vxe-table"),n=Z;return v(),T(n,null,{header:_(()=>[t[1]||(t[1]=u("div",{class:"title"},"水费明细表",-1)),c(m,{size:"small",type:"primary",icon:"download",onClick:e.exportEvent,class:"export-btn"},{default:_(()=>t[0]||(t[0]=[E(" 导出表格 ")])),_:1})]),default:_(()=>[c(l,{border:"","show-footer":"",ref:"tableRef","export-config":{type:"xlsx"},data:e.tableData,"merge-cells":e.computedMergeCells,"footer-data":e.footerData,height:"330","row-config":{height:50}},{default:_(()=>[c(a,{field:"date",title:"日期"}),c(a,{field:"area",title:"区域"}),c(a,{field:"waterType",title:"用水类型"}),c(a,{field:"price",title:"水单价"},{default:_(({row:r})=>[E(U(r.price.toFixed(2)),1)]),_:1}),c(a,{field:"usage",title:"用水量"},{default:_(({row:r})=>[E(U(r.usage.toFixed(2)),1)]),_:1}),c(a,{field:"fee",title:"水费"},{default:_(({row:r})=>[E(U(r.fee.toFixed(2)),1)]),_:1})]),_:1},8,["data","merge-cells","footer-data"])]),_:1})}const ze=I(Be,[["render",Ne],["__scopeId","data-v-e75726dc"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/WaterUsageTable.vue"]]),qe={__name:"UnknownWaterDialog",props:{modelValue:Boolean,currentMethod:{type:String,default:"water"}},emits:["update:modelValue","confirm"],setup(x,{expose:t,emit:s}){t();const e=x,f=s,i=Y(),m=S({get:()=>e.modelValue,set:o=>f("update:modelValue",o)}),a=V({method:e.currentMethod,users:[]}),l=V(null),n=S(()=>{const o=a.value.users.map(g=>g.id);return i.energyUserList.filter(g=>!o.includes(g.id))}),r=S(()=>a.value.users.reduce((o,g)=>o+(g.area||0),0)),y=S(()=>a.value.users.reduce((o,g)=>o+(g.water||0),0)),h=S(()=>a.value.users.reduce((o,g)=>o+(g.persons||0),0)),k=S(()=>a.value.users.reduce((o,g)=>o+(g.ratio||0),0)),b=S(()=>{if(a.value.users.length===0)return!1;switch(a.value.method){case"area":return a.value.users.every(o=>o.area>0);case"water":return a.value.users.every(o=>o.water>0);case"person":return a.value.users.every(o=>o.persons>0);case"custom":return Math.abs(k.value-100)<.01;default:return!1}});function D(o){if(!o)return;const g=i.energyUserList.find(G=>G.id===o);g&&a.value.users.push({id:g.id,name:g.name,area:0,water:0,persons:0,ratio:0}),l.value=null}function p(){const o=a.value.users;if(o.length!==0)switch(a.value.method){case"area":r.value>0&&o.forEach(g=>{g.ratio=g.area/r.value*100});break;case"water":y.value>0&&o.forEach(g=>{g.ratio=g.water/y.value*100});break;case"person":h.value>0&&o.forEach(g=>{g.ratio=g.persons/h.value*100});break}}function w(o){if(a.value.method!=="custom")return;const g=a.value.users,G=g.reduce((ee,pe,_e)=>_e!==o?ee+(pe.ratio||0):ee,0);G+g[o].ratio>100&&(g[o].ratio=100-G)}function d(o){a.value.users.splice(o,1),a.value.method!=="custom"&&p()}function W(){f("confirm",{method:a.value.method,users:a.value.users.map(o=>({id:o.id,name:o.name,ratio:o.ratio}))}),m.value=!1}function z(){a.value.users=[],m.value=!1}const q={props:e,emit:f,energyUsersStore:i,visible:m,form:a,selectedUser:l,availableUsers:n,totalArea:r,totalWater:y,totalPersons:h,totalRatio:k,isValid:b,handleUserSelect:D,calculateRatios:p,adjustOtherRatios:w,removeUser:d,handleConfirm:W,handleCancel:z,ref:V,computed:S,get Delete(){return ge},get useEnergyUsersStore(){return Y}};return Object.defineProperty(q,"__isScriptSetup",{enumerable:!1,value:!0}),q}},Ge={key:0,class:"users-list"},Je={class:"user-info"},He={class:"user-name"},Ke={class:"ratio"},Qe={class:"ratio"},Xe={class:"ratio"},Ze={class:"total-info"},$e={key:0},et={key:1},tt={key:2},at={key:3,class:"error-text"},rt={class:"dialog-footer"};function ot(x,t,s,e,f,i){const m=Ve,a=ke,l=Se,n=de,r=me,y=Ue,h=xe,k=$,b=Ce,D=we;return v(),T(D,{modelValue:e.visible,"onUpdate:modelValue":t[2]||(t[2]=p=>e.visible=p),title:"设置不明水分摊规则",width:"800px"},{footer:_(()=>[u("span",rt,[c(k,{onClick:e.handleCancel},{default:_(()=>t[8]||(t[8]=[E("取消")])),_:1}),c(k,{type:"primary",disabled:!e.isValid,onClick:e.handleConfirm},{default:_(()=>t[9]||(t[9]=[E(" 确认 ")])),_:1},8,["disabled"])])]),default:_(()=>[c(b,{model:e.form,"label-width":"120px"},{default:_(()=>[c(l,{label:"分摊方式"},{default:_(()=>[c(a,{modelValue:e.form.method,"onUpdate:modelValue":t[0]||(t[0]=p=>e.form.method=p)},{default:_(()=>[c(m,{value:"water",label:"water"},{default:_(()=>t[3]||(t[3]=[E("用水量比例")])),_:1}),c(m,{value:"area",label:"area"},{default:_(()=>t[4]||(t[4]=[E("面积比例")])),_:1}),c(m,{value:"person",label:"person"},{default:_(()=>t[5]||(t[5]=[E("人数比例")])),_:1}),c(m,{value:"custom",label:"custom"},{default:_(()=>t[6]||(t[6]=[E("自定义比例")])),_:1})]),_:1},8,["modelValue"])]),_:1}),c(l,{label:"添加用能户"},{default:_(()=>[c(r,{modelValue:e.selectedUser,"onUpdate:modelValue":t[1]||(t[1]=p=>e.selectedUser=p),filterable:"",clearable:"",placeholder:"请选择用能户",onChange:e.handleUserSelect},{default:_(()=>[(v(!0),C(P,null,A(e.availableUsers,p=>(v(),T(n,{key:p.id,label:p.name,value:p.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e.form.users.length>0?(v(),C("div",Ge,[(v(!0),C(P,null,A(e.form.users,(p,w)=>(v(),C("div",{key:p.id,class:"user-item"},[u("div",Je,[u("span",He,U(p.name),1),e.form.method==="area"?(v(),C(P,{key:0},[c(y,{modelValue:p.area,"onUpdate:modelValue":d=>p.area=d,min:0,precision:2,placeholder:"面积(m²)",onChange:e.calculateRatios},null,8,["modelValue","onUpdate:modelValue"]),u("span",Ke,U(p.ratio.toFixed(2))+"%",1)],64)):R("",!0),e.form.method==="water"?(v(),C(P,{key:1},[c(y,{modelValue:p.water,"onUpdate:modelValue":d=>p.water=d,min:0,precision:2,placeholder:"用水量(m³)",onChange:e.calculateRatios},null,8,["modelValue","onUpdate:modelValue"]),u("span",Qe,U(p.ratio.toFixed(2))+"%",1)],64)):R("",!0),e.form.method==="person"?(v(),C(P,{key:2},[c(y,{modelValue:p.persons,"onUpdate:modelValue":d=>p.persons=d,min:0,precision:0,placeholder:"人数",onChange:e.calculateRatios},null,8,["modelValue","onUpdate:modelValue"]),u("span",Xe,U(p.ratio.toFixed(2))+"%",1)],64)):R("",!0),e.form.method==="custom"?(v(),T(y,{key:3,modelValue:p.ratio,"onUpdate:modelValue":d=>p.ratio=d,min:0,max:100,precision:2,placeholder:"比例(%)",onChange:d=>e.adjustOtherRatios(w)},null,8,["modelValue","onUpdate:modelValue","onChange"])):R("",!0),c(k,{type:"danger",circle:"",size:"small",onClick:d=>e.removeUser(w)},{default:_(()=>[c(h,null,{default:_(()=>[c(e.Delete)]),_:1})]),_:2},1032,["onClick"])])]))),128)),u("div",Ze,[t[7]||(t[7]=u("span",null,"总计:",-1)),e.form.method==="area"?(v(),C("span",$e,"面积: "+U(e.totalArea)+"m² / ",1)):R("",!0),e.form.method==="water"?(v(),C("span",et,"用水量: "+U(e.totalWater)+"m³ / ",1)):R("",!0),e.form.method==="person"?(v(),C("span",tt,"人数: "+U(e.totalPersons)+"人 / ",1)):R("",!0),u("span",null,"比例: "+U(e.totalRatio.toFixed(2))+"%",1),e.form.method==="custom"&&Math.abs(e.totalRatio-100)>.01?(v(),C("span",at," (请调整至100%)")):R("",!0)])])):R("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])}const lt=I(qe,[["render",ot],["__scopeId","data-v-8bdec8cf"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/components/UnknownWaterDialog.vue"]]),nt={__name:"UnknownWaterAnalysisCard",props:{dateRange:{type:Array,default:()=>[]}},setup(x,{expose:t}){t();let s=V(!1),e=x,f=oe(),i=Y(),m=S(()=>f.meterLevels[0]),a=S(()=>f.meterLevels[1]),l=V(0),n=V(0),r=F();O(async()=>{e.dateRange.length&&r.currentCompany&&await y()});async function y(){try{s.value=!0;let d=await Promise.all(m.value.map(o=>K({id:o.id,start_time:e.dateRange[0],end_time:e.dateRange[1],interval:"day"}))),W=await Promise.all(a.value.map(o=>K({id:o.id,start_time:e.dateRange[0],end_time:e.dateRange[1],interval:"day"}))),z=Q(d.map(o=>o.aggregated_data)).reduce((o,g)=>o+g.Value,0),q=Q(W.map(o=>o.aggregated_data)).reduce((o,g)=>o+g.Value,0);n.value=z.toFixed(2),l.value=(z-q).toFixed(2)}catch(d){N(d,"获取不明水数据失败")}finally{s.value=!1}}const h=S(()=>({totalUsage:n.value,unknownUsage:l.value,distribution:i.energyUserList.filter(d=>+d.unknown_ratio).map(d=>({id:d.id,name:d.name,ratio:d.unknown_ratio*100,share:(d.unknown_ratio*l.value).toFixed(2)}))})),k=V(!1),b=V("water"),D=S(()=>(h.value.unknownUsage/h.value.totalUsage*100).toFixed(2)),w={get loading(){return s},set loading(d){s=d},get props(){return e},set props(d){e=d},get meterStore(){return f},set meterStore(d){f=d},get energyUsersStore(){return i},set energyUsersStore(d){i=d},get firstLevelMeters(){return m},set firstLevelMeters(d){m=d},get twoLevelMeters(){return a},set twoLevelMeters(d){a=d},get unknownUsage(){return l},set unknownUsage(d){l=d},get totalUsage(){return n},set totalUsage(d){n=d},get companyStore(){return r},set companyStore(d){r=d},getReportData:y,waterData:h,dialogVisible:k,currentMethod:b,percentage:D,handleDistributionConfirm:async d=>{b.value=d.method;try{s.value=!0,await Promise.all(h.value.distribution.map(W=>X({id:W.id,unknown_ratio:"0"}))),await Promise.all(d.users.map(async W=>X({id:W.id,unknown_ratio:""+W.ratio/100}))),await i.fetchEnergyUsers(),Ee.success("设置分摊规则成功")}catch(W){N(W,"设置分摊规则失败")}finally{s.value=!1,k.value=!1}},ref:V,computed:S,watchEffect:O,get getMeterReportApi(){return K},get useMeterStore(){return oe},get handleError(){return N},get processArrays(){return Q},get useEnergyUsersStore(){return Y},UnknownWaterDialog:lt,get useCompanyStore(){return F},get updateEnergyUsersApi(){return X}};return Object.defineProperty(w,"__isScriptSetup",{enumerable:!1,value:!0}),w}},st={class:"scrollbar-wrapper"},it={class:"unknown-water-summary"},ut={class:"statistics-section"},ct={class:"summary-item"},dt={class:"value"},mt={class:"summary-item"},pt={class:"label"},_t={class:"value"},ft={class:"distribution-section"},vt={key:0,class:"distribution-list"},gt={class:"item-header"},yt={class:"name"},bt={class:"ratio"},ht={class:"item-details"},wt={class:"detail-row"},St={class:"value highlight"};function Ct(x,t,s,e,f,i){const m=$,a=ce,l=he,n=ue,r=Z,y=ne;return v(),C(P,null,[le((v(),T(r,{class:"unknown-water-card"},{header:_(()=>[t[5]||(t[5]=u("span",null,"不明水分摊计算",-1)),c(a,{content:"设置不明水分摊规则"},{default:_(()=>[c(m,{type:"primary",size:"small",onClick:t[0]||(t[0]=h=>e.dialogVisible=!0)},{icon:_(()=>t[3]||(t[3]=[u("img",{src:De,width:"12px",height:"auto",alt:""},null,-1)])),default:_(()=>[t[4]||(t[4]=E(" 设置分摊规则 "))]),_:1})]),_:1})]),default:_(()=>[u("div",st,[u("div",it,[u("div",ut,[u("div",ct,[t[6]||(t[6]=u("div",{class:"label"},"总用水量",-1)),u("div",dt,U(e.waterData.totalUsage)+"m³",1)]),u("div",mt,[u("div",pt,"不明水量 ("+U(e.percentage)+"%)",1),u("div",_t,U(e.waterData.unknownUsage)+"m³",1)])]),c(l),u("div",ft,[e.waterData.distribution.length?(v(),C("div",vt,[(v(!0),C(P,null,A(e.waterData.distribution,h=>(v(),C("div",{key:h.name,class:"distribution-item"},[u("div",gt,[u("span",yt,U(h.name),1),u("span",bt,"占比: "+U(h.ratio)+"%",1)]),u("div",ht,[u("div",wt,[t[7]||(t[7]=u("span",{class:"label"},"分摊水量:",-1)),u("span",St,U(h.share)+"m³",1)])])]))),128))])):(v(),T(n,{key:1,description:"未设置分摊规则","image-size":100},{default:_(()=>[c(m,{type:"primary",onClick:t[1]||(t[1]=h=>e.dialogVisible=!0)},{default:_(()=>t[8]||(t[8]=[E(" 设置规则 ")])),_:1})]),_:1}))])])])]),_:1})),[[y,e.loading]]),c(e.UnknownWaterDialog,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[2]||(t[2]=h=>e.dialogVisible=h),"current-method":e.currentMethod,onConfirm:e.handleDistributionConfirm},null,8,["modelValue","current-method"])],64)}const Ut=I(nt,[["render",Ct],["__scopeId","data-v-51e790c3"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/UnknownWaterAnalysisCard.vue"]]),Vt={__name:"WaterFilter",props:{modelValue:{type:Object,default:()=>({type:"overview",subType:""})}},emits:["update:modelValue","change"],setup(x,{expose:t,emit:s}){t();let e=Y(),f=F(),i=J();const m=x,a=s,l=V({type:m.modelValue.type,subType:m.modelValue.subType}),n=[{value:"overview",label:"总览"},{value:"byEnergyUser",label:"按用能户浏览"},{value:"byArea",label:"按区域浏览"}],r=V({byArea:S(()=>i.areas.map(w=>({value:w.id,label:w.name}))),byEnergyUser:S(()=>e.energyUserList.map(w=>({value:w.id,label:w.name})))}),y=S(()=>r.value[l.value.type]),h=S(()=>({byArea:"请选择区域",byType:"请选择用水类型",byEnergyUser:"请选择用能户"})[l.value.type]||"请选择"),k=()=>{l.value.subType="",D()},b=()=>{D()},D=()=>{a("update:modelValue",{...l.value}),a("change",{...l.value})};ae(()=>m.modelValue,w=>{l.value={...w}},{deep:!0}),O(async()=>{await e.fetchEnergyUsers({company_id:f.currentCompany.id})});const p={get energyUsersStore(){return e},set energyUsersStore(w){e=w},get companyStore(){return f},set companyStore(w){f=w},get areaStore(){return i},set areaStore(w){i=w},props:m,emit:a,filterValue:l,primaryOptions:n,subOptions:r,currentSubOptions:y,getSubTypePlaceholder:h,handleTypeChange:k,handleSubTypeChange:b,updateValue:D,get useAreaStore(){return J},get useCompanyStore(){return F},get useEnergyUsersStore(){return Y},ref:V,computed:S,watch:ae,watchEffect:O};return Object.defineProperty(p,"__isScriptSetup",{enumerable:!1,value:!0}),p}},kt={class:"filter-container"};function xt(x,t,s,e,f,i){const m=de,a=me;return v(),C("div",kt,[c(a,{modelValue:e.filterValue.type,"onUpdate:modelValue":t[0]||(t[0]=l=>e.filterValue.type=l),class:"filter-item",placeholder:"请选择浏览方式",onChange:e.handleTypeChange},{default:_(()=>[(v(),C(P,null,A(e.primaryOptions,l=>c(m,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),e.filterValue.type!=="overview"?(v(),T(a,{key:0,modelValue:e.filterValue.subType,"onUpdate:modelValue":t[1]||(t[1]=l=>e.filterValue.subType=l),class:"filter-item",placeholder:e.getSubTypePlaceholder,onChange:e.handleSubTypeChange},{default:_(()=>[(v(!0),C(P,null,A(e.currentSubOptions,l=>(v(),T(m,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])):R("",!0)])}const Dt=I(Vt,[["render",xt],["__scopeId","data-v-de3bc69a"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/WaterFilter.vue"]]),Et={__name:"index",setup(x,{expose:t}){t();let s=j(),e=L(),f=F();const i=V(!1),m=V([M().startOf("month").valueOf(),M().endOf("month").valueOf()]);let a=V({type:"overview",subType:null});O(async()=>{try{let n={key:"company_id",value:f.currentCompany.id};switch(a.value.type){case"overview":n.key="company_id",n.value=f.currentCompany.id;break;case"byEnergyUser":if(a.value.subType)n.key="energy_user_id",n.value=a.value.subType;else return;break;case"byArea":if(a.value.subType)n.key="area_id",n.value=a.value.subType;else return;break;default:return}i.value=!0,await Promise.all([s.getPriceDetail({[n.key]:n.value,start_time:m.value[0],end_time:m.value[1]}),s.getLastPriceDetail({[n.key]:n.value,start_time:M(m.value[0]).subtract(1,"year").valueOf(),end_time:M(m.value[1]).subtract(1,"year").valueOf()}),e.fetchPriceRuleList({company_id:f.currentCompany.id})])}catch(n){N(n,"获取价格数据失败")}finally{i.value=!1}});const l={get priceStore(){return s},set priceStore(n){s=n},get priceRuleStore(){return e},set priceRuleStore(n){e=n},get companyStore(){return f},set companyStore(n){f=n},loading:i,dateRange:m,get filter(){return a},set filter(n){a=n},ref:V,watchEffect:O,get dayjs(){return M},StatisticsCard:Ie,WaterUsageTable:ze,UnknownWaterAnalysisCard:Ut,WaterFilter:Dt,get useCompanyStore(){return F},get handleError(){return N},get useWaterPriceStore(){return j},get usePriceRuleStore(){return L},CustomDatePicker:Re};return Object.defineProperty(l,"__isScriptSetup",{enumerable:!1,value:!0}),l}},Rt={class:"app-container"},Pt={class:"header page-title"},Wt={class:"header-left"},Tt={style:{width:"100%"}};function Mt(x,t,s,e,f,i){const m=ue,a=se,l=ie,n=ye,r=ne;return le((v(),C("div",Rt,[u("div",Pt,[u("div",Wt,[t[2]||(t[2]=E(" 用水费用概览 ")),c(e.WaterFilter,{modelValue:e.filter,"onUpdate:modelValue":t[0]||(t[0]=y=>e.filter=y)},null,8,["modelValue"])]),c(e.CustomDatePicker,{modelValue:e.dateRange,"onUpdate:modelValue":t[1]||(t[1]=y=>e.dateRange=y)},null,8,["modelValue"])]),c(n,{class:"main-container"},{default:_(()=>[u("div",Tt,[(v(),C(P,{key:1},[c(e.StatisticsCard,{class:"mb-16"}),c(l,{gutter:20,class:"mb-4"},{default:_(()=>[c(a,{span:16,style:{display:"flex","flex-direction":"column"}},{default:_(()=>[c(e.WaterUsageTable,{dateRange:e.dateRange},null,8,["dateRange"])]),_:1}),c(a,{span:8},{default:_(()=>[c(e.UnknownWaterAnalysisCard,{dateRange:e.dateRange},null,8,["dateRange"])]),_:1})]),_:1})],64))])]),_:1})])),[[r,e.loading]])}const La=I(Et,[["render",Mt],["__scopeId","data-v-ec2150d0"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/index.vue"]]);export{La as default};
