import{_ as ne,r as y,F as G,w as Q,W,c as d,J as E,j as l,e as u,i as o,f as v,d as g,U as b,V as R,I as h,cw as ue,g as V}from"./index-Bx6Y8L80.js";import{E as de,a as ce}from"./col-TrHbeXFY.js";import{E as me}from"./card-fNeABwz5.js";/* empty css            */import{E as H,a as K}from"./form-item-CWYWsPGl.js";import{E as X}from"./button-8bviUT_H.js";import{E as Z}from"./input-CFaQgGx5.js";import{E as ee,a as te}from"./select-BmMHn9PT.js";import"./scrollbar-DuXO1tWo.js";import"./popper-DBn8ulUn.js";import{u as pe,a as _e,c as fe,d as ve}from"./area-COPnz-hV.js";import{e as ye}from"./meter-5sbrBbgq.js";import{u as le}from"./energyUser-DEVB5SRj.js";import{E as ge}from"./dialog-Dt2QUqOw.js";import"./overlay-04qnzRyj.js";import{u as re,E as be}from"./divider-DslenhMj.js";import{b as J}from"./price-BNLDcrLr.js";import{h as Y}from"./handleError-DD4JYoq7.js";import{E as C}from"./index-KJp6TXG9.js";/* empty css             *//* empty css                 *//* empty css                   */import{E as Ee}from"./index-slq3sC_j.js";import{E as we}from"./index-A4BGBRGh.js";import{E as he}from"./index-aFn2MKle.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-iw6eP590.js";import"./index-CuyxIfpa.js";import"./use-form-item-50hJ8Ppj.js";import"./castArray-CrUPC_Z8.js";import"./_Uint8Array-B6mJ0Xm4.js";import"./_initCloneObject-nnMrnZRY.js";import"./index-AkNVqhGZ.js";import"./icon-6zrsquxY.js";import"./aria-BUADUvnR.js";import"./scroll-BawlEUY1.js";import"./isEqual-BM-Gj-iT.js";import"./_baseIteratee-CkjM3wkz.js";import"./index-zrRcpBp4.js";import"./focus-trap-Ddg061Nm.js";import"./dayjs.min-Cd48fqZ9.js";import"./index-DZY-cmUL.js";import"./vnode-DK7gyQZj.js";import"./refs-Bp53MkJS.js";/* empty css                        */import"./index-CWCMyxJA.js";import"./validator-ulZFuTQV.js";const Re={class:"dialog-footer"},Pe={__name:"AreaFormDialog",props:{modelValue:{type:Boolean,required:!0},title:{type:String,required:!0},formData:{type:Object,required:!0}},emits:["update:modelValue","submit","close","refresh"],setup($,{emit:L}){const U=re(),S=$,m=L,D=le(),w=y(null),r=y({id:null,name:"",energy_user_id:null,waterPriceRuleId:null,electricPriceRuleId:null,gasPriceRuleId:null}),p=y(null),k=y([]),x={name:[{required:!0,message:"请输入区域名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],energy_user_id:[]},F=G({get:()=>S.modelValue,set:n=>m("update:modelValue",n)});Q(()=>S.formData,n=>{var s,P,c,i,e,_;r.value={...n,waterPriceRuleId:((P=(s=n.waterMeters)==null?void 0:s[0])==null?void 0:P.price_rule_id)||null,electricPriceRuleId:((i=(c=n.electricMeters)==null?void 0:c[0])==null?void 0:i.price_rule_id)||null,gasPriceRuleId:((_=(e=n.gasMeters)==null?void 0:e[0])==null?void 0:_.price_rule_id)||null},p.value={name:n.name,energy_user_id:n.energy_user_id}},{deep:!0});let B=W();Q(()=>B.currentCompany,async()=>{B.currentCompany&&(await D.fetchEnergyUsers({company_id:B.currentCompany.id}),k.value=D.energyUserList)},{immediate:!0});async function q(){const n=[];if(r.value.id&&(r.value.waterPriceRuleId!==null&&n.push(J({id:r.value.waterPriceRuleId,area_id:r.value.id,type:1})),r.value.electricPriceRuleId!==null&&n.push(J({id:r.value.electricPriceRuleId,area_id:r.value.id,type:2})),r.value.gasPriceRuleId!==null&&n.push(J({id:r.value.gasPriceRuleId,area_id:r.value.id,type:3})),n.length>0))try{await Promise.all(n)}catch(s){return Y(s,"修改价格规则失败",!0),!1}return!0}function z(){const n={name:r.value.name,energy_user_id:r.value.energy_user_id};return n.name!==p.value.name||n.energy_user_id!==p.value.energy_user_id}async function j(){w.value&&await w.value.validate(async n=>{if(n)try{if(!await q())return;if(z()){const P={id:r.value.id,name:r.value.name,energy_user_id:r.value.energy_user_id,company_id:W().currentCompany.id};m("submit",P)}else m("refresh"),m("close");C.success("保存成功")}catch(s){Y(s,"保存失败",!0)}})}function N(){var n;(n=w.value)==null||n.resetFields(),m("close")}return(n,s)=>{const P=Z,c=H,i=ee,e=te,_=be,I=K,A=X,T=ge;return d(),E(T,{modelValue:F.value,"onUpdate:modelValue":s[5]||(s[5]=t=>F.value=t),title:$.title,width:"600px","destroy-on-close":!0,onClose:N},{footer:l(()=>[u("span",Re,[o(A,{onClick:N},{default:l(()=>s[7]||(s[7]=[v("取消")])),_:1}),o(A,{type:"primary",onClick:j},{default:l(()=>s[8]||(s[8]=[v("确定")])),_:1})])]),default:l(()=>[o(I,{ref_key:"formRef",ref:w,model:r.value,rules:x,"label-width":"100px"},{default:l(()=>[o(c,{label:"区域名称",prop:"name"},{default:l(()=>[o(P,{modelValue:r.value.name,"onUpdate:modelValue":s[0]||(s[0]=t=>r.value.name=t),placeholder:"请输入区域名称"},null,8,["modelValue"])]),_:1}),o(c,{label:"用能户",prop:"energy_user_id"},{default:l(()=>[o(e,{modelValue:r.value.energy_user_id,"onUpdate:modelValue":s[1]||(s[1]=t=>r.value.energy_user_id=t),placeholder:"请选择用能户",clearable:""},{default:l(()=>[(d(!0),g(b,null,R(k.value,t=>(d(),E(i,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(_,null,{default:l(()=>s[6]||(s[6]=[v("价格规则设置")])),_:1}),o(c,{label:"用水类别",prop:"waterPriceRuleId"},{default:l(()=>[o(e,{modelValue:r.value.waterPriceRuleId,"onUpdate:modelValue":s[2]||(s[2]=t=>r.value.waterPriceRuleId=t),clearable:""},{default:l(()=>[(d(!0),g(b,null,R(h(U).waterPriceRuleList,t=>(d(),E(i,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(c,{label:"用电类别",prop:"electricPriceRuleId"},{default:l(()=>[o(e,{modelValue:r.value.electricPriceRuleId,"onUpdate:modelValue":s[3]||(s[3]=t=>r.value.electricPriceRuleId=t),clearable:""},{default:l(()=>[(d(!0),g(b,null,R(h(U).electricityPriceRuleList,t=>(d(),E(i,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(c,{label:"用气类别",prop:"gasPriceRuleId"},{default:l(()=>[o(e,{modelValue:r.value.gasPriceRuleId,"onUpdate:modelValue":s[4]||(s[4]=t=>r.value.gasPriceRuleId=t),clearable:""},{default:l(()=>[(d(!0),g(b,null,R(h(U).gasPriceRuleList,t=>(d(),E(i,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}},Ve=ne(Pe,[["__scopeId","data-v-2f000521"]]),Ie={class:"area-management"},Ae={class:"page-header"},Me={class:"page-title",style:{display:"flex","align-items":"center",gap:"16px"}},Ce={class:"filter-section"},Ue={class:"area-name"},Se={class:"area-actions"},ke={class:"card-content"},xe={class:"info-section"},Be={class:"meters-section"},Le={class:"meter-box"},De={class:"meter-tags"},Fe={class:"meter-box"},Ne={class:"meter-tags"},Te={class:"meter-box"},$e={class:"meter-tags"},Bt={__name:"index",setup($){const L=pe(),U=W(),S=le(),m=re(),D=y([]),w=y(null),r=y(""),p=y(!1),k=y(""),x=y({id:null,name:"",energy_user_id:null}),F=G(()=>D.value.filter(i=>{const e=!w.value||i.energy_user_id===w.value,_=!r.value||i.name.toLowerCase().includes(r.value.toLowerCase());return e&&_}));function B(){}function q(i,e){if(!Array.isArray(i)||!Array.isArray(e))throw new Error("areas 和 meters 参数必须是数组");const _={1:"waterMeters",2:"electricMeters",3:"gasMeters"};return i.map(I=>{if(!("id"in I))throw new Error("区域对象必须包含 id 字段");const A={waterMeters:[],electricMeters:[],gasMeters:[]};return e.filter(t=>{if(!("area_id"in t)||!("type"in t))throw new Error("表计对象必须包含 area_id 和 type 字段");return t.area_id===I.id}).forEach(t=>{const M=_[t.type];M&&A[M].push(t)}),{...I,...A}})}function z(){k.value="添加区域",x.value={id:null,name:"",energy_user_id:null},p.value=!0}function j(i){k.value="编辑区域",x.value={...i},p.value=!0}async function N(i){if(L.areas.some(e=>e.name===i.name&&e.id!==i.id)){C.error("区域名称重复，请重新输入");return}try{i.id?(await _e(i),C.success("更新成功")):(await fe(i),C.success("创建成功")),p.value=!1,n()}catch(e){C.error(`${i.id?"更新":"创建"}失败：${e.message}`)}}async function n(){await L.fetchAreas(),await c()}function s(){p.value=!1,x.value={id:null,name:"",energy_user_id:null}}function P(i){Ee.confirm(`确定要删除区域 "${i.name}" 吗？此操作不可恢复。`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ve(""+i.id),C.success("删除成功"),n()}catch(e){C.error("删除失败："+e.message)}}).catch(()=>{})}async function c(){const i=await ye({company_id:U.currentCompany.id});D.value=q(L.areas,i.data)}return Q(()=>U.currentCompany,async()=>{await c(),await S.fetchEnergyUsers(),await m.fetchPriceRuleList()},{immediate:!0}),(i,e)=>{const _=ee,I=te,A=we,T=Z,t=X,M=H,ae=K,O=he,oe=me,se=de,ie=ce;return d(),g(b,null,[u("div",Ie,[u("div",Ae,[u("div",Me,[e[3]||(e[3]=v(" 区域管理 ")),u("div",Ce,[o(I,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=a=>w.value=a),placeholder:"选择用能户",clearable:"",class:"filter-item",onChange:B},{default:l(()=>[(d(!0),g(b,null,R(h(S).energyUserList,a=>(d(),E(_,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(T,{modelValue:r.value,"onUpdate:modelValue":e[1]||(e[1]=a=>r.value=a),placeholder:"搜索区域名称",clearable:"",class:"filter-item",onInput:B},{prefix:l(()=>[o(A,null,{default:l(()=>[o(h(ue))]),_:1})]),_:1},8,["modelValue"])])]),o(t,{type:"primary",onClick:z},{default:l(()=>e[4]||(e[4]=[v("添加区域")])),_:1})]),o(ie,{style:{flex:"1",overflow:"auto"},gutter:16},{default:l(()=>[(d(!0),g(b,null,R(F.value,a=>(d(),E(se,{span:12,key:a.id},{default:l(()=>[o(oe,{class:"area-card",shadow:"hover"},{header:l(()=>[u("span",Ue,V(a.name+"("+a.id+")"),1),u("div",Se,[o(t,{size:"small",type:"primary",onClick:f=>j(a)},{default:l(()=>e[5]||(e[5]=[v(" 编辑")])),_:2},1032,["onClick"]),o(t,{size:"small",type:"danger",onClick:f=>P(a)},{default:l(()=>e[6]||(e[6]=[v("删除")])),_:2},1032,["onClick"])])]),default:l(()=>[u("div",ke,[u("div",xe,[o(ae,{"label-position":"top",size:"small",class:"area-form"},{default:l(()=>[o(M,{label:"用能户",class:"form-item"},{default:l(()=>[u("span",null,V(h(S).getEnergyUserName(a.energy_user_id)),1)]),_:2},1024),o(M,{label:"用水类型",class:"form-item"},{default:l(()=>[u("span",null,V((a==null?void 0:a.waterMeters.length)>0?h(m).getPriceRuleNameById(a.waterMeters[0].price_rule_id):"暂无"),1)]),_:2},1024),o(M,{label:"用电类型",class:"form-item"},{default:l(()=>[u("span",null,V((a==null?void 0:a.electricMeters.length)>0?h(m).getPriceRuleNameById(a.electricMeters[0].price_rule_id):"暂无"),1)]),_:2},1024),o(M,{label:"用气类型",class:"form-item"},{default:l(()=>[u("span",null,V((a==null?void 0:a.gasMeters.length)>0?h(m).getPriceRuleNameById(a.gasMeters[0].price_rule_id):"暂无"),1)]),_:2},1024)]),_:2},1024)]),u("div",Be,[u("div",Le,[e[7]||(e[7]=u("div",{class:"meter-header"},[u("div",{class:"meter-title"},"水表")],-1)),u("div",De,[(d(!0),g(b,null,R(a.waterMeters,f=>(d(),E(O,{key:f.meter_code,class:"meter-tag"},{default:l(()=>[v(V(f.meter_code),1)]),_:2},1024))),128))])]),u("div",Fe,[e[8]||(e[8]=u("div",{class:"meter-header"},[u("div",{class:"meter-title"},"电表")],-1)),u("div",Ne,[(d(!0),g(b,null,R(a.electricMeters,f=>(d(),E(O,{key:f.meter_code,class:"meter-tag"},{default:l(()=>[v(V(f.meter_code),1)]),_:2},1024))),128))])]),u("div",Te,[e[9]||(e[9]=u("div",{class:"meter-header"},[u("div",{class:"meter-title"},"气表")],-1)),u("div",$e,[(d(!0),g(b,null,R(a.gasMeters,f=>(d(),E(O,{key:f.meter_code,class:"meter-tag"},{default:l(()=>[v(V(f.meter_code),1)]),_:2},1024))),128))])])])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),o(Ve,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=a=>p.value=a),"form-data":x.value,title:k.value,onRefresh:n,onSubmit:N,onClose:s},null,8,["modelValue","form-data","title"])],64)}}};export{Bt as default};
