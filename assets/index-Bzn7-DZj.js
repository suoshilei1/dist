import{_ as ee,r as v,F as j,w as T,W as N,c as d,J as A,l as a,e as s,k as o,f as E,d as S,U as R,V,o as ie,g as U,cC as se}from"./index-DWtISIBF.js";import{E as ue,a as de}from"./col-Dnq3X4bl.js";import{E as ce}from"./card-Cr9tAXzl.js";/* empty css            */import{E as re,a as te}from"./form-item-ijUMtc9_.js";import{E as le}from"./button-DfREtLL_.js";import{E as ae}from"./input-B0bTKLmJ.js";import{E as oe,a as ne}from"./select-DYqyOwb9.js";import"./scrollbar-BMOxp_jN.js";import"./popper-BNb2tGl7.js";import{u as H,a as K,d as X,c as Z}from"./area-CDc72icr.js";import{e as $}from"./meter-BWYCtTLu.js";import{u as z}from"./energyUser-BdZ99M0S.js";import{E as me}from"./dialog-DnmK2X7S.js";import"./overlay-BY0G5ok6.js";import{u as Q,E as _e}from"./divider-CpdfInjN.js";import{b as O}from"./price-BqtQkkR2.js";import{h as W}from"./handleError-BsBqXgSR.js";import{E as x}from"./index-CZh1RU_w.js";/* empty css             *//* empty css                 *//* empty css                   */import{E as pe}from"./index-CuP5NVML.js";import{E as fe}from"./index-0A8HTOTd.js";import{E as ge}from"./index-BTG_XGfc.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DibVzrKz.js";import"./index-CVAPKPs0.js";import"./use-form-item-CuJrx89H.js";import"./castArray-6TPyo715.js";import"./_Uint8Array-DaZSNKBQ.js";import"./_initCloneObject-ChNElRpx.js";import"./index-DjvbDGpK.js";import"./icon-Cc3ZZocH.js";import"./aria-BUADUvnR.js";import"./scroll-DMdoCUCr.js";import"./isEqual-DqXByToB.js";import"./_baseIteratee-FAqII4j1.js";import"./index-DfeXTFmx.js";import"./focus-trap-D8pg8SM_.js";import"./dayjs.min-t3tQ4ZJg.js";import"./index-DxRU3L2W.js";import"./vnode-BIvhTfyw.js";import"./refs-BfLSHSPd.js";/* empty css                        */import"./index-DYLzNb0k.js";import"./validator-CunO4hgy.js";const ye={__name:"AreaFormDialog",props:{modelValue:{type:Boolean,required:!0},title:{type:String,required:!0},formData:{type:Object,required:!0}},emits:["update:modelValue","submit","close","refresh"],setup(q,{expose:r,emit:w}){r();const e=Q(),M=q,b=w,h=z(),_=v(null),n=v({id:null,name:"",energy_user_id:null,waterPriceRuleId:null,electricPriceRuleId:null,gasPriceRuleId:null}),c=v(null),y=v([]),f={name:[{required:!0,message:"请输入区域名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],energy_user_id:[]},C=j({get:()=>M.modelValue,set:i=>b("update:modelValue",i)});T(()=>M.formData,i=>{var P,I,L,u,p,D;n.value={...i,waterPriceRuleId:((I=(P=i.waterMeters)==null?void 0:P[0])==null?void 0:I.price_rule_id)||null,electricPriceRuleId:((u=(L=i.electricMeters)==null?void 0:L[0])==null?void 0:u.price_rule_id)||null,gasPriceRuleId:((D=(p=i.gasMeters)==null?void 0:p[0])==null?void 0:D.price_rule_id)||null},c.value={name:i.name,energy_user_id:i.energy_user_id}},{deep:!0});let g=N();T(()=>g.currentCompany,async()=>{g.currentCompany&&(await h.fetchEnergyUsers({company_id:g.currentCompany.id}),y.value=h.energyUserList)},{immediate:!0});async function t(){const i=[];if(n.value.id&&(n.value.waterPriceRuleId!==null&&i.push(O({id:n.value.waterPriceRuleId,area_id:n.value.id,type:1})),n.value.electricPriceRuleId!==null&&i.push(O({id:n.value.electricPriceRuleId,area_id:n.value.id,type:2})),n.value.gasPriceRuleId!==null&&i.push(O({id:n.value.gasPriceRuleId,area_id:n.value.id,type:3})),i.length>0))try{await Promise.all(i)}catch(P){return W(P,"修改价格规则失败",!0),!1}return!0}function k(){const i={name:n.value.name,energy_user_id:n.value.energy_user_id};return i.name!==c.value.name||i.energy_user_id!==c.value.energy_user_id}async function B(){_.value&&await _.value.validate(async i=>{if(i)try{if(!await t())return;if(k()){const I={id:n.value.id,name:n.value.name,energy_user_id:n.value.energy_user_id,company_id:N().currentCompany.id};b("submit",I)}else b("refresh"),b("close");x.success("保存成功")}catch(P){W(P,"保存失败",!0)}})}function l(){var i;(i=_.value)==null||i.resetFields(),b("close")}const m={priceRuleStore:e,props:M,emit:b,energyUserStore:h,formRef:_,form:n,originalAreaData:c,energyUserList:y,formRules:f,dialogVisible:C,get companyStore(){return g},set companyStore(i){g=i},handlePriceRules:t,isAreaDataChanged:k,handleSubmit:B,handleClose:l,ref:v,watch:T,computed:j,onMounted:ie,get useEnergyUsersStore(){return z},get bindPriceApi(){return O},get usePriceRuleStore(){return Q},get handleError(){return W},get useCompanyStore(){return N},get ElMessage(){return x}};return Object.defineProperty(m,"__isScriptSetup",{enumerable:!1,value:!0}),m}},ve={class:"dialog-footer"};function be(q,r,w,e,M,b){const h=ae,_=re,n=oe,c=ne,y=_e,f=te,C=le,g=me;return d(),A(g,{modelValue:e.dialogVisible,"onUpdate:modelValue":r[5]||(r[5]=t=>e.dialogVisible=t),title:w.title,width:"600px","destroy-on-close":!0,onClose:e.handleClose},{footer:a(()=>[s("span",ve,[o(C,{onClick:e.handleClose},{default:a(()=>r[7]||(r[7]=[E("取消")])),_:1}),o(C,{type:"primary",onClick:e.handleSubmit},{default:a(()=>r[8]||(r[8]=[E("确定")])),_:1})])]),default:a(()=>[o(f,{ref:"formRef",model:e.form,rules:e.formRules,"label-width":"100px"},{default:a(()=>[o(_,{label:"区域名称",prop:"name"},{default:a(()=>[o(h,{modelValue:e.form.name,"onUpdate:modelValue":r[0]||(r[0]=t=>e.form.name=t),placeholder:"请输入区域名称"},null,8,["modelValue"])]),_:1}),o(_,{label:"用能户",prop:"energy_user_id"},{default:a(()=>[o(c,{modelValue:e.form.energy_user_id,"onUpdate:modelValue":r[1]||(r[1]=t=>e.form.energy_user_id=t),placeholder:"请选择用能户",clearable:""},{default:a(()=>[(d(!0),S(R,null,V(e.energyUserList,t=>(d(),A(n,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(y,null,{default:a(()=>r[6]||(r[6]=[E("价格规则设置")])),_:1}),o(_,{label:"用水类别",prop:"waterPriceRuleId"},{default:a(()=>[o(c,{modelValue:e.form.waterPriceRuleId,"onUpdate:modelValue":r[2]||(r[2]=t=>e.form.waterPriceRuleId=t),clearable:""},{default:a(()=>[(d(!0),S(R,null,V(e.priceRuleStore.waterPriceRuleList,t=>(d(),A(n,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(_,{label:"用电类别",prop:"electricPriceRuleId"},{default:a(()=>[o(c,{modelValue:e.form.electricPriceRuleId,"onUpdate:modelValue":r[3]||(r[3]=t=>e.form.electricPriceRuleId=t),clearable:""},{default:a(()=>[(d(!0),S(R,null,V(e.priceRuleStore.electricityPriceRuleList,t=>(d(),A(n,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(_,{label:"用气类别",prop:"gasPriceRuleId"},{default:a(()=>[o(c,{modelValue:e.form.gasPriceRuleId,"onUpdate:modelValue":r[4]||(r[4]=t=>e.form.gasPriceRuleId=t),clearable:""},{default:a(()=>[(d(!0),S(R,null,V(e.priceRuleStore.gasPriceRuleList,t=>(d(),A(n,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}const he=ee(ye,[["render",be],["__scopeId","data-v-a230b1f4"],["__file","D:/临时存放/green-carbon-1.0/src/views/SystemManagement/BlockManagement/areaManagement/components/AreaFormDialog.vue"]]),Ee={__name:"index",setup(q,{expose:r}){r();const w=H(),e=N(),M=z(),b=Q(),h=v([]),_=v(null),n=v(""),c=v(!1),y=v(""),f=v({id:null,name:"",energy_user_id:null}),C=j(()=>h.value.filter(u=>{const p=!_.value||u.energy_user_id===_.value,D=!n.value||u.name.toLowerCase().includes(n.value.toLowerCase());return p&&D}));function g(){}function t(u,p){if(!Array.isArray(u)||!Array.isArray(p))throw new Error("areas 和 meters 参数必须是数组");const D={1:"waterMeters",2:"electricMeters",3:"gasMeters"};return u.map(J=>{if(!("id"in J))throw new Error("区域对象必须包含 id 字段");const Y={waterMeters:[],electricMeters:[],gasMeters:[]};return p.filter(F=>{if(!("area_id"in F)||!("type"in F))throw new Error("表计对象必须包含 area_id 和 type 字段");return F.area_id===J.id}).forEach(F=>{const G=D[F.type];G&&Y[G].push(F)}),{...J,...Y}})}function k(){y.value="添加区域",f.value={id:null,name:"",energy_user_id:null},c.value=!0}function B(u){y.value="编辑区域",f.value={...u},c.value=!0}async function l(u){if(w.areas.some(p=>p.name===u.name&&p.id!==u.id)){x.error("区域名称重复，请重新输入");return}try{u.id?(await K(u),x.success("更新成功")):(await Z(u),x.success("创建成功")),c.value=!1,m()}catch(p){x.error(`${u.id?"更新":"创建"}失败：${p.message}`)}}async function m(){await w.fetchAreas(),await I()}function i(){c.value=!1,f.value={id:null,name:"",energy_user_id:null}}function P(u){ge.confirm(`确定要删除区域 "${u.name}" 吗？此操作不可恢复。`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await X(""+u.id),x.success("删除成功"),m()}catch(p){x.error("删除失败："+p.message)}}).catch(()=>{})}async function I(){const u=await $({company_id:e.currentCompany.id});h.value=t(w.areas,u.data)}T(()=>e.currentCompany,async()=>{await I(),await M.fetchEnergyUsers(),await b.fetchPriceRuleList()},{immediate:!0});const L={areaStore:w,companyStore:e,energyUserStore:M,priceRuleStore:b,processedAreas:h,selectedEnergyUser:_,searchQuery:n,dialogVisible:c,dialogTitle:y,formData:f,filteredAreas:C,handleFilter:g,mapMetersToAreas:t,handleAddArea:k,handleEditArea:B,handleFormSubmit:l,refreshData:m,handleFormClose:i,handleDeleteArea:P,processAreasData:I,ref:v,watch:T,computed:j,get Search(){return se},get useAreaStore(){return H},get useCompanyStore(){return N},get getMeterInfoApi(){return $},get useEnergyUsersStore(){return z},get updateAreaApi(){return K},get deleteAreaApi(){return X},get createAreaApi(){return Z},AreaFormDialog:he,get usePriceRuleStore(){return Q}};return Object.defineProperty(L,"__isScriptSetup",{enumerable:!1,value:!0}),L}},Se={class:"area-management"},Re={class:"page-header"},Ae={class:"page-title",style:{display:"flex","align-items":"center",gap:"16px"}},we={class:"filter-section"},Pe={class:"area-name"},Ve={class:"area-actions"},Me={class:"card-content"},Ce={class:"info-section"},Ie={class:"meters-section"},Ue={class:"meter-box"},xe={class:"meter-tags"},ke={class:"meter-box"},De={class:"meter-tags"},Fe={class:"meter-box"},Be={class:"meter-tags"};function Le(q,r,w,e,M,b){const h=oe,_=ne,n=pe,c=ae,y=le,f=re,C=te,g=fe,t=ce,k=ue,B=de;return d(),S(R,null,[s("div",Se,[s("div",Re,[s("div",Ae,[r[3]||(r[3]=E(" 区域管理 ")),s("div",we,[o(_,{modelValue:e.selectedEnergyUser,"onUpdate:modelValue":r[0]||(r[0]=l=>e.selectedEnergyUser=l),placeholder:"选择用能户",clearable:"",class:"filter-item",onChange:e.handleFilter},{default:a(()=>[(d(!0),S(R,null,V(e.energyUserStore.energyUserList,l=>(d(),A(h,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(c,{modelValue:e.searchQuery,"onUpdate:modelValue":r[1]||(r[1]=l=>e.searchQuery=l),placeholder:"搜索区域名称",clearable:"",class:"filter-item",onInput:e.handleFilter},{prefix:a(()=>[o(n,null,{default:a(()=>[o(e.Search)]),_:1})]),_:1},8,["modelValue"])])]),o(y,{type:"primary",onClick:e.handleAddArea},{default:a(()=>r[4]||(r[4]=[E("添加区域")])),_:1})]),o(B,{style:{flex:"1",overflow:"auto"},gutter:16},{default:a(()=>[(d(!0),S(R,null,V(e.filteredAreas,l=>(d(),A(k,{span:12,key:l.id},{default:a(()=>[o(t,{class:"area-card",shadow:"hover"},{header:a(()=>[s("span",Pe,U(l.name+"("+l.id+")"),1),s("div",Ve,[o(y,{size:"small",type:"primary",onClick:m=>e.handleEditArea(l)},{default:a(()=>[...r[5]||(r[5]=[E(" 编辑")])]),_:2},1032,["onClick"]),o(y,{size:"small",type:"danger",onClick:m=>e.handleDeleteArea(l)},{default:a(()=>[...r[6]||(r[6]=[E("删除")])]),_:2},1032,["onClick"])])]),default:a(()=>[s("div",Me,[s("div",Ce,[o(C,{"label-position":"top",size:"small",class:"area-form"},{default:a(()=>[o(f,{label:"用能户",class:"form-item"},{default:a(()=>[s("span",null,U(e.energyUserStore.getEnergyUserName(l.energy_user_id)),1)]),_:2},1024),o(f,{label:"用水类型",class:"form-item"},{default:a(()=>[s("span",null,U((l==null?void 0:l.waterMeters.length)>0?e.priceRuleStore.getPriceRuleNameById(l.waterMeters[0].price_rule_id):"暂无"),1)]),_:2},1024),o(f,{label:"用电类型",class:"form-item"},{default:a(()=>[s("span",null,U((l==null?void 0:l.electricMeters.length)>0?e.priceRuleStore.getPriceRuleNameById(l.electricMeters[0].price_rule_id):"暂无"),1)]),_:2},1024),o(f,{label:"用气类型",class:"form-item"},{default:a(()=>[s("span",null,U((l==null?void 0:l.gasMeters.length)>0?e.priceRuleStore.getPriceRuleNameById(l.gasMeters[0].price_rule_id):"暂无"),1)]),_:2},1024)]),_:2},1024)]),s("div",Ie,[s("div",Ue,[r[7]||(r[7]=s("div",{class:"meter-header"},[s("div",{class:"meter-title"},"水表")],-1)),s("div",xe,[(d(!0),S(R,null,V(l.waterMeters,m=>(d(),A(g,{key:m.meter_code,class:"meter-tag"},{default:a(()=>[E(U(m.meter_code),1)]),_:2},1024))),128))])]),s("div",ke,[r[8]||(r[8]=s("div",{class:"meter-header"},[s("div",{class:"meter-title"},"电表")],-1)),s("div",De,[(d(!0),S(R,null,V(l.electricMeters,m=>(d(),A(g,{key:m.meter_code,class:"meter-tag"},{default:a(()=>[E(U(m.meter_code),1)]),_:2},1024))),128))])]),s("div",Fe,[r[9]||(r[9]=s("div",{class:"meter-header"},[s("div",{class:"meter-title"},"气表")],-1)),s("div",Be,[(d(!0),S(R,null,V(l.gasMeters,m=>(d(),A(g,{key:m.meter_code,class:"meter-tag"},{default:a(()=>[E(U(m.meter_code),1)]),_:2},1024))),128))])])])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),o(e.AreaFormDialog,{modelValue:e.dialogVisible,"onUpdate:modelValue":r[2]||(r[2]=l=>e.dialogVisible=l),"form-data":e.formData,title:e.dialogTitle,onRefresh:e.refreshData,onSubmit:e.handleFormSubmit,onClose:e.handleFormClose},null,8,["modelValue","form-data","title"])],64)}const xr=ee(Ee,[["render",Le],["__file","D:/临时存放/green-carbon-1.0/src/views/SystemManagement/BlockManagement/areaManagement/index.vue"]]);export{xr as default};
