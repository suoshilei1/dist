import{_ as q,r as _,F as N,a as G,w as B,o as H,m as R,c as E,d as M,e as A,i as n,j as m,f as g,Y as K,J as T,g as F,I as c,U as Q,V as X,W as Z,v as I}from"./index-Bx6Y8L80.js";import{E as ee}from"./button-8bviUT_H.js";import{E as te}from"./checkbox-LjaCbo-5.js";import{_ as oe}from"./导出-BMYnDY6G.js";import{d as V}from"./dayjs.min-Cd48fqZ9.js";import{u as ae,c as b,a as re,f as O,b as le,d as se,t as ie}from"./meter-5sbrBbgq.js";import{C as ne}from"./CustomDatePicker-CX6MdPmZ.js";import{u as ue}from"./area-COPnz-hV.js";import{h as ce,r as me,c as de,a as fe,f as pe}from"./tableStyleConfig-B0fO-oaJ.js";import{h as k}from"./handleError-DD4JYoq7.js";import{g as _e,a as ve}from"./formula-ClsumsYI.js";import"./index-A4BGBRGh.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-AkNVqhGZ.js";import"./use-form-item-50hJ8Ppj.js";import"./icon-6zrsquxY.js";import"./index-CuyxIfpa.js";import"./isEqual-BM-Gj-iT.js";import"./_Uint8Array-B6mJ0Xm4.js";import"./date-picker-CfUXe-Kp.js";import"./popper-DBn8ulUn.js";import"./aria-BUADUvnR.js";import"./focus-trap-Ddg061Nm.js";import"./input-CFaQgGx5.js";import"./index-iw6eP590.js";import"./scrollbar-DuXO1tWo.js";import"./index-DLcTS03G.js";import"./index-zrRcpBp4.js";/* empty css             *//* empty css                 */import"./index-KJp6TXG9.js";/* empty css                        */import"./index-CWCMyxJA.js";import"./formula-SHWkc_ME.js";const he={class:"meter-report-container"},ge={class:"meter-report-header"},we={__name:"index",setup(ye){const d=ae(),P=ue(),D=_(null),f=_([V().startOf("year").valueOf(),V().endOf("year").valueOf()]),U={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"水表月统计报表",sheetName:"表计报表",modes:["current"]},w=_([]),W=N(()=>{const t={},e={};let i=0,s=0;p.value.forEach((l,r)=>{t[`usage_${r}`]=0,e[`usage_${r}`]=0}),w.value.forEach(l=>{!l.parent_id&&!l.meter_code.includes("不明水率")&&(p.value.forEach((r,a)=>{t[`usage_${a}`]+=Number(l[`usage_${a}`]||0)}),i+=Number(l.sum||0)),l.children&&l.children.forEach(r=>{r.meter_code.includes("不明水率")||(p.value.forEach((a,u)=>{e[`usage_${u}`]+=Number(r[`usage_${u}`]||0)}),s+=Number(r.sum||0))})});const o={};p.value.forEach((l,r)=>{const a=t[`usage_${r}`],u=e[`usage_${r}`];o[`usage_${r}`]=b(a,u)});let v=[{meter_code:"一级表合计",...t,sum:i.toFixed(2)},{meter_code:"二级表合计",...e,sum:s.toFixed(2)},{meter_code:"一级表不明率",...o,sum:b(i,s)}];return C.value.forEach(l=>{v.push({meter_code:l.name,...l,sum:0})}),v}),y=_(!1),$=_(!1),j=G({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:t})=>z(t)}),p=N(()=>re(f.value[0],f.value[1],"month"));let C=_([]);async function S(){if(!y.value)try{w.value=[],y.value=!0;const t=d.treeDataForChart.map(o=>L(o));let e=Z().currentCompany.id;C.value=await _e(e,"用水月报表"),C.value=await ve(C.value,p.value,"month");const i=await Promise.all(t);w.value=i.filter(Boolean);const s=D.value;for(let o=0;o<2;o++)await(s==null?void 0:s.setAllTreeExpand(!0))}catch(t){k(t,"获取水表数据失败")}finally{y.value=!1}}async function L(t){try{const e=await se({id:t.id,start_time:f.value[0],end_time:V(f.value[1]).valueOf(),interval:"month"});return ie(t,e)}catch(e){return k(e,"获取水表数据失败"),null}}const x=_(!1);async function z(t){try{const e=t.customChildren.map(o=>L(o)),s=(await Promise.all(e)).filter(Boolean);return x.value&&s.push(await J(t,s)),s}catch(e){return k(e,"获取水表数据失败"),[]}}async function J(t,e){const i={};return p.value.forEach((s,o)=>{const v=t[`usage_${o}`]||0,l=e.reduce((r,a)=>a.meter_code.includes("不明水率")?r:r+(Number(a[`usage_${o}`])||0),0);i[`usage_${o}`]=b(v,l)}),{meter_code:t.meter_code+"不明水率",...i,sum:0}}async function Y(){try{$.value=!0;const t=D.value;for(let e=0;e<d.meterLevels.length;e++)await(t==null?void 0:t.setAllTreeExpand(!0));await(t==null?void 0:t.openExport({includeFooter:!0}))}finally{$.value=!1}}return B([()=>f.value,()=>d.treeDataForChart],()=>{S()},{deep:!0}),B([()=>x.value],()=>{S()},{deep:!0}),H(async()=>{(!d.treeDataForChart.length||d.currentSelectedType!==1)&&(d.setCurrentSelectedType(1),await d.fetchMeterList()),S()}),(t,e)=>{const i=te,s=ee,o=R("vxe-column"),v=R("vxe-colgroup"),l=R("vxe-table"),r=I;return E(),M("div",he,[A("div",ge,[n(ne,{maxDays:365*2,border:"","is-month-picker":!0,round:"",modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=a=>f.value=a)},null,8,["modelValue"]),n(i,{modelValue:x.value,"onUpdate:modelValue":e[1]||(e[1]=a=>x.value=a),label:"显示子表的不明水率"},null,8,["modelValue"]),n(s,{style:{"margin-left":"auto"},type:"success",loading:$.value,onClick:Y},{icon:m(()=>e[2]||(e[2]=[A("img",{src:oe,width:"14",height:"14",alt:"",srcset:""},null,-1)])),default:m(()=>[e[3]||(e[3]=g(" 导出 "))]),_:1},8,["loading"])]),K((E(),T(l,{"show-overflow":"","header-row-style":c(ce),"row-style":c(me),"cell-style":c(de),"footer-row-style":c(fe),"footer-cell-style":c(pe),"show-footer":"",height:"92%",ref_key:"tableRef",ref:D,border:"",align:"center",data:w.value,"tree-config":j,"footer-data":W.value,"export-config":U},{default:m(()=>[n(o,{fixed:"left","tree-node":"",field:"meter_code",title:"表计编号",width:"200"}),n(o,{fixed:"left",width:"100","show-overflow":"tooltip",title:"所供区域"},{default:m(({row:a})=>[g(F(c(P).getAreaNameById(a.area_id)||"-"),1)]),_:1}),n(o,{width:"120","show-overflow":"tooltip",field:"installation_location",title:"安装位置"}),n(o,{field:"specification",width:"100",title:"规格"}),n(o,{width:"100",field:"startReading",title:"启读数"}),(E(!0),M(Q,null,X(p.value,(a,u)=>(E(),T(v,{key:a,title:a},{default:m(()=>[n(o,{width:"100",field:`usage_${u}`,title:"流量"},{default:m(({row:h})=>[g(F(c(O)(h[`usage_${u}`])),1)]),footer:m(({row:h})=>[g(F(c(O)(h[`usage_${u}`])),1)]),_:2},1032,["field"]),n(o,{width:"100",field:`reading_${u}`,title:"读数"},{default:m(({row:h})=>[g(F(c(le)(h[`reading_${u}`])),1)]),_:2},1032,["field"])]),_:2},1032,["title"]))),128)),n(o,{fixed:"right",field:"sum",width:"100",title:"总流量"})]),_:1},8,["header-row-style","row-style","cell-style","footer-row-style","footer-cell-style","data","tree-config","footer-data"])),[[r,y.value]])])}}},tt=q(we,[["__scopeId","data-v-79a28e06"]]);export{tt as default};
