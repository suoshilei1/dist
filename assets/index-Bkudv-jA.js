import{z as be,cx as ke,D as le,aR as we,E as Ee,r as v,F as H,c as d,J as V,j as a,X as te,e as u,N as I,I as m,K as Ce,h as Y,d as C,M as Z,f as _,g as $,T as z,i as t,a1 as Te,bl as Ve,O as Fe,_ as ae,ad as Se,V as oe,w as se,o as re,U as Q,q as $e,v as he}from"./index-oALI6hjD.js";import{u as xe,s as De,E as ne}from"./constants-Be6xblX4.js";import"./overlay-WqKCga-H.js";import{E as ue,a as ie}from"./form-item-JkdAUXjO.js";import{E as Me}from"./date-picker-DSsGajNu.js";import{E as Ie}from"./input-_j8YarB1.js";import"./scrollbar-BwLVa3O8.js";import"./popper-8tqvLSZz.js";import{E as me}from"./button-CW4VZptJ.js";import{E as de,a as ce}from"./table-column-B3vmHtxt.js";import"./checkbox-eAiA7KBF.js";/* empty css                *//* empty css            */import{E as Ae,a as Ue}from"./select-B0JZ5Vmm.js";import{g as pe,a as Be,e as Ne,c as Oe,d as Le}from"./formula-C00PoDkf.js";import{e as Ye}from"./meter-GWsXRyue.js";/* empty css             *//* empty css                 *//* empty css                        */import{E as g}from"./index-CV7ElbEQ.js";import{E as fe}from"./index-BFWR71cx.js";import{d as q}from"./dayjs.min-VPOC9PSa.js";/* empty css                   */import{E as ze}from"./index-DKbZ_y2J.js";import{E as ee}from"./index-DXOgsKzf.js";import{a as ve,T as Re}from"./icon-DFUaFmZd.js";import{_ as Pe}from"./plugin-vue_export-helper-CqGSI99y.js";import"./index-JdeAZNwx.js";import"./index-Ci2yyUHC.js";import"./scroll-BUhzRsoy.js";import"./vnode-DAFY4x8G.js";import"./index-GdZBC0LW.js";import"./focus-trap-B9jhWFgs.js";import"./aria-BUADUvnR.js";import"./use-form-item-CJ5jT23N.js";import"./castArray-DuUCQlE9.js";import"./_Uint8Array-Cyhry7Ym.js";import"./_initCloneObject-CeA08_Bb.js";import"./index-Civq4TP6.js";import"./index-CPa7yTdP.js";import"./index-BTnVmvBQ.js";import"./isEqual-DERyOhzh.js";import"./_baseIteratee-_-ChXyeP.js";import"./index-ClN0XSgQ.js";import"./validator-DaZaXEYL.js";const qe=["light","dark"],He=be({title:{type:String,default:""},description:{type:String,default:""},type:{type:String,values:ke(ve),default:"info"},closable:{type:Boolean,default:!0},closeText:{type:String,default:""},showIcon:Boolean,center:Boolean,effect:{type:String,values:qe,default:"light"}}),je={close:B=>B instanceof MouseEvent},Je=le({name:"ElAlert"}),Ke=le({...Je,props:He,emits:je,setup(B,{emit:h}){const x=B,{Close:T}=Re,w=we(),s=Ee("alert"),b=v(!0),y=H(()=>ve[x.type]),c=H(()=>[s.e("icon"),{[s.is("big")]:!!x.description||!!w.default}]),F=H(()=>({"with-description":x.description||w.default})),r=n=>{b.value=!1,h("close",n)};return(n,A)=>(d(),V(Ve,{name:m(s).b("fade"),persisted:""},{default:a(()=>[te(u("div",{class:I([m(s).b(),m(s).m(n.type),m(s).is("center",n.center),m(s).is(n.effect)]),role:"alert"},[n.showIcon&&m(y)?(d(),V(m(ee),{key:0,class:I(m(c))},{default:a(()=>[(d(),V(Ce(m(y))))]),_:1},8,["class"])):Y("v-if",!0),u("div",{class:I(m(s).e("content"))},[n.title||n.$slots.title?(d(),C("span",{key:0,class:I([m(s).e("title"),m(F)])},[Z(n.$slots,"title",{},()=>[_($(n.title),1)])],2)):Y("v-if",!0),n.$slots.default||n.description?(d(),C("p",{key:1,class:I(m(s).e("description"))},[Z(n.$slots,"default",{},()=>[_($(n.description),1)])],2)):Y("v-if",!0),n.closable?(d(),C(z,{key:2},[n.closeText?(d(),C("div",{key:0,class:I([m(s).e("close-btn"),m(s).is("customed")]),onClick:r},$(n.closeText),3)):(d(),V(m(ee),{key:1,class:I(m(s).e("close-btn")),onClick:r},{default:a(()=>[t(m(T))]),_:1},8,["class"]))],64)):Y("v-if",!0)],2)],2),[[Te,b.value]])]),_:3},8,["name"]))}});var We=Pe(Ke,[["__file","alert.vue"]]);const Xe=Fe(We),Ge={class:"formula-help"},Qe={class:"symbol-table-container"},Ze={key:0,class:"symbol-cell"},el={key:1,class:"symbol-cell"},ll={__name:"setFormula",props:{formulaOptions:{type:Array,default:()=>[]}},emits:["update-formula"],setup(B,{expose:h,emit:x}){const T=x,w=v(null),s=v(null),b=v(!1),y=v(!1),{currentCompany:c}=Se(oe()),F={name:[{required:!0,message:"请输入公式名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符之间",trigger:"blur"}],formula:[{required:!0,message:"请输入公式内容",trigger:"blur"}],usage:[{required:!0,message:"请选择使用标识",trigger:"change"}]},r=v({company_id:c.value.id,name:"",formula:"",usage:"",id:null}),n=v([]),A=async()=>{try{y.value=!0;const e=await pe(c.value.id);e.code===200?n.value=e.data||[]:g.error("获取公式列表失败")}catch(e){console.error("加载公式列表出错:",e),g.error("加载公式列表时发生错误")}finally{y.value=!1}},N=e=>{b.value=!0,e?(r.value={company_id:c.value.id,name:e.name||"",formula:e.formula||"",usage:e.usage||"",id:e.id?Number(e.id):null},s.value=e.id?Number(e.id):null):O()},O=()=>{w.value&&w.value.resetFields(),r.value={company_id:c.value.id,name:"",formula:"",usage:"",id:null},s.value=null},j=async()=>{try{y.value=!0;const{id:e,...o}=r.value,f=await Be({...o});f.code===200?(g.success("添加成功"),await A(),b.value=!1,T("update-formula")):g.error(f.message||"添加失败")}catch(e){console.error("添加公式出错:",e),g.error("添加公式时发生错误")}finally{y.value=!1}},J=async()=>{try{y.value=!0;const e=await Ne({...r.value});e.code===200?(g.success("修改成功"),await A(),b.value=!1,T("update-formula")):g.error(e.message||"修改失败")}catch(e){console.error("编辑公式出错:",e),g.error("编辑公式时发生错误")}finally{y.value=!1}},p=async()=>{w.value&&w.value.validate(async e=>{e&&(s.value?await J():await j(),O())})};se(()=>c.value,async e=>{e!=null&&e.id&&await A()},{immediate:!0});const l=()=>{b.value=!1,O()},k=e=>{r.value.formula=e},S=e=>{r.value.formula+=e};h({open:N});const L=v(null),U=v([]);function R(e){r.value.formula+=e.replace("x",L.value)}async function K(){try{return(await Ye({company_id:$e().userCompany.id})).data}catch(e){console.error("获取表计列表失败:",e),fe({title:"错误",message:"获取表计列表失败",type:"error"})}}re(async()=>{U.value=await K()});const W=H(()=>{const e=r.value.usage;if(!e)return U.value;let o=0;return e.includes("水")&&(o=1),e.includes("电")&&(o=2),e.includes("气")&&(o=3),U.value.filter(f=>f.type===o)});return(e,o)=>{const f=Ie,E=ue,D=Ae,X=Ue,P=me,G=de,ye=ce,_e=ie,ge=ne;return d(),V(ge,{modelValue:b.value,"onUpdate:modelValue":o[4]||(o[4]=i=>b.value=i),title:s.value?"编辑公式":"新增公式",size:"50%","before-close":l},{default:a(()=>[t(_e,{ref_key:"formRef",ref:w,model:r.value,rules:F,"label-width":"100px","label-position":"top",class:"custom-form"},{default:a(()=>[t(E,{label:"公式名称",prop:"name"},{default:a(()=>[t(f,{modelValue:r.value.name,"onUpdate:modelValue":o[0]||(o[0]=i=>r.value.name=i),placeholder:"请输入公式名称",clearable:"",maxlength:50,"show-word-limit":""},null,8,["modelValue"])]),_:1}),t(E,{label:"根据选择已有公式快速添加"},{default:a(()=>[t(X,{placeholder:"选择已有公式",onChange:k,clearable:"",class:"w-full"},{default:a(()=>[(d(!0),C(z,null,Q(n.value,i=>(d(),V(D,{key:i.id,label:i.name,value:i.formula},null,8,["label","value"]))),128))]),_:1})]),_:1}),t(E,{label:"使用标识",prop:"usage"},{default:a(()=>[t(X,{modelValue:r.value.usage,"onUpdate:modelValue":o[1]||(o[1]=i=>r.value.usage=i),placeholder:"请选择使用标识",clearable:""},{default:a(()=>[(d(!0),C(z,null,Q(m(xe),i=>(d(),V(D,{key:i.value,label:i.label,value:i.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(E,{label:"公式内容",prop:"formula"},{default:a(()=>[t(f,{modelValue:r.value.formula,"onUpdate:modelValue":o[2]||(o[2]=i=>r.value.formula=i),type:"textarea",rows:4,placeholder:"请输入公式内容",clearable:""},null,8,["modelValue"]),u("div",Ge,[o[7]||(o[7]=u("div",{class:"help-header"},[u("span",{class:"text-gray-600"},"支持基础运算符(+,-,*,/,%,^)及常见数学函数")],-1)),u("div",Qe,[t(ye,{data:m(De),border:"",stripe:"",size:"small",style:{width:"100%"},height:"400"},{default:a(()=>[t(G,{prop:"symbol",label:"符号",align:"center"},{default:a(i=>[i.row.symbol!=="meter(x,START,END)"?(d(),C("div",Ze,[u("span",null,$(i.row.symbol),1),t(P,{type:"primary",link:"",onClick:M=>S(i.row.symbol)},{default:a(()=>o[5]||(o[5]=[_("插入")])),_:2},1032,["onClick"])])):(d(),C("div",el,[u("span",null,[t(X,{style:{width:"8rem"},modelValue:L.value,"onUpdate:modelValue":o[3]||(o[3]=M=>L.value=M),placeholder:"选择表计"},{default:a(()=>[(d(!0),C(z,null,Q(W.value,M=>(d(),V(D,{key:M.id,label:M.meter_code,value:M.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t(P,{type:"primary",link:"",onClick:M=>R(i.row.symbol)},{default:a(()=>o[6]||(o[6]=[_("插入")])),_:2},1032,["onClick"])]))]),_:1}),t(G,{prop:"explanation",label:"解释",align:"left"}),t(G,{prop:"example",label:"使用案例",align:"left"})]),_:1},8,["data"])])])]),_:1}),t(E,null,{default:a(()=>[t(P,{type:"primary",onClick:p,loading:y.value},{default:a(()=>[_($(s.value?"保存":"确定"),1)]),_:1},8,["loading"]),t(P,{onClick:l},{default:a(()=>o[8]||(o[8]=[_("取消")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}},tl=ae(ll,[["__scopeId","data-v-d39907d0"]]),al={class:"page-title",style:{display:"flex","justify-content":"space-between","align-items":"center"}},ol={class:"formula-management"},sl={class:"test-formula-container"},rl={class:"formula-info"},nl={class:"test-parameters"},ul={key:0,class:"test-result"},il={class:"dialog-footer"},ml={__name:"index",setup(B){const h=oe(),x=h.currentCompany.id,T=v([]),w=v(!1),s=async(p=x)=>{w.value=!0;try{const l=await pe(p);T.value=l.data}catch(l){console.error("Error getting formula:",l),fe({title:"错误",type:"error",message:"获取公式失败，请稍后再试"})}finally{w.value=!1}};se(()=>h.currentCompany,()=>{let p=h.currentCompany.id;s(p)});const b=v(!1),y=v(null),c=v({startTime:q().subtract(1,"day").valueOf(),endTime:q().valueOf()}),F=v(null),r=v(!1),n=p=>{y.value=p,b.value=!0,F.value=null,c.value={startTime:q().subtract(1,"day").valueOf(),endTime:q().valueOf()}},A=async()=>{if(!c.value.startTime||!c.value.endTime){g.warning("请选择开始和结束时间");return}r.value=!0;try{const p={id:y.value.id,start_time:new Date(c.value.startTime).getTime(),end_time:new Date(c.value.endTime).getTime()},l=await Oe(p);l.code===200?(F.value=l.data,g.success("计算成功")):g.error(l.message||"计算失败")}catch(p){console.error("Error computing formula:",p),g.error("计算失败，请稍后再试")}finally{r.value=!1}};re(()=>{s()});const N=v(),O=()=>{N.value.open()},j=p=>{N.value.open(p)},J=async p=>{const l={id:String(p.id)};try{await ze.confirm("此操作将永久删除该公式, 是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const k=await Le(l);k.code===200?(T.value=T.value.filter(S=>S.id!==p.id),g({message:"删除成功",type:"success"})):g({message:`删除失败: ${k.message||"未知错误"}`,type:"error"})}catch(k){k!=="cancel"?(console.error("Error deleting formula:",k),g({message:"删除失败，请稍后再试",type:"error"})):console.log("用户取消删除操作")}};return(p,l)=>{const k=me,S=de,L=ce,U=Me,R=ue,K=ie,W=Xe,e=ne,o=he;return d(),C(z,null,[u("div",al,[l[5]||(l[5]=_(" 公式管理 ")),t(k,{style:{"margin-left":"16px"},type:"primary",icon:"plus",onClick:O},{default:a(()=>l[4]||(l[4]=[_("添加公式")])),_:1})]),u("div",ol,[te((d(),V(L,{data:T.value,border:"",stripe:"",class:"custom-table"},{default:a(()=>[t(S,{prop:"name",label:"公式名称",align:"center",width:"200"}),t(S,{prop:"usage",label:"使用标识",align:"center",width:"200"}),t(S,{prop:"formula",label:"公式内容",align:"center"}),t(S,{label:"操作",align:"center",width:"280"},{default:a(f=>[t(k,{onClick:E=>j(f.row),type:"primary",size:"small",class:"action-button"},{default:a(()=>l[6]||(l[6]=[_(" 编辑 ")])),_:2},1032,["onClick"]),t(k,{onClick:E=>n(f.row),type:"success",size:"small",class:"action-button"},{default:a(()=>l[7]||(l[7]=[_(" 测试 ")])),_:2},1032,["onClick"]),t(k,{onClick:E=>J(f.row),type:"danger",size:"small",class:"action-button"},{default:a(()=>l[8]||(l[8]=[_(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[o,w.value]]),t(tl,{ref_key:"formulaAdd",ref:N,onUpdateFormula:s},null,512),t(e,{modelValue:b.value,"onUpdate:modelValue":l[3]||(l[3]=f=>b.value=f),title:"测试公式"},{footer:a(()=>[u("span",il,[t(k,{onClick:l[2]||(l[2]=f=>b.value=!1)},{default:a(()=>l[14]||(l[14]=[_("取 消")])),_:1}),t(k,{type:"primary",onClick:A,loading:r.value},{default:a(()=>[_($(r.value?"计算中...":"计算"),1)]),_:1},8,["loading"])])]),default:a(()=>{var f,E;return[u("div",sl,[u("div",rl,[l[11]||(l[11]=u("h3",null,"公式信息",-1)),u("p",null,[l[9]||(l[9]=u("strong",null,"公式名称：",-1)),_($((f=y.value)==null?void 0:f.name),1)]),u("p",null,[l[10]||(l[10]=u("strong",null,"公式内容：",-1)),_($((E=y.value)==null?void 0:E.formula),1)])]),u("div",nl,[l[12]||(l[12]=u("h3",null,"测试参数",-1)),t(K,{model:c.value,"label-width":"120px"},{default:a(()=>[t(R,{label:"开始时间"},{default:a(()=>[t(U,{modelValue:c.value.startTime,"onUpdate:modelValue":l[0]||(l[0]=D=>c.value.startTime=D),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),t(R,{label:"结束时间"},{default:a(()=>[t(U,{modelValue:c.value.endTime,"onUpdate:modelValue":l[1]||(l[1]=D=>c.value.endTime=D),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),F.value!=null?(d(),C("div",ul,[l[13]||(l[13]=u("h3",null,"计算结果",-1)),t(W,{title:`计算结果: ${F.value}`,type:"success",closable:!1,"show-icon":""},null,8,["title"])])):Y("",!0)])]}),_:1},8,["modelValue"])])],64)}}},tt=ae(ml,[["__scopeId","data-v-82198207"]]);export{tt as default};
