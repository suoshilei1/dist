import{_ as re,r as p,F as B,a as j,w as P,o as z,j as T,c as E,d as J,e as Y,k as u,l as h,f as S,Y as oe,J as q,g as F,U as ae,V as le,W as G,v as ne}from"./index-DWtISIBF.js";import{E as se}from"./button-DfREtLL_.js";import{E as ie}from"./checkbox-BzIrpOFw.js";import{d as b}from"./dayjs.min-t3tQ4ZJg.js";import{u as H,c as V,a as K,b as Q,t as X,f as ue,d as ce}from"./meter-BWYCtTLu.js";import{C as me}from"./CustomDatePicker-DTvPnXeh.js";import{u as Z}from"./area-CDc72icr.js";import{f as de,a as fe,r as ge,c as _e,h as pe}from"./tableStyleConfig-B0fO-oaJ.js";import{h as L}from"./handleError-BsBqXgSR.js";import{g as I,a as $}from"./formula-BoDYiet4.js";import{_ as he}from"./导出-BMYnDY6G.js";import"./index-CuP5NVML.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DjvbDGpK.js";import"./use-form-item-CuJrx89H.js";import"./icon-Cc3ZZocH.js";import"./index-CVAPKPs0.js";import"./isEqual-DqXByToB.js";import"./_Uint8Array-DaZSNKBQ.js";import"./date-picker-B_H4_mfX.js";import"./popper-BNb2tGl7.js";import"./aria-BUADUvnR.js";import"./focus-trap-D8pg8SM_.js";import"./input-B0bTKLmJ.js";import"./index-DibVzrKz.js";import"./scrollbar-BMOxp_jN.js";import"./index-CeeR5a7H.js";import"./index-DfeXTFmx.js";/* empty css             *//* empty css                 */import"./index-CZh1RU_w.js";/* empty css                        */import"./index-DYLzNb0k.js";import"./formula-HQf-IMJj.js";const we={__name:"index",setup(ee,{expose:c}){c();const f=H(),t=Z(),D=p(null),w=p([b().startOf("year").valueOf(),b().endOf("year").valueOf()]),k={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"水表月统计报表",sheetName:"表计报表",modes:["current"]},v=p([]),m=B(()=>{const e={},r={};let g=0,i=0;o.value.forEach((n,a)=>{e[`usage_${a}`]=0,r[`usage_${a}`]=0}),v.value.forEach(n=>{!n.parent_id&&!n.meter_code.includes("不明水率")&&(o.value.forEach((a,_)=>{e[`usage_${_}`]+=Number(n[`usage_${_}`]||0)}),g+=Number(n.sum||0)),n.children&&n.children.forEach(a=>{a.meter_code.includes("不明水率")||(o.value.forEach((_,x)=>{r[`usage_${x}`]+=Number(a[`usage_${x}`]||0)}),i+=Number(a.sum||0))})});const l={};o.value.forEach((n,a)=>{const _=e[`usage_${a}`],x=r[`usage_${a}`];l[`usage_${a}`]=V(_,x)});let R=[{meter_code:"一级表合计",...e,sum:g.toFixed(2)},{meter_code:"二级表合计",...r,sum:i.toFixed(2)},{meter_code:"一级表不明率",...l,sum:V(g,i)}];return s.value.forEach(n=>{R.push({meter_code:n.name,...n,sum:0})}),R}),y=p(!1),C=p(!1),M=j({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:e})=>O(e)}),o=B(()=>K(w.value[0],w.value[1],"month"));let s=p([]);async function d(){if(!y.value)try{v.value=[],y.value=!0;const e=f.treeDataForChart.map(l=>A(l));let r=G().currentCompany.id;s.value=await I(r,"用水月报表"),s.value=await $(s.value,o.value,"month");const g=await Promise.all(e);v.value=g.filter(Boolean);const i=D.value;for(let l=0;l<2;l++)await(i==null?void 0:i.setAllTreeExpand(!0))}catch(e){L(e,"获取水表数据失败")}finally{y.value=!1}}async function A(e){try{const r=await Q({id:e.id,start_time:w.value[0],end_time:b(w.value[1]).valueOf(),interval:"month"});return X(e,r)}catch(r){return L(r,"获取水表数据失败"),null}}const N=p(!1);async function O(e){try{const r=e.customChildren.map(l=>A(l)),i=(await Promise.all(r)).filter(Boolean);return N.value&&i.push(await U(e,i)),i}catch(r){return L(r,"获取水表数据失败"),[]}}async function U(e,r){const g={};return o.value.forEach((i,l)=>{const R=e[`usage_${l}`]||0,n=r.reduce((a,_)=>_.meter_code.includes("不明水率")?a:a+(Number(_[`usage_${l}`])||0),0);g[`usage_${l}`]=V(R,n)}),{meter_code:e.meter_code+"不明水率",...g,sum:0}}async function te(){try{C.value=!0;const e=D.value;for(let r=0;r<f.meterLevels.length;r++)await(e==null?void 0:e.setAllTreeExpand(!0));await(e==null?void 0:e.openExport({includeFooter:!0}))}finally{C.value=!1}}P([()=>w.value,()=>f.treeDataForChart],()=>{d()},{deep:!0}),P([()=>N.value],()=>{d()},{deep:!0}),z(async()=>{(!f.treeDataForChart.length||f.currentSelectedType!==1)&&(f.setCurrentSelectedType(1),await f.fetchMeterList()),d()});const W={meterStore:f,areaStore:t,tableRef:D,dateRange:w,exportConfig:k,meterTableData:v,footerData:m,isLoading:y,isExporting:C,treeConfig:M,dateColumns:o,get formulaList(){return s},set formulaList(e){s=e},fetchMeterReport:d,fetchAndProcessMeterData:A,showUnknownRate:N,loadChildNodes:O,calculateChildWaterLossRate:U,handleExport:te,ref:p,onMounted:z,watch:P,computed:B,reactive:j,get dayjs(){return b},get getMeterReportApi(){return Q},CustomDatePicker:me,get useMeterStore(){return H},get useAreaStore(){return Z},get calculateWaterLossRate(){return V},get formatFlowValue(){return ue},get formatReadingValue(){return ce},get generateDateColumns(){return K},get transformMeterData(){return X},get footerCellStyle(){return de},get footerRowStyle(){return fe},get rowStyle(){return ge},get cellStyle(){return _e},get headerRowStyle(){return pe},get handleError(){return L},get useCompanyStore(){return G},get getFormulaData(){return $},get getFormulaList(){return I}};return Object.defineProperty(W,"__isScriptSetup",{enumerable:!1,value:!0}),W}},ve={class:"meter-report-container"},ye={class:"meter-report-header"};function Ce(ee,c,f,t,D,w){const k=ie,v=se,m=T("vxe-column"),y=T("vxe-colgroup"),C=T("vxe-table"),M=ne;return E(),J("div",ve,[Y("div",ye,[u(t.CustomDatePicker,{maxDays:365*2,border:"","is-month-picker":!0,round:"",modelValue:t.dateRange,"onUpdate:modelValue":c[0]||(c[0]=o=>t.dateRange=o)},null,8,["modelValue"]),u(k,{modelValue:t.showUnknownRate,"onUpdate:modelValue":c[1]||(c[1]=o=>t.showUnknownRate=o),label:"显示子表的不明水率"},null,8,["modelValue"]),u(v,{style:{"margin-left":"auto"},type:"success",loading:t.isExporting,onClick:t.handleExport},{icon:h(()=>c[2]||(c[2]=[Y("img",{src:he,width:"14",height:"14",alt:"",srcset:""},null,-1)])),default:h(()=>[c[3]||(c[3]=S(" 导出 "))]),_:1},8,["loading"])]),oe((E(),q(C,{"show-overflow":"","header-row-style":t.headerRowStyle,"row-style":t.rowStyle,"cell-style":t.cellStyle,"footer-row-style":t.footerRowStyle,"footer-cell-style":t.footerCellStyle,"show-footer":"",height:"92%",ref:"tableRef",border:"",align:"center",data:t.meterTableData,"tree-config":t.treeConfig,"footer-data":t.footerData,"export-config":t.exportConfig},{default:h(()=>[u(m,{fixed:"left","tree-node":"",field:"meter_code",title:"表计编号",width:"200"}),u(m,{fixed:"left",width:"100","show-overflow":"tooltip",title:"所供区域"},{default:h(({row:o})=>[S(F(t.areaStore.getAreaNameById(o.area_id)||"-"),1)]),_:1}),u(m,{width:"120","show-overflow":"tooltip",field:"installation_location",title:"安装位置"}),u(m,{field:"specification",width:"100",title:"规格"}),u(m,{width:"100",field:"startReading",title:"启读数"}),(E(!0),J(ae,null,le(t.dateColumns,(o,s)=>(E(),q(y,{key:o,title:o},{default:h(()=>[u(m,{width:"100",field:`usage_${s}`,title:"流量"},{default:h(({row:d})=>[S(F(t.formatFlowValue(d[`usage_${s}`])),1)]),footer:h(({row:d})=>[S(F(t.formatFlowValue(d[`usage_${s}`])),1)]),_:2},1032,["field"]),u(m,{width:"100",field:`reading_${s}`,title:"读数"},{default:h(({row:d})=>[S(F(t.formatReadingValue(d[`reading_${s}`])),1)]),_:2},1032,["field"])]),_:2},1032,["title"]))),128)),u(m,{fixed:"right",field:"sum",width:"100",title:"总流量"})]),_:1},8,["header-row-style","row-style","cell-style","footer-row-style","footer-cell-style","data","tree-config","footer-data"])),[[M,t.isLoading]])])}const rt=re(we,[["render",Ce],["__scopeId","data-v-4f4bb94f"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/IntelligentMeter/AnnualMeter/index.vue"]]);export{rt as default};
