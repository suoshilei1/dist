import{_ as P,r as u,F as M,a as V,w as S,o as O,j as k,c as B,d as R,e as N,k as o,l as y,f as C,Y as H,J as I,g as L,v as q}from"./index-DWtISIBF.js";import{E as z}from"./button-DfREtLL_.js";import{d as f}from"./dayjs.min-t3tQ4ZJg.js";import{C as J}from"./CustomDatePicker-DTvPnXeh.js";import{u as T,g as D,m as E,f as U}from"./meter-BWYCtTLu.js";import{E as m}from"./index-DYLzNb0k.js";import"./index-CuP5NVML.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DjvbDGpK.js";import"./use-form-item-CuJrx89H.js";import"./icon-Cc3ZZocH.js";import"./date-picker-B_H4_mfX.js";import"./popper-BNb2tGl7.js";import"./index-CVAPKPs0.js";import"./aria-BUADUvnR.js";import"./focus-trap-D8pg8SM_.js";import"./input-B0bTKLmJ.js";import"./index-DibVzrKz.js";import"./scrollbar-BMOxp_jN.js";import"./index-CeeR5a7H.js";import"./index-DfeXTFmx.js";import"./isEqual-DqXByToB.js";import"./_Uint8Array-DaZSNKBQ.js";/* empty css             *//* empty css                 */import"./index-CZh1RU_w.js";const G={__name:"index",setup(j,{expose:l}){l();const i=T(),t=u(null),d=u(f().subtract(1,"day")),p=M(()=>{const e=f(d.value).startOf("day").valueOf(),a=f(d.value).endOf("day").valueOf();return[e,a]}),h={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"电表日抄表记录",sheetName:"表计报表",modes:["current"]},r=u([]),c=u(!1),g=u(!1),s=V({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:e})=>w(e)});async function v(){if(!c.value)try{r.value=[],c.value=!0;let e=await x(i.treeDataForChart);r.value=e.filter(Boolean);const a=t.value}catch(e){m({type:"error",title:"Error",message:e.message||"获取电表数据失败"}),console.error("Failed to fetch meter report:",e)}finally{c.value=!1}}async function x(e){const a=e.map(n=>n.id).toString();try{let n=await D({id:`[${a}]`,start_time:p.value[0],end_time:p.value[1]});if(n.code!==200)return console.error("Failed to fetch meter detail:",error),m({type:"error",title:"Error",message:error.message||"获取电表数据失败"}),[];let Y=E(e,n.meter_readings,"current_reading",!0),b=await D({id:`[${a}]`,start_time:f(d.value).subtract(1,"day").startOf("day").valueOf(),end_time:f(d.value).subtract(1,"day").endOf("day").valueOf()});return b.code!==200?(console.error("Failed to fetch meter detail:",error),m({type:"error",title:"Error",message:error.message||"获取电表数据失败"}),[]):E(Y,b.meter_readings,"yesterday_reading").map(_=>({..._,Value:_.current_reading-_.yesterday_reading,hasChild:_.children.length>0,customChild:_.children}))}catch(n){console.error("Failed to fetch meter detail:",n),m({type:"error",title:"Error",message:n.message||"获取电表数据失败"})}}async function w(e){try{return(await x(e.customChild)).filter(Boolean)}catch(a){return m({type:"error",title:"Error",message:a.message||"获取电表数据失败"}),console.error("Failed to load child nodes:",a),[]}}async function A(){try{g.value=!0;const e=t.value;for(let a=0;a<i.meterLevels.length;a++)await(e==null?void 0:e.setAllTreeExpand(!0));await(e==null?void 0:e.openExport({includeFooter:!0}))}finally{g.value=!1}}S([()=>p.value,()=>i.treeDataForChart],()=>{v()},{deep:!0}),O(async()=>{(!i.treeDataForChart.length||i.currentSelectedType!==2)&&(i.setCurrentSelectedType(2),await i.fetchMeterList()),v()});const F={meterStore:i,tableRef:t,date:d,dateRange:p,exportConfig:h,meterTableData:r,isLoading:c,isExporting:g,treeConfig:s,fetchMeterDetail:v,fetchAndProcessMeterData:x,loadChildNodes:w,handleExport:A,ref:u,onMounted:O,watch:S,computed:M,reactive:V,get dayjs(){return f},CustomDatePicker:J,get useMeterStore(){return T},get formatFlowValue(){return U},get mapMeterData(){return E},get getMeterDetailApi(){return D},get ElNotification(){return m}};return Object.defineProperty(F,"__isScriptSetup",{enumerable:!1,value:!0}),F}},K={class:"meter-report-container"},Q={class:"meter-report-header"};function W(j,l,i,t,d,p){const h=z,r=k("vxe-column"),c=k("vxe-table"),g=q;return B(),R("div",K,[N("div",Q,[o(t.CustomDatePicker,{border:"",isRange:!1,modelValue:t.date,"onUpdate:modelValue":l[0]||(l[0]=s=>t.date=s)},null,8,["modelValue"]),o(h,{style:{"margin-left":"auto"},type:"success",loading:t.isExporting,onClick:t.handleExport},{icon:y(()=>l[1]||(l[1]=[N("i",{class:"fa fa-download"},null,-1)])),default:y(()=>[l[2]||(l[2]=C(" 导出 "))]),_:1},8,["loading"])]),H((B(),I(c,{ref:"tableRef",height:"92%",border:"",align:"center",data:t.meterTableData,"tree-config":t.treeConfig,"export-config":t.exportConfig},{default:y(()=>[o(r,{fixed:"left",type:"seq"}),o(r,{"tree-node":"",fixed:"left",field:"meter_code",title:"编号"}),o(r,{fixed:"left",field:"id",title:"表号"}),o(r,{field:"specification",title:"规格"}),o(r,{field:"yesterday_reading",title:"上次读数"}),o(r,{field:"current_reading",title:"本次读数"}),o(r,{field:"current_reading_time",title:"时间"},{default:y(({row:s})=>[C(L(t.dayjs(s.current_reading_time).format("YYYY/MM/DD HH:mm:ss")),1)]),_:1}),o(r,{fixed:"right",field:"Value",title:"用量"},{default:y(({row:s})=>[C(L(t.formatFlowValue(s.Value)),1)]),_:1})]),_:1},8,["data","tree-config"])),[[g,t.isLoading]])])}const Ee=P(G,[["render",W],["__scopeId","data-v-02febb65"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/ElectricityData/IntelligentMeter/DailyMeter/index.vue"]]);export{Ee as default};
