import{F as M,r as g,T as $,_ as ee,w as T,o as I,j as L,c as v,d as O,e as j,k as y,l as S,U as R,V as N,J as P,f as q,Y as G,a5 as te,v as ae}from"./index-DWtISIBF.js";import{E as re}from"./button-DfREtLL_.js";/* empty css            */import{E as oe,b as le,a as ne}from"./select-DYqyOwb9.js";import"./scrollbar-BMOxp_jN.js";import"./popper-BNb2tGl7.js";import{u as ue,g as F}from"./meter-BWYCtTLu.js";import{d as f}from"./dayjs.min-t3tQ4ZJg.js";import{C as ie}from"./CustomDatePicker-DTvPnXeh.js";/* empty css             *//* empty css                 *//* empty css                        */import{E as k}from"./index-CZh1RU_w.js";import{E as se}from"./index-DYLzNb0k.js";import"./index-CuP5NVML.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DjvbDGpK.js";import"./use-form-item-CuJrx89H.js";import"./icon-Cc3ZZocH.js";import"./index-0A8HTOTd.js";import"./castArray-6TPyo715.js";import"./index-CVAPKPs0.js";import"./index-DibVzrKz.js";import"./aria-BUADUvnR.js";import"./scroll-DMdoCUCr.js";import"./isEqual-DqXByToB.js";import"./_Uint8Array-DaZSNKBQ.js";import"./_baseIteratee-FAqII4j1.js";import"./index-DfeXTFmx.js";import"./focus-trap-D8pg8SM_.js";import"./date-picker-B_H4_mfX.js";import"./input-B0bTKLmJ.js";import"./index-CeeR5a7H.js";const Y=[{prop:"time",label:"时间",width:"auto",group:"基础信息",required:!0},{prop:"value",label:"读数",width:"auto",group:"基础信息"},{prop:"usage",label:"用量",width:"auto",group:"基础信息"}],pe=[{prop:"voltage_a",label:"A相电压",width:"auto",group:"电压"},{prop:"voltage_b",label:"B相电压",width:"auto",group:"电压"},{prop:"voltage_c",label:"C相电压",width:"auto",group:"电压"},{prop:"voltage_ab",label:"AB线电压",width:"auto",group:"电压"},{prop:"voltage_bc",label:"BC线电压",width:"auto",group:"电压"},{prop:"voltage_ac",label:"AC线电压",width:"auto",group:"电压"},{prop:"current_a",label:"A相电流",width:"auto",group:"电流"},{prop:"current_b",label:"B相电流",width:"auto",group:"电流"},{prop:"current_c",label:"C相电流",width:"auto",group:"电流"},{prop:"leakage",label:"漏电流",width:"auto",group:"电流"},{prop:"active_power_t",label:"总有功功率",width:"auto",group:"功率"},{prop:"deactivate_power_t",label:"总无功功率",width:"auto",group:"功率"},{prop:"sight_power_t",label:"总视在功率",width:"auto",group:"功率"},{prop:"active_total_power_t",label:"总有功电能",width:"auto",group:"电能"},{prop:"deactive_total_power_t",label:"总无功电能",width:"auto",group:"电能"},{prop:"sight_total_power_t",label:"总视在电能",width:"auto",group:"电能"},{prop:"power_factor",label:"功率因数",width:"auto",group:"其他"},{prop:"frequency",label:"频率",width:"auto",group:"其他"}],z=["time","value","usage"],ce=["voltage_a","voltage_b","voltage_c","current_a","current_b","current_c","active_power_t","deactivate_power_t"],de=ue(),ge=M(()=>{var c;return((c=de.currentMeter)==null?void 0:c.type)===2});function H(){const c=g([...z]),r=g([]),s=M(()=>{const p={};return r.value.forEach(i=>{p[i.group]||(p[i.group]=[]),p[i.group].push({label:i.label,value:i.prop})}),Object.entries(p).map(([i,_])=>({label:i,options:_}))}),e=M(()=>r.value.filter(p=>c.value.includes(p.prop)||p.required)),n=()=>{ge.value?(c.value=[...z,...ce],r.value=[...Y,...pe]):(c.value=[...z],r.value=[...Y])};return $(n),{selectedColumns:c,columnGroups:s,visibleColumns:e,columnReset:n}}const me={__name:"MeterReportDailyDetail",props:{currentMeter:{type:Object,required:!0}},setup(c,{expose:r}){r();const s=c,e=g([]),n=g({field:"",order:""});let{selectedColumns:p,columnGroups:i,visibleColumns:_,columnReset:E}=H();const b=g(!1),h=g(!1),D=g(null),u=g({currentPage:1,pageSize:10,total:0}),x=[f().subtract(2,"day").startOf("day").valueOf(),f().subtract(1,"day").endOf("day").valueOf()],o=g(x);function w(t){if(!Array.isArray(t)||t.length===0)return[];const a=t.sort((l,d)=>f(l.time).valueOf()-f(d.time).valueOf());return a.map((l,d)=>{const C=d>0?a[d-1].value:null,m=C!==null?Number(l.value)-Number(C):null;return{...l,time:f(l.time).format("MM-DD HH:mm"),usage:m!==null?m.toFixed(2):"--"}})}const J=M(()=>{let t=[...e.value];n.value.field&&n.value.order&&t.sort((d,C)=>{const m=d[n.value.field],B=C[n.value.field],U=n.value.order==="desc"?-1:1;return n.value.field==="usage"&&(m===null||B===null)?m===null?1:-1:m>B?U:-U});const a=(u.value.currentPage-1)*u.value.pageSize,l=a+u.value.pageSize;return t.slice(a,l)});T([()=>s.currentMeter,()=>o.value],async([t,a],[l,d])=>{if(!t)return;const C=!l||t.id!==l.id,m=!d||a[0]!==d[0]||a[1]!==d[1];(C||m)&&await V()});async function V(){var t;if((t=s.currentMeter)!=null&&t.id){b.value=!0,e.value=[];try{const a=await F({id:s.currentMeter.id,start_time:o.value[0].valueOf(),end_time:o.value[1].valueOf()});if(a.code===200){const l=w(a.meter_readings||[]);console.log("processedData:",l),e.value=l,u.value.total=l.length,u.value.currentPage=1,l.length===0&&k.warning("所选时间范围内无数据")}else throw new Error(a.message||"获取数据失败")}catch(a){console.error("获取表计数据失败:",a),se({title:"请求失败",message:a.message||"服务器错误，请稍后重试",type:"error",duration:5e3})}finally{b.value=!1}}}function K({currentPage:t,pageSize:a}){u.value.currentPage=t,u.value.pageSize=a}function Q({property:t,order:a}){n.value.field=t,n.value.order=a}function W(){o.value=x,n.value={field:"",order:""},u.value.currentPage=1;const t=D.value;t==null||t.clearSort(),E()}async function X(){var t;if(!e.value.length){k.warning("暂无数据可导出");return}try{h.value=!0;const a=D.value;await(a==null?void 0:a.exportData({filename:`${((t=s==null?void 0:s.currentMeter)==null?void 0:t.meter_code)||"未知表计"}_${f().format("YYYY-MM-DD")}_统计报表`,type:"xlsx",mode:"all",useStyle:!0,data:e.value}))}catch(a){console.error("导出失败:",a),k.error("导出失败，请重试")}finally{h.value=!1}}function Z({rowIndex:t}){return(u.value.currentPage-1)*u.value.pageSize+t+1}I(()=>{s.currentMeter&&V()});const A={props:s,tableData:e,sortConfig:n,get selectedColumns(){return p},set selectedColumns(t){p=t},get columnGroups(){return i},set columnGroups(t){i=t},get visibleColumns(){return _},set visibleColumns(t){_=t},get columnReset(){return E},set columnReset(t){E=t},isLoading:b,isExporting:h,tableRef:D,pageVO:u,defautTimeRange:x,dateRange:o,processData:w,currentPageData:J,fetchMeterList:V,handlePageChange:K,handleSortChange:Q,handleReset:W,handleExport:X,getSerialNumber:Z,ref:g,onMounted:I,watch:T,computed:M,get getMeterDetailApi(){return F},get dayjs(){return f},CustomDatePicker:ie,get useColumnSelect(){return H}};return Object.defineProperty(A,"__isScriptSetup",{enumerable:!1,value:!0}),A}},ve={class:"table-container"},fe={class:"filter-container"};function _e(c,r,s,e,n,p){const i=oe,_=le,E=ne,b=re,h=L("vxe-column"),D=L("vxe-table"),u=L("vxe-pager"),x=ae;return v(),O("div",ve,[j("div",fe,[y(e.CustomDatePicker,{modelValue:e.dateRange,"onUpdate:modelValue":r[0]||(r[0]=o=>e.dateRange=o),"max-days":4,disabled:e.isLoading},null,8,["modelValue","disabled"]),y(E,{multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":2,modelValue:e.selectedColumns,"onUpdate:modelValue":r[1]||(r[1]=o=>e.selectedColumns=o),placeholder:"Select",style:{width:"13.5rem","margin-right":"1rem"}},{default:S(()=>[(v(!0),O(R,null,N(e.columnGroups,o=>(v(),P(_,{key:o.label,label:o.label},{default:S(()=>[(v(!0),O(R,null,N(o.options,w=>(v(),P(i,{key:w.value,label:w.label,value:w.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]),y(b,{onClick:e.handleReset,type:"danger",disabled:e.isLoading},{default:S(()=>r[4]||(r[4]=[q("重置")])),_:1},8,["disabled"]),y(b,{style:{"margin-left":"auto"},loading:e.isExporting,disabled:e.isExporting||e.isLoading||!e.tableData.length,onClick:e.handleExport,type:"success"},{icon:S(()=>r[5]||(r[5]=[j("i",{class:"fa fa-download"},null,-1)])),default:S(()=>[r[6]||(r[6]=q(" 导出 "))]),_:1},8,["loading","disabled"])]),G((v(),P(D,{align:"center",ref:"tableRef",data:e.currentPageData,"empty-text":e.isLoading?"加载中...":"暂无数据",onSortChange:e.handleSortChange},{default:S(()=>[y(h,{type:"seq",width:"70","seq-method":e.getSerialNumber}),(v(!0),O(R,null,N(e.visibleColumns,o=>(v(),P(h,{key:o.prop,field:o.prop,title:o.label,sortable:""},null,8,["field","title"]))),128))]),_:1},8,["data","empty-text"])),[[x,e.isLoading]]),G(y(u,{currentPage:e.pageVO.currentPage,"onUpdate:currentPage":r[2]||(r[2]=o=>e.pageVO.currentPage=o),pageSize:e.pageVO.pageSize,"onUpdate:pageSize":r[3]||(r[3]=o=>e.pageVO.pageSize=o),total:e.pageVO.total,layouts:["Home","PrevJump","PrevPage","Number","NextPage","NextJump","End","Sizes","Total"],onPageChange:e.handlePageChange},null,8,["currentPage","pageSize","total"]),[[te,e.tableData.length>0]])])}const Xe=ee(me,[["render",_e],["__scopeId","data-v-17df70ba"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/ElectricityData/ElectricityDataCenter/DailyReport/components/MeterReportDailyDetail.vue"]]);export{Xe as default};
