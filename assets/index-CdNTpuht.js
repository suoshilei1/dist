import{aa as fe,r as k,_ as I,F as S,c as v,J as T,l as f,d as C,T as P,U as F,k as c,e as u,g as U,N as B,h as R,n as ve,f as E,j as te,am as ge,V as A,ab as O,X as le,v as ne,w as ae}from"./index-DU5BV6sj.js";/* empty css             */import{c as ye}from"./header-3UtByIIS.js";import{E as se,a as ie}from"./col-NhIdzeqW.js";import{E as ue}from"./empty-FpkiWcnp.js";import{d as M}from"./dayjs.min-BzhD8rH5.js";import{E as Z}from"./card-CrntnV6K.js";/* empty css                */import{E as ce}from"./popper-DmsXjoSL.js";import{_ as be}from"./AnimatedNumber-DsaAZO3g.js";import{g as re}from"./price-CHbb6f-c.js";import{u as L,E as he}from"./divider-CZo1qVen.js";import{E as $}from"./button-C3fNXQ0E.js";import{u as J}from"./area-CYcRQDxZ.js";import{u as oe,b as X,p as H}from"./meter-CawyXifQ.js";import{h as N}from"./handleError-Dl3av5vd.js";import{u as Y,a as K}from"./energyUser-D3h_uRCa.js";import{E as we}from"./dialog-BqmwFatm.js";import"./overlay-CaKmC84a.js";import{E as Se,a as Ce}from"./form-item-Da9sIxn1.js";import"./input-Cag95VNY.js";import{E as Ue}from"./input-number-BQBJL8eX.js";/* empty css            */import{E as de,a as me}from"./select-CVxfSd-L.js";import"./scrollbar-5YYltO8z.js";import{E as Ve,a as ke}from"./radio-group-zQV3zrYY.js";/* empty css              */import{E as xe}from"./index-BCql8Cu-.js";/* empty css             *//* empty css                 */import{_ as De}from"./设置-D6o4v_fI.js";import{E as Ee}from"./index-BmwD9m8C.js";import{C as Re}from"./CustomDatePicker-DwR5Ke4u.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DsemQHVw.js";import"./index-imETKNmt.js";import"./use-form-item-Bwue1zaK.js";import"./aria-BUADUvnR.js";import"./focus-trap-BFH-jL9N.js";import"./index-HfsxB2KS.js";import"./icon-Lrcg122U.js";/* empty css                        */import"./index-BjNTkPPk.js";import"./index-DspxDzgo.js";import"./scroll-b_nwKRMA.js";import"./vnode-CCieS0_D.js";import"./refs-BkwxSs2a.js";import"./castArray-C1OtMDCV.js";import"./_Uint8Array-ntTh0Oyk.js";import"./_initCloneObject-CWYxvHbU.js";import"./index-BcLR6-Z9.js";import"./index-DemxtX7w.js";import"./isEqual-Df5tNRy_.js";import"./_baseIteratee-B5KIseQu.js";import"./index-BRz9a87F.js";import"./date-picker-3aSnRp6y.js";const j=fe("waterPrice",()=>{const V=k([]),t=k([]);return{priceDetail:V,lastPriceDetail:t,getPriceDetail:async m=>{let s=await re(m);m.area_id&&(s.data={...s.data,areas:[s.data]}),console.log(s.data),V.value=s.data},getLastPriceDetail:async m=>{let s=await re(m);t.value=s.data}}}),Q=(V,t,n={})=>{if(typeof V!="number"||typeof t!="number")throw new Error("参数必须为数字类型");const{precision:e=2,asPercent:m=!1,zeroStrategy:s="zero",zeroValue:p="-- --"}=n;if(t===0)switch(s){case"zero":return m?"0%":0;case"keep":return m?`${V}%`:V;case"custom":return p;default:throw new Error("无效的zeroStrategy值")}const a=(V-t)/Math.abs(t)*100,o=Number(a.toFixed(e));return m?`${o}%`:o},Pe={__name:"StatisticsCard",setup(V,{expose:t}){t();let n=j(),e=L(),m=S(()=>{var h,x;let r=((x=(h=n.priceDetail)==null?void 0:h.areas)==null?void 0:x.map(b=>b.rule_id))??[];return[...new Set(r)].map(b=>({type:e.getPriceRuleNameById(b),price:e.getPriceRulePriceById(b),color:"#409EFF"}))});const s=S(()=>{var r,y,h,x;return{waterUsage:{current:((r=n==null?void 0:n.priceDetail)==null?void 0:r.usage)??0,lastYear:((y=n==null?void 0:n.lastPriceDetail)==null?void 0:y.usage)??0},waterCost:{current:((h=n==null?void 0:n.priceDetail)==null?void 0:h.price)??0,lastYear:((x=n==null?void 0:n.lastPriceDetail)==null?void 0:x.price)??0},prices:m.value}}),p=r=>r>0?"compare-up":"compare-down",a=r=>r>0?"fa fa-arrow-up":"fa fa-arrow-down",o=S(()=>[{title:"用水单价",hasPrices:!0,icon:"fa fa-dollar",colorClass:"text-danger"},{title:"用水量",value:s.value.waterUsage.current,prefix:"",unit:"m³",icon:"fa fa-tint",colorClass:"text-success",compare:{value:Q(+s.value.waterUsage.current,+s.value.waterUsage.lastYear),lastYear:s.value.waterUsage.lastYear}},{title:"用水费用",value:s.value.waterCost.current,prefix:"¥",icon:"fa fa-money",colorClass:"text-primary",compare:{value:Q(+s.value.waterCost.current,+s.value.waterCost.lastYear),lastYear:s.value.waterCost.lastYear}}]),i={get waterPriceStore(){return n},set waterPriceStore(r){n=r},get priceRuleStore(){return e},set priceRuleStore(r){e=r},get prices(){return m},set prices(r){m=r},staticData:s,getCompareClass:p,getCompareIcon:a,costStatistics:o,computed:S,AnimatedNumber:be,get useWaterPriceStore(){return j},get calculateCompare(){return Q},get usePriceRuleStore(){return L}};return Object.defineProperty(i,"__isScriptSetup",{enumerable:!1,value:!0}),i}},We={class:"stat-header"},Te={class:"stat-title"},Me={key:1,class:"prices-grid"},Fe={class:"type-text"},Ae={class:"price-value"},Oe={key:2,class:"stat-compare"},Le={class:"compare-current"},Ye={class:"compare-last"};function je(V,t,n,e,m,s){const p=ce,a=Z,o=se,i=ie;return v(),T(i,{gutter:20,class:"statistics"},{default:f(()=>[(v(!0),C(P,null,F(e.costStatistics,r=>(v(),T(o,{span:8,key:r.title},{default:f(()=>[c(a,{shadow:"hover",class:"stat-card"},{default:f(()=>[u("div",We,[u("div",Te,U(r.title),1),u("div",{class:B(["stat-icon",r.colorClass])},[u("i",{class:B(r.icon)},null,2)],2)]),r.hasPrices?R("",!0):(v(),C("div",{key:0,class:B(["stat-value",r.colorClass])},[c(e.AnimatedNumber,{value:r.value,prefix:r.prefix,suffix:r.unit},null,8,["value","prefix","suffix"])],2)),r.hasPrices?(v(),C("div",Me,[(v(!0),C(P,null,F(e.staticData.prices,y=>(v(),C("div",{key:y.type,class:"price-item"},[u("div",{class:"price-circle",style:ve({backgroundColor:y.color})},[c(p,{content:y.type,placement:"top"},{default:f(()=>[u("span",Fe,U(y.type.slice(0,2)),1)]),_:2},1032,["content"])],4),u("div",Ae,"¥"+U(y.price)+"/m³",1)]))),128))])):R("",!0),r.compare?(v(),C("div",Oe,[u("div",Le,[t[0]||(t[0]=u("span",{class:"compare-label"},"同比",-1)),u("span",{class:B(["compare-value",e.getCompareClass(r.compare.value)])},[u("i",{class:B(e.getCompareIcon(r.compare.value))},null,2),E(" "+U(r.compare.value)+"% ",1)],2)]),u("div",Ye," 去年同期："+U(r.prefix)+U(r.compare.lastYear)+U(r.unit),1)])):R("",!0)]),_:2},1024)]),_:2},1024))),128))]),_:1})}const Ie=I(Pe,[["render",je],["__scopeId","data-v-1dd6c197"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/StatisticsCard.vue"]]),Be={__name:"WaterUsageTable",props:{dateRange:{type:Array,default:[]}},setup(V,{expose:t}){t();let n=j(),e=L(),m=J(),s=V;const p=k(),a=S(()=>{var _;const b=((_=n==null?void 0:n.priceDetail)==null?void 0:_.areas)??[],D=s.dateRange;return b.map(w=>({date:`${M(D[0]).format("YYYY-MM-DD")}至${M(D[1]).format("YYYY-MM-DD")}`,area:m.getAreaNameById(w.area_id),waterType:e.getPriceRuleNameById(w.rule_id),price:+e.getPriceRulePriceById(w.rule_id),usage:+w.usage,fee:+w.price}))}),o=S(()=>a.value.length?[{row:0,col:0,rowspan:a.value.length,colspan:1}]:[]),i=()=>a.value.reduce((D,_)=>D+_.usage,0).toFixed(2),r=()=>a.value.reduce((D,_)=>D+_.fee,0).toFixed(2),y=k([{date:"合计",usage:S(()=>i()),fee:S(()=>r())}]),x={get waterPriceStore(){return n},set waterPriceStore(b){n=b},get priceRuleStore(){return e},set priceRuleStore(b){e=b},get areaStore(){return m},set areaStore(b){m=b},get props(){return s},set props(b){s=b},tableRef:p,tableData:a,computedMergeCells:o,getTotalUsage:i,getTotalFee:r,footerData:y,exportEvent:()=>{const b=p.value;b&&b.openExport({filename:"水费明细表",type:"xlsx",exportMethod:({options:D})=>b.exportData(Object.assign({},D,{original:!1,formatter:!0,footer:!0,columnFilterMethod:({column:_})=>_.property!=="seq"}))})},get useAreaStore(){return J},get usePriceRuleStore(){return L},get useWaterPriceStore(){return j},get dayjs(){return M},ref:k,computed:S};return Object.defineProperty(x,"__isScriptSetup",{enumerable:!1,value:!0}),x}};function Ne(V,t,n,e,m,s){const p=$,a=te("vxe-column"),o=te("vxe-table"),i=Z;return v(),T(i,null,{header:f(()=>[t[1]||(t[1]=u("div",{class:"title"},"水费明细表",-1)),c(p,{size:"small",type:"primary",icon:"download",onClick:e.exportEvent,class:"export-btn"},{default:f(()=>t[0]||(t[0]=[E(" 导出表格 ")])),_:1})]),default:f(()=>[c(o,{border:"","show-footer":"",ref:"tableRef","export-config":{type:"xlsx"},data:e.tableData,"merge-cells":e.computedMergeCells,"footer-data":e.footerData,height:"330","row-config":{height:50}},{default:f(()=>[c(a,{field:"date",title:"日期"}),c(a,{field:"area",title:"区域"}),c(a,{field:"waterType",title:"用水类型"}),c(a,{field:"price",title:"水单价"},{default:f(({row:r})=>[E(U(r.price.toFixed(2)),1)]),_:1}),c(a,{field:"usage",title:"用水量"},{default:f(({row:r})=>[E(U(r.usage.toFixed(2)),1)]),_:1}),c(a,{field:"fee",title:"水费"},{default:f(({row:r})=>[E(U(r.fee.toFixed(2)),1)]),_:1})]),_:1},8,["data","merge-cells","footer-data"])]),_:1})}const ze=I(Be,[["render",Ne],["__scopeId","data-v-e75726dc"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/WaterUsageTable.vue"]]),qe={__name:"UnknownWaterDialog",props:{modelValue:Boolean,currentMethod:{type:String,default:"water"}},emits:["update:modelValue","confirm"],setup(V,{expose:t,emit:n}){t();const e=V,m=n,s=Y(),p=S({get:()=>e.modelValue,set:l=>m("update:modelValue",l)}),a=k({method:e.currentMethod,users:[]}),o=k(null),i=S(()=>{const l=a.value.users.map(g=>g.id);return s.energyUserList.filter(g=>!l.includes(g.id))}),r=S(()=>a.value.users.reduce((l,g)=>l+(g.area||0),0)),y=S(()=>a.value.users.reduce((l,g)=>l+(g.water||0),0)),h=S(()=>a.value.users.reduce((l,g)=>l+(g.persons||0),0)),x=S(()=>a.value.users.reduce((l,g)=>l+(g.ratio||0),0)),b=S(()=>{if(a.value.users.length===0)return!1;switch(a.value.method){case"area":return a.value.users.every(l=>l.area>0);case"water":return a.value.users.every(l=>l.water>0);case"person":return a.value.users.every(l=>l.persons>0);case"custom":return Math.abs(x.value-100)<.01;default:return!1}});function D(l){if(!l)return;const g=s.energyUserList.find(G=>G.id===l);g&&a.value.users.push({id:g.id,name:g.name,area:0,water:0,persons:0,ratio:0}),o.value=null}function _(){const l=a.value.users;if(l.length!==0)switch(a.value.method){case"area":r.value>0&&l.forEach(g=>{g.ratio=g.area/r.value*100});break;case"water":y.value>0&&l.forEach(g=>{g.ratio=g.water/y.value*100});break;case"person":h.value>0&&l.forEach(g=>{g.ratio=g.persons/h.value*100});break}}function w(l){if(a.value.method!=="custom")return;const g=a.value.users,G=g.reduce((ee,pe,_e)=>_e!==l?ee+(pe.ratio||0):ee,0);G+g[l].ratio>100&&(g[l].ratio=100-G)}function d(l){a.value.users.splice(l,1),a.value.method!=="custom"&&_()}function W(){m("confirm",{method:a.value.method,users:a.value.users.map(l=>({id:l.id,name:l.name,ratio:l.ratio}))}),p.value=!1}function z(){a.value.users=[],p.value=!1}const q={props:e,emit:m,energyUsersStore:s,visible:p,form:a,selectedUser:o,availableUsers:i,totalArea:r,totalWater:y,totalPersons:h,totalRatio:x,isValid:b,handleUserSelect:D,calculateRatios:_,adjustOtherRatios:w,removeUser:d,handleConfirm:W,handleCancel:z,ref:k,computed:S,get Delete(){return ge},get useEnergyUsersStore(){return Y}};return Object.defineProperty(q,"__isScriptSetup",{enumerable:!1,value:!0}),q}},Ge={key:0,class:"users-list"},Je={class:"user-info"},Xe={class:"user-name"},He={class:"ratio"},Ke={class:"ratio"},Qe={class:"ratio"},Ze={class:"total-info"},$e={key:0},et={key:1},tt={key:2},at={key:3,class:"error-text"},rt={class:"dialog-footer"};function ot(V,t,n,e,m,s){const p=Ve,a=ke,o=Se,i=de,r=me,y=Ue,h=xe,x=$,b=Ce,D=we;return v(),T(D,{modelValue:e.visible,"onUpdate:modelValue":t[2]||(t[2]=_=>e.visible=_),title:"设置不明水分摊规则",width:"800px"},{footer:f(()=>[u("span",rt,[c(x,{onClick:e.handleCancel},{default:f(()=>t[8]||(t[8]=[E("取消")])),_:1}),c(x,{type:"primary",disabled:!e.isValid,onClick:e.handleConfirm},{default:f(()=>t[9]||(t[9]=[E(" 确认 ")])),_:1},8,["disabled"])])]),default:f(()=>[c(b,{model:e.form,"label-width":"120px"},{default:f(()=>[c(o,{label:"分摊方式"},{default:f(()=>[c(a,{modelValue:e.form.method,"onUpdate:modelValue":t[0]||(t[0]=_=>e.form.method=_)},{default:f(()=>[c(p,{value:"water",label:"water"},{default:f(()=>t[3]||(t[3]=[E("用水量比例")])),_:1}),c(p,{value:"area",label:"area"},{default:f(()=>t[4]||(t[4]=[E("面积比例")])),_:1}),c(p,{value:"person",label:"person"},{default:f(()=>t[5]||(t[5]=[E("人数比例")])),_:1}),c(p,{value:"custom",label:"custom"},{default:f(()=>t[6]||(t[6]=[E("自定义比例")])),_:1})]),_:1},8,["modelValue"])]),_:1}),c(o,{label:"添加用能户"},{default:f(()=>[c(r,{modelValue:e.selectedUser,"onUpdate:modelValue":t[1]||(t[1]=_=>e.selectedUser=_),filterable:"",clearable:"",placeholder:"请选择用能户",onChange:e.handleUserSelect},{default:f(()=>[(v(!0),C(P,null,F(e.availableUsers,_=>(v(),T(i,{key:_.id,label:_.name,value:_.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e.form.users.length>0?(v(),C("div",Ge,[(v(!0),C(P,null,F(e.form.users,(_,w)=>(v(),C("div",{key:_.id,class:"user-item"},[u("div",Je,[u("span",Xe,U(_.name),1),e.form.method==="area"?(v(),C(P,{key:0},[c(y,{modelValue:_.area,"onUpdate:modelValue":d=>_.area=d,min:0,precision:2,placeholder:"面积(m²)",onChange:e.calculateRatios},null,8,["modelValue","onUpdate:modelValue"]),u("span",He,U(_.ratio.toFixed(2))+"%",1)],64)):R("",!0),e.form.method==="water"?(v(),C(P,{key:1},[c(y,{modelValue:_.water,"onUpdate:modelValue":d=>_.water=d,min:0,precision:2,placeholder:"用水量(m³)",onChange:e.calculateRatios},null,8,["modelValue","onUpdate:modelValue"]),u("span",Ke,U(_.ratio.toFixed(2))+"%",1)],64)):R("",!0),e.form.method==="person"?(v(),C(P,{key:2},[c(y,{modelValue:_.persons,"onUpdate:modelValue":d=>_.persons=d,min:0,precision:0,placeholder:"人数",onChange:e.calculateRatios},null,8,["modelValue","onUpdate:modelValue"]),u("span",Qe,U(_.ratio.toFixed(2))+"%",1)],64)):R("",!0),e.form.method==="custom"?(v(),T(y,{key:3,modelValue:_.ratio,"onUpdate:modelValue":d=>_.ratio=d,min:0,max:100,precision:2,placeholder:"比例(%)",onChange:d=>e.adjustOtherRatios(w)},null,8,["modelValue","onUpdate:modelValue","onChange"])):R("",!0),c(x,{type:"danger",circle:"",size:"small",onClick:d=>e.removeUser(w)},{default:f(()=>[c(h,null,{default:f(()=>[c(e.Delete)]),_:1})]),_:2},1032,["onClick"])])]))),128)),u("div",Ze,[t[7]||(t[7]=u("span",null,"总计:",-1)),e.form.method==="area"?(v(),C("span",$e,"面积: "+U(e.totalArea)+"m² / ",1)):R("",!0),e.form.method==="water"?(v(),C("span",et,"用水量: "+U(e.totalWater)+"m³ / ",1)):R("",!0),e.form.method==="person"?(v(),C("span",tt,"人数: "+U(e.totalPersons)+"人 / ",1)):R("",!0),u("span",null,"比例: "+U(e.totalRatio.toFixed(2))+"%",1),e.form.method==="custom"&&Math.abs(e.totalRatio-100)>.01?(v(),C("span",at," (请调整至100%)")):R("",!0)])])):R("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])}const lt=I(qe,[["render",ot],["__scopeId","data-v-8bdec8cf"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/components/UnknownWaterDialog.vue"]]),nt={__name:"UnknownWaterAnalysisCard",props:{dateRange:{type:Array,default:()=>[]}},setup(V,{expose:t}){t();let n=k(!1),e=V,m=oe(),s=Y(),p=S(()=>m.meterLevels[0]),a=S(()=>m.meterLevels[1]),o=k(0),i=k(0),r=A();O(async()=>{e.dateRange.length&&r.currentCompany&&await y()});async function y(){try{n.value=!0;let d=await Promise.all(p.value.map(l=>X({id:l.id,start_time:e.dateRange[0],end_time:e.dateRange[1],interval:"day"}))),W=await Promise.all(a.value.map(l=>X({id:l.id,start_time:e.dateRange[0],end_time:e.dateRange[1],interval:"day"}))),z=H(d.map(l=>l.aggregated_data)).reduce((l,g)=>l+g.Value,0),q=H(W.map(l=>l.aggregated_data)).reduce((l,g)=>l+g.Value,0);i.value=z.toFixed(2),o.value=(z-q).toFixed(2)}catch(d){N(d,"获取不明水数据失败")}finally{n.value=!1}}const h=S(()=>({totalUsage:i.value,unknownUsage:o.value,distribution:s.energyUserList.filter(d=>+d.unknown_ratio).map(d=>({id:d.id,name:d.name,ratio:d.unknown_ratio*100,share:(d.unknown_ratio*o.value).toFixed(2)}))})),x=k(!1),b=k("water"),D=S(()=>(h.value.unknownUsage/h.value.totalUsage*100).toFixed(2)),w={get loading(){return n},set loading(d){n=d},get props(){return e},set props(d){e=d},get meterStore(){return m},set meterStore(d){m=d},get energyUsersStore(){return s},set energyUsersStore(d){s=d},get firstLevelMeters(){return p},set firstLevelMeters(d){p=d},get twoLevelMeters(){return a},set twoLevelMeters(d){a=d},get unknownUsage(){return o},set unknownUsage(d){o=d},get totalUsage(){return i},set totalUsage(d){i=d},get companyStore(){return r},set companyStore(d){r=d},getReportData:y,waterData:h,dialogVisible:x,currentMethod:b,percentage:D,handleDistributionConfirm:async d=>{b.value=d.method;try{n.value=!0,await Promise.all(h.value.distribution.map(W=>K({id:W.id,unknown_ratio:"0"}))),await Promise.all(d.users.map(async W=>K({id:W.id,unknown_ratio:""+W.ratio/100}))),await s.fetchEnergyUsers(),Ee.success("设置分摊规则成功")}catch(W){N(W,"设置分摊规则失败")}finally{n.value=!1,x.value=!1}},ref:k,computed:S,watchEffect:O,get getMeterReportApi(){return X},get useMeterStore(){return oe},get handleError(){return N},get processArrays(){return H},get useEnergyUsersStore(){return Y},UnknownWaterDialog:lt,get useCompanyStore(){return A},get updateEnergyUsersApi(){return K}};return Object.defineProperty(w,"__isScriptSetup",{enumerable:!1,value:!0}),w}},st={class:"scrollbar-wrapper"},it={class:"unknown-water-summary"},ut={class:"statistics-section"},ct={class:"summary-item"},dt={class:"value"},mt={class:"summary-item"},pt={class:"label"},_t={class:"value"},ft={class:"distribution-section"},vt={key:0,class:"distribution-list"},gt={class:"item-header"},yt={class:"name"},bt={class:"ratio"},ht={class:"item-details"},wt={class:"detail-row"},St={class:"value highlight"};function Ct(V,t,n,e,m,s){const p=$,a=ce,o=he,i=ue,r=Z,y=ne;return v(),C(P,null,[le((v(),T(r,{class:"unknown-water-card"},{header:f(()=>[t[5]||(t[5]=u("span",null,"不明水分摊计算",-1)),c(a,{content:"设置不明水分摊规则"},{default:f(()=>[c(p,{type:"primary",size:"small",onClick:t[0]||(t[0]=h=>e.dialogVisible=!0)},{icon:f(()=>t[3]||(t[3]=[u("img",{src:De,width:"12px",height:"auto",alt:""},null,-1)])),default:f(()=>[t[4]||(t[4]=E(" 设置分摊规则 "))]),_:1})]),_:1})]),default:f(()=>[u("div",st,[u("div",it,[u("div",ut,[u("div",ct,[t[6]||(t[6]=u("div",{class:"label"},"总用水量",-1)),u("div",dt,U(e.waterData.totalUsage)+"m³",1)]),u("div",mt,[u("div",pt,"不明水量 ("+U(e.percentage)+"%)",1),u("div",_t,U(e.waterData.unknownUsage)+"m³",1)])]),c(o),u("div",ft,[e.waterData.distribution.length?(v(),C("div",vt,[(v(!0),C(P,null,F(e.waterData.distribution,h=>(v(),C("div",{key:h.name,class:"distribution-item"},[u("div",gt,[u("span",yt,U(h.name),1),u("span",bt,"占比: "+U(h.ratio)+"%",1)]),u("div",ht,[u("div",wt,[t[7]||(t[7]=u("span",{class:"label"},"分摊水量:",-1)),u("span",St,U(h.share)+"m³",1)])])]))),128))])):(v(),T(i,{key:1,description:"未设置分摊规则","image-size":100},{default:f(()=>[c(p,{type:"primary",onClick:t[1]||(t[1]=h=>e.dialogVisible=!0)},{default:f(()=>t[8]||(t[8]=[E(" 设置规则 ")])),_:1})]),_:1}))])])])]),_:1})),[[y,e.loading]]),c(e.UnknownWaterDialog,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[2]||(t[2]=h=>e.dialogVisible=h),"current-method":e.currentMethod,onConfirm:e.handleDistributionConfirm},null,8,["modelValue","current-method"])],64)}const Ut=I(nt,[["render",Ct],["__scopeId","data-v-51e790c3"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/UnknownWaterAnalysisCard.vue"]]),Vt={__name:"WaterFilter",props:{modelValue:{type:Object,default:()=>({type:"overview",subType:""})}},emits:["update:modelValue","change"],setup(V,{expose:t,emit:n}){t();let e=Y(),m=A(),s=J();const p=V,a=n,o=k({type:p.modelValue.type,subType:p.modelValue.subType}),i=[{value:"overview",label:"总览"},{value:"byEnergyUser",label:"按用能户浏览"},{value:"byArea",label:"按区域浏览"}],r=k({byArea:S(()=>s.areas.map(w=>({value:w.id,label:w.name}))),byEnergyUser:S(()=>e.energyUserList.map(w=>({value:w.id,label:w.name})))}),y=S(()=>r.value[o.value.type]),h=S(()=>({byArea:"请选择区域",byType:"请选择用水类型",byEnergyUser:"请选择用能户"})[o.value.type]||"请选择"),x=()=>{o.value.subType="",D()},b=()=>{D()},D=()=>{a("update:modelValue",{...o.value}),a("change",{...o.value})};ae(()=>p.modelValue,w=>{o.value={...w}},{deep:!0}),O(async()=>{await e.fetchEnergyUsers({company_id:m.currentCompany.id})});const _={get energyUsersStore(){return e},set energyUsersStore(w){e=w},get companyStore(){return m},set companyStore(w){m=w},get areaStore(){return s},set areaStore(w){s=w},props:p,emit:a,filterValue:o,primaryOptions:i,subOptions:r,currentSubOptions:y,getSubTypePlaceholder:h,handleTypeChange:x,handleSubTypeChange:b,updateValue:D,get useAreaStore(){return J},get useCompanyStore(){return A},get useEnergyUsersStore(){return Y},ref:k,computed:S,watch:ae,watchEffect:O};return Object.defineProperty(_,"__isScriptSetup",{enumerable:!1,value:!0}),_}},kt={class:"filter-container"};function xt(V,t,n,e,m,s){const p=de,a=me;return v(),C("div",kt,[c(a,{modelValue:e.filterValue.type,"onUpdate:modelValue":t[0]||(t[0]=o=>e.filterValue.type=o),class:"filter-item",placeholder:"请选择浏览方式",onChange:e.handleTypeChange},{default:f(()=>[(v(),C(P,null,F(e.primaryOptions,o=>c(p,{key:o.value,label:o.label,value:o.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),e.filterValue.type!=="overview"?(v(),T(a,{key:0,modelValue:e.filterValue.subType,"onUpdate:modelValue":t[1]||(t[1]=o=>e.filterValue.subType=o),class:"filter-item",placeholder:e.getSubTypePlaceholder,onChange:e.handleSubTypeChange},{default:f(()=>[(v(!0),C(P,null,F(e.currentSubOptions,o=>(v(),T(p,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])):R("",!0)])}const Dt=I(Vt,[["render",xt],["__scopeId","data-v-de3bc69a"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/components/WaterFilter.vue"]]),Et={__name:"index",setup(V,{expose:t}){t();let n=j(),e=L(),m=A();const s=k(!1),p=k([M().startOf("month").valueOf(),M().endOf("month").valueOf()]);let a=k({type:"overview",subType:null});O(async()=>{try{let i={key:"company_id",value:m.currentCompany.id};switch(a.value.type){case"overview":i.key="company_id",i.value=m.currentCompany.id;break;case"byEnergyUser":if(a.value.subType)i.key="energy_user_id",i.value=a.value.subType;else return;break;case"byArea":if(a.value.subType)i.key="area_id",i.value=a.value.subType;else return;break;default:return}s.value=!0,await Promise.all([n.getPriceDetail({[i.key]:i.value,start_time:p.value[0],end_time:p.value[1]}),n.getLastPriceDetail({[i.key]:i.value,start_time:M(p.value[0]).subtract(1,"year").valueOf(),end_time:M(p.value[1]).subtract(1,"year").valueOf()}),e.fetchPriceRuleList({company_id:m.currentCompany.id})])}catch(i){N(i,"获取价格数据失败")}finally{s.value=!1}});const o={get priceStore(){return n},set priceStore(i){n=i},get priceRuleStore(){return e},set priceRuleStore(i){e=i},get companyStore(){return m},set companyStore(i){m=i},loading:s,dateRange:p,get filter(){return a},set filter(i){a=i},ref:k,watchEffect:O,get dayjs(){return M},StatisticsCard:Ie,WaterUsageTable:ze,UnknownWaterAnalysisCard:Ut,WaterFilter:Dt,get useCompanyStore(){return A},get handleError(){return N},get useWaterPriceStore(){return j},get usePriceRuleStore(){return L},CustomDatePicker:Re};return Object.defineProperty(o,"__isScriptSetup",{enumerable:!1,value:!0}),o}},Rt={class:"app-container"},Pt={class:"header page-title"},Wt={class:"header-left"},Tt={style:{width:"100%"}};function Mt(V,t,n,e,m,s){const p=ue,a=se,o=ie,i=ye,r=ne;return le((v(),C("div",Rt,[u("div",Pt,[u("div",Wt,[t[2]||(t[2]=E(" 用水费用概览 ")),c(e.WaterFilter,{modelValue:e.filter,"onUpdate:modelValue":t[0]||(t[0]=y=>e.filter=y)},null,8,["modelValue"])]),c(e.CustomDatePicker,{modelValue:e.dateRange,"onUpdate:modelValue":t[1]||(t[1]=y=>e.dateRange=y)},null,8,["modelValue"])]),c(i,{class:"main-container"},{default:f(()=>[u("div",Tt,[(v(),C(P,{key:1},[c(e.StatisticsCard,{class:"mb-16"}),c(o,{gutter:20,class:"mb-4"},{default:f(()=>[c(a,{span:16,style:{display:"flex","flex-direction":"column"}},{default:f(()=>[c(e.WaterUsageTable,{dateRange:e.dateRange},null,8,["dateRange"])]),_:1}),c(a,{span:8},{default:f(()=>[c(e.UnknownWaterAnalysisCard,{dateRange:e.dateRange},null,8,["dateRange"])]),_:1})]),_:1})],64))])]),_:1})])),[[r,e.loading]])}const Oa=I(Et,[["render",Mt],["__scopeId","data-v-ec2150d0"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterCost/PriceView/index.vue"]]);export{Oa as default};
