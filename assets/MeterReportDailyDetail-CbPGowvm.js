import{_ as U,r as m,F as N,w as V,o as w,j as S,c as z,d as W,e as R,k as g,l as y,f as x,Y as k,J as G,g as L,a5 as K,v as Q}from"./index-DWtISIBF.js";import{E as X}from"./button-DfREtLL_.js";import{g as j}from"./meter-BWYCtTLu.js";import{d as f}from"./dayjs.min-t3tQ4ZJg.js";import{C as Z}from"./CustomDatePicker-DTvPnXeh.js";import{_ as $}from"./导出-BMYnDY6G.js";import{E as h}from"./index-CZh1RU_w.js";import{E as B}from"./index-DYLzNb0k.js";import{E as ee}from"./popper-BNb2tGl7.js";import"./index-CuP5NVML.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DjvbDGpK.js";import"./use-form-item-CuJrx89H.js";import"./icon-Cc3ZZocH.js";import"./date-picker-B_H4_mfX.js";import"./index-CVAPKPs0.js";import"./input-B0bTKLmJ.js";import"./index-DibVzrKz.js";import"./aria-BUADUvnR.js";import"./scrollbar-BMOxp_jN.js";import"./index-CeeR5a7H.js";import"./index-DfeXTFmx.js";import"./isEqual-DqXByToB.js";import"./_Uint8Array-DaZSNKBQ.js";/* empty css             *//* empty css                 */import"./focus-trap-D8pg8SM_.js";const te={__name:"MeterReportDailyDetail",props:{currentMeter:{type:Object,required:!0}},setup(E,{expose:r}){r();const u=E,e=m([]),i=m({field:"",order:""}),b=m(!1),v=m(!1),d=m(null),n=m({currentPage:1,pageSize:10,total:0}),D=[f().subtract(2,"day").startOf("day").valueOf(),f().subtract(1,"day").endOf("day").valueOf()],p=m(D);function l(t){if(!Array.isArray(t)||t.length===0)return[];const a=t.sort((o,s)=>f(o.time).valueOf()-f(s.time).valueOf());return a.map((o,s)=>{const _=s>0?a[s-1].value:null,c=_!==null?Number(o.value)-Number(_):null;return{...o,time:f(o.time).format("MM-DD HH:mm"),usage:c!==null?c.toFixed(2):"--"}})}const H=N(()=>{let t=[...e.value];i.value.field&&i.value.order&&t.sort((s,_)=>{const c=s[i.value.field],C=_[i.value.field],O=i.value.order==="desc"?-1:1;return i.value.field==="usage"&&(c===null||C===null)?c===null?1:-1:c>C?O:-O});const a=(n.value.currentPage-1)*n.value.pageSize,o=a+n.value.pageSize;return t.slice(a,o)});V([()=>u.currentMeter,()=>p.value],async([t,a],[o,s])=>{if(!t)return;const _=!o||t.id!==o.id,c=!s||a[0]!==s[0]||a[1]!==s[1];(_||c)&&await P()});async function P(){var t;if((t=u.currentMeter)!=null&&t.id){b.value=!0,e.value=[];try{const a=await j({id:u.currentMeter.id,start_time:p.value[0].valueOf(),end_time:p.value[1].valueOf()});if(a.code===200){const o=l(a.meter_readings||[]);e.value=o,n.value.total=o.length,n.value.currentPage=1,o.length===0&&h.warning("所选时间范围内无数据")}else throw new Error(a.message||"获取数据失败")}catch(a){console.error("获取表计数据失败:",a),B({title:"请求失败",message:a.message||"服务器错误，请稍后重试",type:"error",duration:5e3})}finally{b.value=!1}}}function T({currentPage:t,pageSize:a}){n.value.currentPage=t,n.value.pageSize=a}function Y({property:t,order:a}){i.value.field=t,i.value.order=a}function A(){p.value=D,i.value={field:"",order:""},n.value.currentPage=1;const t=d.value;t==null||t.clearSort()}async function q(){var t;if(!e.value.length){h.warning("暂无数据可导出");return}try{v.value=!0;const a=d.value;await(a==null?void 0:a.exportData({filename:`${((t=u==null?void 0:u.currentMeter)==null?void 0:t.meter_code)||"未知表计"}_${f().format("YYYY-MM-DD")}_统计报表`,type:"xlsx",mode:"all",useStyle:!0,data:e.value}))}catch(a){console.error("导出失败:",a),h.error("导出失败，请重试")}finally{v.value=!1}}function F(t){return t==null||t===""?"--":Number(t).toFixed(2)}function I(t){return t?f(t).format("MM-DD HH:mm"):"--"}function J({rowIndex:t}){return(n.value.currentPage-1)*n.value.pageSize+t+1}w(()=>{u.currentMeter&&P()});const M={props:u,tableData:e,sortConfig:i,isLoading:b,isExporting:v,tableRef:d,pageVO:n,defautTimeRange:D,dateRange:p,processData:l,currentPageData:H,fetchMeterList:P,handlePageChange:T,handleSortChange:Y,handleReset:A,handleExport:q,formatNumber:F,formatDate:I,getSerialNumber:J,ref:m,onMounted:w,watch:V,computed:N,get ElNotification(){return B},get ElMessage(){return h},get ElTooltip(){return ee},get getMeterDetailApi(){return j},get dayjs(){return f},CustomDatePicker:Z};return Object.defineProperty(M,"__isScriptSetup",{enumerable:!1,value:!0}),M}},ae={class:"table-container"},re={class:"filter-container"};function oe(E,r,u,e,i,b){const v=X,d=S("vxe-column"),n=S("vxe-table"),D=S("vxe-pager"),p=Q;return z(),W("div",ae,[R("div",re,[g(e.CustomDatePicker,{modelValue:e.dateRange,"onUpdate:modelValue":r[0]||(r[0]=l=>e.dateRange=l),"max-days":4,disabled:e.isLoading},null,8,["modelValue","disabled"]),g(v,{onClick:e.handleReset,type:"danger",disabled:e.isLoading},{default:y(()=>r[3]||(r[3]=[x("重置")])),_:1},8,["disabled"]),g(v,{style:{"margin-left":"auto"},loading:e.isExporting,disabled:e.isExporting||e.isLoading||!e.tableData.length,onClick:e.handleExport,type:"success"},{icon:y(()=>r[4]||(r[4]=[R("img",{src:$,width:"14",height:"14",alt:"",srcset:""},null,-1)])),default:y(()=>[r[5]||(r[5]=x(" 导出 "))]),_:1},8,["loading","disabled"])]),k((z(),G(n,{align:"center",ref:"tableRef",data:e.currentPageData,"empty-text":e.isLoading?"加载中...":"暂无数据",onSortChange:e.handleSortChange},{default:y(()=>[g(d,{type:"seq",width:"70","seq-method":e.getSerialNumber}),g(d,{sortable:"",field:"value",title:"读数"},{default:y(({row:l})=>[x(L(e.formatNumber(l.value)),1)]),_:1}),g(d,{sortable:"",field:"usage",title:"流量"}),g(d,{sortable:"",field:"time",title:"时间"},{default:y(({row:l})=>[x(L(e.formatDate(l.time)),1)]),_:1})]),_:1},8,["data","empty-text"])),[[p,e.isLoading]]),k(g(D,{currentPage:e.pageVO.currentPage,"onUpdate:currentPage":r[1]||(r[1]=l=>e.pageVO.currentPage=l),pageSize:e.pageVO.pageSize,"onUpdate:pageSize":r[2]||(r[2]=l=>e.pageVO.pageSize=l),total:e.pageVO.total,layouts:["Home","PrevJump","PrevPage","Number","NextPage","NextJump","End","Sizes","Total"],onPageChange:e.handlePageChange},null,8,["currentPage","pageSize","total"]),[[K,e.tableData.length>0]])])}const ze=U(te,[["render",oe],["__scopeId","data-v-93c43144"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/WaterData/WaterDataCenter/DailyReport/components/MeterReportDailyDetail.vue"]]);export{ze as default};
