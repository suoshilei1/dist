import{_ as J,r as m,a as S,F as b,w as C,o as k,j as D,c as _,d as A,e as B,k as a,l as c,f as g,Y,J as L,g as h,U as G,V as H,v as K}from"./index-DWtISIBF.js";import{E as Q}from"./button-DfREtLL_.js";import{d as v}from"./dayjs.min-t3tQ4ZJg.js";import{u as N,a as O,b as P,t as T,f as W,d as X}from"./meter-BWYCtTLu.js";import{C as Z}from"./CustomDatePicker-DTvPnXeh.js";import{u as j}from"./area-CDc72icr.js";/* empty css             *//* empty css                        */import{E}from"./index-DYLzNb0k.js";import"./index-CuP5NVML.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DjvbDGpK.js";import"./use-form-item-CuJrx89H.js";import"./icon-Cc3ZZocH.js";import"./date-picker-B_H4_mfX.js";import"./popper-BNb2tGl7.js";import"./index-CVAPKPs0.js";import"./aria-BUADUvnR.js";import"./focus-trap-D8pg8SM_.js";import"./input-B0bTKLmJ.js";import"./index-DibVzrKz.js";import"./scrollbar-BMOxp_jN.js";import"./index-CeeR5a7H.js";import"./index-DfeXTFmx.js";import"./isEqual-DqXByToB.js";import"./_Uint8Array-DaZSNKBQ.js";/* empty css                 */import"./index-CZh1RU_w.js";const I={__name:"index",setup(U,{expose:s}){s();const n=N(),t=j(),w=m(null),u=m([v().startOf("year").valueOf(),v().endOf("year").valueOf()]),y={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"电表月统计报表",sheetName:"表计报表",modes:["current"]},o=m([]),f=m(!1),p=m(!1),x=S({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:e})=>V(e)}),d=b(()=>O(u.value[0],u.value[1],"month"));async function i(){if(!f.value)try{o.value=[],f.value=!0;const e=n.treeDataForChart.map(R=>l(R)),r=await Promise.all(e);o.value=r.filter(Boolean)}catch(e){E({type:"error",title:"Error",message:e.message||"获取电表数据失败"}),console.error("Failed to fetch meter report:",e)}finally{f.value=!1}}async function l(e){try{const r=await P({id:e.id,start_time:u.value[0],end_time:v(u.value[1]).valueOf(),interval:"month"});return T(e,r)}catch(r){return E({type:"error",title:"Error",message:r.message||"获取电表数据失败"}),console.error(`Failed to fetch data for meter ${e.meter_code}:`,r),null}}const F=m(!1);async function V(e){try{const r=e.customChildren.map(z=>l(z));return(await Promise.all(r)).filter(Boolean)}catch(r){return E({type:"error",title:"Error",message:r.message||"获取电表数据失败"}),console.error("Failed to load child nodes:",r),[]}}async function q(){try{p.value=!0;const e=w.value;for(let r=0;r<n.meterLevels.length;r++)await(e==null?void 0:e.setAllTreeExpand(!0));await(e==null?void 0:e.openExport({includeFooter:!0}))}finally{p.value=!1}}C([()=>u.value,()=>n.treeDataForChart],()=>{i()},{deep:!0}),C([()=>F.value],()=>{i()},{deep:!0}),k(async()=>{(!n.treeDataForChart.length||n.currentSelectedType!==2)&&(n.setCurrentSelectedType(2),await n.fetchMeterList()),i()});const M={meterStore:n,areaStore:t,tableRef:w,dateRange:u,exportConfig:y,meterTableData:o,isLoading:f,isExporting:p,treeConfig:x,dateColumns:d,fetchMeterReport:i,fetchAndProcessMeterData:l,showUnknownRate:F,loadChildNodes:V,handleExport:q,ref:m,onMounted:k,watch:C,computed:b,reactive:S,get dayjs(){return v},get getMeterReportApi(){return P},CustomDatePicker:Z,get useMeterStore(){return N},get useAreaStore(){return j},get formatFlowValue(){return W},get formatReadingValue(){return X},get generateDateColumns(){return O},get transformMeterData(){return T}};return Object.defineProperty(M,"__isScriptSetup",{enumerable:!1,value:!0}),M}},$={class:"meter-report-container"},ee={class:"meter-report-header"};function te(U,s,n,t,w,u){const y=Q,o=D("vxe-column"),f=D("vxe-colgroup"),p=D("vxe-table"),x=K;return _(),A("div",$,[B("div",ee,[a(t.CustomDatePicker,{maxDays:365*2,border:"","is-month-picker":!0,round:"",modelValue:t.dateRange,"onUpdate:modelValue":s[0]||(s[0]=d=>t.dateRange=d)},null,8,["modelValue"]),a(y,{style:{"margin-left":"auto"},type:"success",loading:t.isExporting,onClick:t.handleExport},{icon:c(()=>s[1]||(s[1]=[B("i",{class:"fa fa-download"},null,-1)])),default:c(()=>[s[2]||(s[2]=g(" 导出 "))]),_:1},8,["loading"])]),Y((_(),L(p,{ref:"tableRef",height:"92%",border:"",align:"center",data:t.meterTableData,"tree-config":t.treeConfig,"export-config":t.exportConfig},{default:c(()=>[a(o,{type:"seq",width:"60"}),a(o,{fixed:"left","tree-node":"",field:"meter_code",title:"表计编号",width:"120"}),a(o,{width:"100","show-overflow":"tooltip",title:"所供区域"},{default:c(({row:d})=>[g(h(t.areaStore.getAreaNameById(d.area_id)||"-"),1)]),_:1}),a(o,{width:"120","show-overflow":"tooltip",field:"installation_location",title:"安装位置"}),a(o,{field:"specification",width:"100",title:"规格"}),a(o,{width:"100",field:"startReading",title:"启读数"}),(_(!0),A(G,null,H(t.dateColumns,(d,i)=>(_(),L(f,{key:d,title:d},{default:c(()=>[a(o,{width:"100",field:`usage_${i}`,title:"用量"},{default:c(({row:l})=>[g(h(t.formatFlowValue(l[`usage_${i}`])),1)]),footer:c(({row:l})=>[g(h(t.formatFlowValue(l[`usage_${i}`])),1)]),_:2},1032,["field"]),a(o,{width:"100",field:`reading_${i}`,title:"读数"},{default:c(({row:l})=>[g(h(t.formatReadingValue(l[`reading_${i}`])),1)]),_:2},1032,["field"])]),_:2},1032,["title"]))),128)),a(o,{fixed:"right",field:"sum",width:"100",title:"总用量"})]),_:1},8,["data","tree-config"])),[[x,t.isLoading]])])}const ke=J(I,[["render",te],["__scopeId","data-v-7fc1359d"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/ElectricityData/IntelligentMeter/AnnualMeter/index.vue"]]);export{ke as default};
