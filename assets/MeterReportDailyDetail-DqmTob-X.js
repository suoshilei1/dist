import{F as P,r as g,T as X,_ as Z,w as ee,o as te,m as V,c as v,d as x,e as I,i as h,j as w,U as L,V as k,I as z,J as M,ah as ae,f as T,Y as q,a2 as re,v as oe}from"./index-Bx6Y8L80.js";import{E as le}from"./button-8bviUT_H.js";/* empty css            */import{E as ue,b as ne,a as ie}from"./select-BmMHn9PT.js";import"./scrollbar-DuXO1tWo.js";import"./popper-DBn8ulUn.js";import{u as se,g as pe}from"./meter-5sbrBbgq.js";import{d as y}from"./dayjs.min-Cd48fqZ9.js";import{C as ce}from"./CustomDatePicker-CX6MdPmZ.js";/* empty css             *//* empty css                 *//* empty css                        */import{E as B}from"./index-KJp6TXG9.js";import{E as de}from"./index-CWCMyxJA.js";import"./index-A4BGBRGh.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-AkNVqhGZ.js";import"./use-form-item-50hJ8Ppj.js";import"./icon-6zrsquxY.js";import"./index-aFn2MKle.js";import"./castArray-CrUPC_Z8.js";import"./index-CuyxIfpa.js";import"./index-iw6eP590.js";import"./aria-BUADUvnR.js";import"./scroll-BawlEUY1.js";import"./isEqual-BM-Gj-iT.js";import"./_Uint8Array-B6mJ0Xm4.js";import"./_baseIteratee-CkjM3wkz.js";import"./index-zrRcpBp4.js";import"./focus-trap-Ddg061Nm.js";import"./date-picker-CfUXe-Kp.js";import"./input-CFaQgGx5.js";import"./index-DLcTS03G.js";const F=[{prop:"time",label:"时间",width:"auto",group:"基础信息",required:!0},{prop:"value",label:"读数",width:"auto",group:"基础信息"},{prop:"usage",label:"用量",width:"auto",group:"基础信息"}],ge=[{prop:"voltage_a",label:"A相电压",width:"auto",group:"电压"},{prop:"voltage_b",label:"B相电压",width:"auto",group:"电压"},{prop:"voltage_c",label:"C相电压",width:"auto",group:"电压"},{prop:"voltage_ab",label:"AB线电压",width:"auto",group:"电压"},{prop:"voltage_bc",label:"BC线电压",width:"auto",group:"电压"},{prop:"voltage_ac",label:"AC线电压",width:"auto",group:"电压"},{prop:"current_a",label:"A相电流",width:"auto",group:"电流"},{prop:"current_b",label:"B相电流",width:"auto",group:"电流"},{prop:"current_c",label:"C相电流",width:"auto",group:"电流"},{prop:"leakage",label:"漏电流",width:"auto",group:"电流"},{prop:"active_power_t",label:"总有功功率",width:"auto",group:"功率"},{prop:"deactivate_power_t",label:"总无功功率",width:"auto",group:"功率"},{prop:"sight_power_t",label:"总视在功率",width:"auto",group:"功率"},{prop:"active_total_power_t",label:"总有功电能",width:"auto",group:"电能"},{prop:"deactive_total_power_t",label:"总无功电能",width:"auto",group:"电能"},{prop:"sight_total_power_t",label:"总视在电能",width:"auto",group:"电能"},{prop:"power_factor",label:"功率因数",width:"auto",group:"其他"},{prop:"frequency",label:"频率",width:"auto",group:"其他"}],U=["time","value","usage"],me=["voltage_a","voltage_b","voltage_c","current_a","current_b","current_c","active_power_t","deactivate_power_t"],ve=se(),fe=P(()=>{var s;return((s=ve.currentMeter)==null?void 0:s.type)===2});function _e(){const s=g([...U]),l=g([]),p=P(()=>{const c={};return l.value.forEach(d=>{c[d.group]||(c[d.group]=[]),c[d.group].push({label:d.label,value:d.prop})}),Object.entries(c).map(([d,D])=>({label:d,options:D}))}),n=P(()=>l.value.filter(c=>s.value.includes(c.prop)||c.required)),f=()=>{fe.value?(s.value=[...U,...me],l.value=[...F,...ge]):(s.value=[...U],l.value=[...F])};return X(f),{selectedColumns:s,columnGroups:p,visibleColumns:n,columnReset:f}}const be={class:"table-container"},he={class:"filter-container"},we={__name:"MeterReportDailyDetail",props:{currentMeter:{type:Object,required:!0}},setup(s){const l=s,p=g([]),n=g({field:"",order:""});let{selectedColumns:f,columnGroups:c,visibleColumns:d,columnReset:D}=_e();const _=g(!1),S=g(!1),O=g(null),o=g({currentPage:1,pageSize:10,total:0}),A=[y().subtract(2,"day").startOf("day").valueOf(),y().subtract(1,"day").endOf("day").valueOf()],b=g(A);function Y(t){if(!Array.isArray(t)||t.length===0)return[];const e=t.sort((a,u)=>y(a.time).valueOf()-y(u.time).valueOf());return e.map((a,u)=>{const m=u>0?e[u-1].value:null,i=m!==null?Number(a.value)-Number(m):null;return{...a,time:y(a.time).format("MM-DD HH:mm"),usage:i!==null?i.toFixed(2):"--"}})}const j=P(()=>{let t=[...p.value];n.value.field&&n.value.order&&t.sort((u,m)=>{const i=u[n.value.field],C=m[n.value.field],E=n.value.order==="desc"?-1:1;return n.value.field==="usage"&&(i===null||C===null)?i===null?1:-1:i>C?E:-E});const e=(o.value.currentPage-1)*o.value.pageSize,a=e+o.value.pageSize;return t.slice(e,a)});ee([()=>l.currentMeter,()=>b.value],async([t,e],[a,u])=>{if(!t)return;const m=!a||t.id!==a.id,i=!u||e[0]!==u[0]||e[1]!==u[1];(m||i)&&await R()});async function R(){var t;if((t=l.currentMeter)!=null&&t.id){_.value=!0,p.value=[];try{const e=await pe({id:l.currentMeter.id,start_time:b.value[0].valueOf(),end_time:b.value[1].valueOf()});if(e.code===200){const a=Y(e.meter_readings||[]);console.log("processedData:",a),p.value=a,o.value.total=a.length,o.value.currentPage=1,a.length===0&&B.warning("所选时间范围内无数据")}else throw new Error(e.message||"获取数据失败")}catch(e){console.error("获取表计数据失败:",e),de({title:"请求失败",message:e.message||"服务器错误，请稍后重试",type:"error",duration:5e3})}finally{_.value=!1}}}function G({currentPage:t,pageSize:e}){o.value.currentPage=t,o.value.pageSize=e}function H({property:t,order:e}){n.value.field=t,n.value.order=e}function J(){b.value=A,n.value={field:"",order:""},o.value.currentPage=1;const t=O.value;t==null||t.clearSort(),D()}async function $(){var t;if(!p.value.length){B.warning("暂无数据可导出");return}try{S.value=!0;const e=O.value;await(e==null?void 0:e.exportData({filename:`${((t=l==null?void 0:l.currentMeter)==null?void 0:t.meter_code)||"未知表计"}_${y().format("YYYY-MM-DD")}_统计报表`,type:"xlsx",mode:"all",useStyle:!0,data:p.value}))}catch(e){console.error("导出失败:",e),B.error("导出失败，请重试")}finally{S.value=!1}}function K({rowIndex:t}){return(o.value.currentPage-1)*o.value.pageSize+t+1}return te(()=>{l.currentMeter&&R()}),(t,e)=>{const a=ue,u=ne,m=ie,i=le,C=V("vxe-column"),E=V("vxe-table"),Q=V("vxe-pager"),W=oe;return v(),x("div",be,[I("div",he,[h(ce,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=r=>b.value=r),"max-days":4,disabled:_.value},null,8,["modelValue","disabled"]),h(m,{multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":2,modelValue:z(f),"onUpdate:modelValue":e[1]||(e[1]=r=>ae(f)?f.value=r:f=r),placeholder:"Select",style:{width:"13.5rem","margin-right":"1rem"}},{default:w(()=>[(v(!0),x(L,null,k(z(c),r=>(v(),M(u,{key:r.label,label:r.label},{default:w(()=>[(v(!0),x(L,null,k(r.options,N=>(v(),M(a,{key:N.value,label:N.label,value:N.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]),h(i,{onClick:J,type:"danger",disabled:_.value},{default:w(()=>e[4]||(e[4]=[T("重置")])),_:1},8,["disabled"]),h(i,{style:{"margin-left":"auto"},loading:S.value,disabled:S.value||_.value||!p.value.length,onClick:$,type:"success"},{icon:w(()=>e[5]||(e[5]=[I("i",{class:"fa fa-download"},null,-1)])),default:w(()=>[e[6]||(e[6]=T(" 导出 "))]),_:1},8,["loading","disabled"])]),q((v(),M(E,{align:"center",ref_key:"tableRef",ref:O,data:j.value,"empty-text":_.value?"加载中...":"暂无数据",onSortChange:H},{default:w(()=>[h(C,{type:"seq",width:"70","seq-method":K}),(v(!0),x(L,null,k(z(d),r=>(v(),M(C,{key:r.prop,field:r.prop,title:r.label,sortable:""},null,8,["field","title"]))),128))]),_:1},8,["data","empty-text"])),[[W,_.value]]),q(h(Q,{currentPage:o.value.currentPage,"onUpdate:currentPage":e[2]||(e[2]=r=>o.value.currentPage=r),pageSize:o.value.pageSize,"onUpdate:pageSize":e[3]||(e[3]=r=>o.value.pageSize=r),total:o.value.total,layouts:["Home","PrevJump","PrevPage","Number","NextPage","NextJump","End","Sizes","Total"],onPageChange:G},null,8,["currentPage","pageSize","total"]),[[re,p.value.length>0]])])}}},et=Z(we,[["__scopeId","data-v-9ef32683"]]);export{et as default};
