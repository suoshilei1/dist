import{_ as N,r as c,F as L,a as T,w as A,o as R,m as w,c as D,d as Y,e as E,i as o,j as u,f as h,X as j,J as H,g as F,I as M,v as I}from"./index-oALI6hjD.js";import{E as P}from"./button-CW4VZptJ.js";import{d as n}from"./dayjs.min-VPOC9PSa.js";import{C as $}from"./CustomDatePicker-BcsvcsJp.js";import{u as q,f as z,g as V,m as b}from"./meter-GWsXRyue.js";import{E as m}from"./index-BFWR71cx.js";import"./index-DXOgsKzf.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-GdZBC0LW.js";import"./use-form-item-CJ5jT23N.js";import"./icon-DFUaFmZd.js";import"./date-picker-DSsGajNu.js";import"./popper-8tqvLSZz.js";import"./index-Ci2yyUHC.js";import"./aria-BUADUvnR.js";import"./focus-trap-B9jhWFgs.js";import"./input-_j8YarB1.js";import"./index-BTnVmvBQ.js";import"./scrollbar-BwLVa3O8.js";import"./index-Civq4TP6.js";import"./index-CPa7yTdP.js";import"./isEqual-DERyOhzh.js";import"./_Uint8Array-Cyhry7Ym.js";/* empty css             *//* empty css                 */import"./index-CV7ElbEQ.js";const J={class:"meter-report-container"},U={class:"meter-report-header"},X={__name:"index",setup(G){const i=q(),g=c(null),s=c(n().subtract(1,"day")),_=L(()=>{const e=n(s.value).startOf("day").valueOf(),t=n(s.value).endOf("day").valueOf();return[e,t]}),O={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"电表日抄表记录",sheetName:"表计报表",modes:["current"]},v=c([]),f=c(!1),y=c(!1),B=T({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:e})=>S(e)});async function x(){if(!f.value)try{v.value=[],f.value=!0;let e=await C(i.treeDataForChart);v.value=e.filter(Boolean);const t=g.value}catch(e){m({type:"error",title:"Error",message:e.message||"获取电表数据失败"}),console.error("Failed to fetch meter report:",e)}finally{f.value=!1}}async function C(e){const t=e.map(r=>r.id).toString();try{let r=await V({id:`[${t}]`,start_time:_.value[0],end_time:_.value[1]});if(r.code!==200)return console.error("Failed to fetch meter detail:",error),m({type:"error",title:"Error",message:error.message||"获取电表数据失败"}),[];let a=b(e,r.meter_readings,"current_reading",!0),p=await V({id:`[${t}]`,start_time:n(s.value).subtract(1,"day").startOf("day").valueOf(),end_time:n(s.value).subtract(1,"day").endOf("day").valueOf()});return p.code!==200?(console.error("Failed to fetch meter detail:",error),m({type:"error",title:"Error",message:error.message||"获取电表数据失败"}),[]):b(a,p.meter_readings,"yesterday_reading").map(l=>({...l,Value:l.current_reading-l.yesterday_reading,hasChild:l.children.length>0,customChild:l.children}))}catch(r){console.error("Failed to fetch meter detail:",r),m({type:"error",title:"Error",message:r.message||"获取电表数据失败"})}}async function S(e){try{return(await C(e.customChild)).filter(Boolean)}catch(t){return m({type:"error",title:"Error",message:t.message||"获取电表数据失败"}),console.error("Failed to load child nodes:",t),[]}}async function k(){try{y.value=!0;const e=g.value;for(let t=0;t<i.meterLevels.length;t++)await(e==null?void 0:e.setAllTreeExpand(!0));await(e==null?void 0:e.openExport({includeFooter:!0}))}finally{y.value=!1}}return A([()=>_.value,()=>i.treeDataForChart],()=>{x()},{deep:!0}),R(async()=>{(!i.treeDataForChart.length||i.currentSelectedType!==2)&&(i.setCurrentSelectedType(2),await i.fetchMeterList()),x()}),(e,t)=>{const r=P,a=w("vxe-column"),p=w("vxe-table"),l=I;return D(),Y("div",J,[E("div",U,[o($,{border:"",isRange:!1,modelValue:s.value,"onUpdate:modelValue":t[0]||(t[0]=d=>s.value=d)},null,8,["modelValue"]),o(r,{style:{"margin-left":"auto"},type:"success",loading:y.value,onClick:k},{icon:u(()=>t[1]||(t[1]=[E("i",{class:"fa fa-download"},null,-1)])),default:u(()=>[t[2]||(t[2]=h(" 导出 "))]),_:1},8,["loading"])]),j((D(),H(p,{ref_key:"tableRef",ref:g,height:"92%",border:"",align:"center",data:v.value,"tree-config":B,"export-config":O},{default:u(()=>[o(a,{fixed:"left",type:"seq"}),o(a,{"tree-node":"",fixed:"left",field:"meter_code",title:"编号"}),o(a,{fixed:"left",field:"id",title:"表号"}),o(a,{field:"specification",title:"规格"}),o(a,{field:"yesterday_reading",title:"上次读数"}),o(a,{field:"current_reading",title:"本次读数"}),o(a,{field:"current_reading_time",title:"时间"},{default:u(({row:d})=>[h(F(M(n)(d.current_reading_time).format("YYYY/MM/DD HH:mm:ss")),1)]),_:1}),o(a,{fixed:"right",field:"Value",title:"用量"},{default:u(({row:d})=>[h(F(M(z)(d.Value)),1)]),_:1})]),_:1},8,["data","tree-config"])),[[l,f.value]])])}}},we=N(X,[["__scopeId","data-v-8a1963f8"]]);export{we as default};
