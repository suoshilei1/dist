import{_ as T,r as d,F as O,w,o as z,j as D,c as R,d as U,e as N,k as u,l as b,f as k,X as L,J as A,a4 as F,v as H}from"./index-DU5BV6sj.js";import{E as X}from"./button-C3fNXQ0E.js";import{b as j}from"./meter-CawyXifQ.js";import{d as p}from"./dayjs.min-BzhD8rH5.js";import{C as G}from"./CustomDatePicker-DwR5Ke4u.js";/* empty css             *//* empty css                 *//* empty css                        */import{E as P}from"./index-BmwD9m8C.js";import{E as K}from"./index-BjNTkPPk.js";import"./index-BCql8Cu-.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-HfsxB2KS.js";import"./use-form-item-Bwue1zaK.js";import"./icon-Lrcg122U.js";import"./date-picker-3aSnRp6y.js";import"./popper-DmsXjoSL.js";import"./index-imETKNmt.js";import"./aria-BUADUvnR.js";import"./focus-trap-BFH-jL9N.js";import"./input-Cag95VNY.js";import"./index-DsemQHVw.js";import"./scrollbar-5YYltO8z.js";import"./index-BcLR6-Z9.js";import"./index-BRz9a87F.js";import"./isEqual-Df5tNRy_.js";import"./_Uint8Array-ntTh0Oyk.js";const Q={__name:"MeterReportDaily",props:{currentMeter:{type:Object,required:!0}},setup(S,{expose:r}){r();const i=S,e=d([]),l=d({field:"",order:""}),y=d(!1),m=d(!1),s=d(null),o=d({currentPage:1,pageSize:10,total:0}),f=[p().startOf("month").valueOf(),p().endOf("month").valueOf()],c=d(f),g=O(()=>{let t=[...e.value];l.value.field&&l.value.order&&t.sort((v,h)=>{const _=v[l.value.field],M=h[l.value.field],V=l.value.order==="desc"?-1:1;return l.value.field==="usage"&&(_===null||M===null)?_===null?1:-1:_>M?V:-V});const a=(o.value.currentPage-1)*o.value.pageSize,n=a+o.value.pageSize;return t.slice(a,n)});w([()=>i.currentMeter,()=>c.value],async([t,a],[n,v])=>{if(!t)return;const h=!n||t.id!==n.id,_=!v||a[0]!==v[0]||a[1]!==v[1];(h||_)&&await x()});function C(t){return t.map(n=>({...n,end:n.end,Value:n.Value,start_time:p(n.start_time).format("MM-DD")}))}async function x(){var t;if((t=i.currentMeter)!=null&&t.id){y.value=!0,e.value=[];try{const a=await j({id:i.currentMeter.id,start_time:c.value[0].valueOf(),end_time:p(c.value[1]).add(1,"day").endOf("day").valueOf(),interval:"day"});if(a.code===200){const n=C(a.aggregated_data);e.value=n,o.value.total=n.length,o.value.currentPage=1,n.length===0&&P.warning("所选时间范围内无数据")}else throw new Error(a.message||"获取数据失败")}catch(a){console.error("获取表计数据失败:",a),K({title:"请求失败",message:a.message||"服务器错误，请稍后重试",type:"error",duration:5e3})}finally{y.value=!1}}}function B({currentPage:t,pageSize:a}){o.value.currentPage=t,o.value.pageSize=a}function Y({property:t,order:a}){l.value.field=t,l.value.order=a}function q(){c.value=f,l.value={field:"",order:""},o.value.currentPage=1;const t=s.value;t==null||t.clearSort()}async function I(){var t;if(!e.value.length){P.warning("暂无数据可导出");return}try{m.value=!0;const a=s.value;await(a==null?void 0:a.exportData({filename:`${((t=i==null?void 0:i.currentMeter)==null?void 0:t.meter_code)||"未知表计"}_${p().format("YYYY-MM-DD")}_统计报表`,type:"xlsx",mode:"all",useStyle:!0,data:e.value}))}catch(a){console.error("导出失败:",a),P.error("导出失败，请重试")}finally{m.value=!1}}function J({rowIndex:t}){return(o.value.currentPage-1)*o.value.pageSize+t+1}z(()=>{i.currentMeter&&x()});const E={props:i,tableData:e,sortConfig:l,isLoading:y,isExporting:m,tableRef:s,pageVO:o,defautTimeRange:f,dateRange:c,currentPageData:g,processMeterData:C,fetchMeterList:x,handlePageChange:B,handleSortChange:Y,handleReset:q,handleExport:I,getSerialNumber:J,ref:d,onMounted:z,watch:w,computed:O,get getMeterReportApi(){return j},get dayjs(){return p},CustomDatePicker:G};return Object.defineProperty(E,"__isScriptSetup",{enumerable:!1,value:!0}),E}},W={class:"table-container"},Z={class:"filter-container"};function $(S,r,i,e,l,y){const m=X,s=D("vxe-column"),o=D("vxe-table"),f=D("vxe-pager"),c=H;return R(),U("div",W,[N("div",Z,[u(e.CustomDatePicker,{modelValue:e.dateRange,"onUpdate:modelValue":r[0]||(r[0]=g=>e.dateRange=g),disabled:e.isLoading},null,8,["modelValue","disabled"]),u(m,{onClick:e.handleReset,type:"danger",disabled:e.isLoading},{default:b(()=>r[3]||(r[3]=[k("重置")])),_:1},8,["disabled"]),u(m,{style:{"margin-left":"auto"},loading:e.isExporting,disabled:e.isExporting||e.isLoading||!e.tableData.length,onClick:e.handleExport,type:"success"},{icon:b(()=>r[4]||(r[4]=[N("i",{class:"fa fa-download"},null,-1)])),default:b(()=>[r[5]||(r[5]=k(" 导出 "))]),_:1},8,["loading","disabled"])]),L((R(),A(o,{align:"center",ref:"tableRef",data:e.currentPageData,"empty-text":e.isLoading?"加载中...":"暂无数据",onSortChange:e.handleSortChange},{default:b(()=>[u(s,{type:"seq",width:"70","seq-method":e.getSerialNumber}),u(s,{sortable:"",field:"end",title:"读数"}),u(s,{sortable:"",field:"Value",title:"用量"}),u(s,{sortable:"",field:"start_time",title:"时间"})]),_:1},8,["data","empty-text"])),[[c,e.isLoading]]),L(u(f,{currentPage:e.pageVO.currentPage,"onUpdate:currentPage":r[1]||(r[1]=g=>e.pageVO.currentPage=g),pageSize:e.pageVO.pageSize,"onUpdate:pageSize":r[2]||(r[2]=g=>e.pageVO.pageSize=g),total:e.pageVO.total,layouts:["Home","PrevJump","PrevPage","Number","NextPage","NextJump","End","Sizes","Total"],onPageChange:e.handlePageChange},null,8,["currentPage","pageSize","total"]),[[F,e.tableData.length>0]])])}const Me=T(Q,[["render",$],["__scopeId","data-v-21d6117b"],["__file","D:/临时存放/green-carbon-1.0/src/views/EnergyData/ElectricityData/ElectricityDataCenter/DailyReport/components/MeterReportDaily.vue"]]);export{Me as default};
