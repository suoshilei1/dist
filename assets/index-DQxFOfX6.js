import{z as _e,cD as be,D as re,aX as Fe,E as we,r as f,F as L,c,J as M,l as s,Y as se,e as d,N as x,I as g,K as ke,h as U,d as E,M as G,f as b,g as A,U as B,k as a,a5 as Ce,bp as Ee,O as Ve,_ as ne,ak as Q,W as j,w as H,o as q,V as J,s as Z,v as Se}from"./index-DWtISIBF.js";import{E as ie}from"./drawer-DN31UUQo.js";import"./overlay-BY0G5ok6.js";import{E as ue,a as me}from"./form-item-ijUMtc9_.js";import{E as Te}from"./date-picker-B_H4_mfX.js";import{E as Me}from"./input-B0bTKLmJ.js";import"./scrollbar-BMOxp_jN.js";import"./popper-BNb2tGl7.js";import{E as de}from"./button-DfREtLL_.js";import{E as ce,a as pe}from"./table-column-Dde1JUzt.js";import"./checkbox-BzIrpOFw.js";/* empty css                *//* empty css            */import{E as De,a as Ae}from"./select-DYqyOwb9.js";import{g as W,a as $,e as ee,d as te,c as le}from"./formula-HQf-IMJj.js";import{s as he,u as Ie}from"./constants-NVab_QuI.js";import{e as ae}from"./meter-BWYCtTLu.js";/* empty css             *//* empty css                 *//* empty css                        */import{E as F}from"./index-CZh1RU_w.js";import{E as fe}from"./index-DYLzNb0k.js";import{d as O}from"./dayjs.min-t3tQ4ZJg.js";/* empty css                   */import{E as oe}from"./index-CuP5NVML.js";import{T as ge,a as xe}from"./icon-Cc3ZZocH.js";import{_ as Pe}from"./plugin-vue_export-helper-CqGSI99y.js";import{E as Oe}from"./index-BTG_XGfc.js";import"./index-DxRU3L2W.js";import"./scroll-DMdoCUCr.js";import"./vnode-BIvhTfyw.js";import"./index-DjvbDGpK.js";import"./focus-trap-D8pg8SM_.js";import"./aria-BUADUvnR.js";import"./index-CVAPKPs0.js";import"./use-form-item-CuJrx89H.js";import"./castArray-6TPyo715.js";import"./_Uint8Array-DaZSNKBQ.js";import"./_initCloneObject-ChNElRpx.js";import"./index-CeeR5a7H.js";import"./index-DfeXTFmx.js";import"./index-DibVzrKz.js";import"./isEqual-DqXByToB.js";import"./_baseIteratee-FAqII4j1.js";import"./index-0A8HTOTd.js";import"./validator-CunO4hgy.js";const Ue=["light","dark"],Le=_e({title:{type:String,default:""},description:{type:String,default:""},type:{type:String,values:be(ge),default:"info"},closable:{type:Boolean,default:!0},closeText:{type:String,default:""},showIcon:Boolean,center:Boolean,effect:{type:String,values:Ue,default:"light"}}),Be={close:D=>D instanceof MouseEvent},Ne=re({name:"ElAlert"}),Ye=re({...Ne,props:Le,emits:Be,setup(D,{emit:t}){const w=D,{Close:e}=xe,k=Fe(),n=we("alert"),m=f(!0),i=L(()=>ge[w.type]),p=L(()=>[n.e("icon"),{[n.is("big")]:!!w.description||!!k.default}]),u=L(()=>({"with-description":w.description||k.default})),v=o=>{m.value=!1,t("close",o)};return(o,T)=>(c(),M(Ee,{name:g(n).b("fade"),persisted:""},{default:s(()=>[se(d("div",{class:x([g(n).b(),g(n).m(o.type),g(n).is("center",o.center),g(n).is(o.effect)]),role:"alert"},[o.showIcon&&g(i)?(c(),M(g(oe),{key:0,class:x(g(p))},{default:s(()=>[(c(),M(ke(g(i))))]),_:1},8,["class"])):U("v-if",!0),d("div",{class:x(g(n).e("content"))},[o.title||o.$slots.title?(c(),E("span",{key:0,class:x([g(n).e("title"),g(u)])},[G(o.$slots,"title",{},()=>[b(A(o.title),1)])],2)):U("v-if",!0),o.$slots.default||o.description?(c(),E("p",{key:1,class:x(g(n).e("description"))},[G(o.$slots,"default",{},()=>[b(A(o.description),1)])],2)):U("v-if",!0),o.closable?(c(),E(B,{key:2},[o.closeText?(c(),E("div",{key:0,class:x([g(n).e("close-btn"),g(n).is("customed")]),onClick:v},A(o.closeText),3)):(c(),M(g(oe),{key:1,class:x(g(n).e("close-btn")),onClick:v},{default:s(()=>[a(g(e))]),_:1},8,["class"]))],64)):U("v-if",!0)],2)],2),[[Ce,m.value]])]),_:3},8,["name"]))}});var Re=Pe(Ye,[["__file","alert.vue"]]);const ze=Ve(Re),je={__name:"setFormula",props:{formulaOptions:{type:Array,default:()=>[]}},emits:["update-formula"],setup(D,{expose:t,emit:w}){const e=w,k=D,n=f(null),m=f(null),i=f(!1),p=f(!1),{currentCompany:u}=Q(j()),v={name:[{required:!0,message:"请输入公式名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符之间",trigger:"blur"}],formula:[{required:!0,message:"请输入公式内容",trigger:"blur"}],usage:[{required:!0,message:"请选择使用标识",trigger:"change"}]},o=f({company_id:u.value.id,name:"",formula:"",usage:"",id:null}),T=f([]),V=async()=>{try{p.value=!0;const l=await W(u.value.id);l.code===200?T.value=l.data||[]:F.error("获取公式列表失败")}catch(l){console.error("加载公式列表出错:",l),F.error("加载公式列表时发生错误")}finally{p.value=!1}},S=l=>{i.value=!0,l?(o.value={company_id:u.value.id,name:l.name||"",formula:l.formula||"",usage:l.usage||"",id:l.id?Number(l.id):null},m.value=l.id?Number(l.id):null):r()},r=()=>{n.value&&n.value.resetFields(),o.value={company_id:u.value.id,name:"",formula:"",usage:"",id:null},m.value=null},y=async()=>{try{p.value=!0;const{id:l,...P}=o.value,z=await $({...P});z.code===200?(F.success("添加成功"),await V(),i.value=!1,e("update-formula")):F.error(z.message||"添加失败")}catch(l){console.error("添加公式出错:",l),F.error("添加公式时发生错误")}finally{p.value=!1}},h=async()=>{try{p.value=!0;const l=await ee({...o.value});l.code===200?(F.success("修改成功"),await V(),i.value=!1,e("update-formula")):F.error(l.message||"修改失败")}catch(l){console.error("编辑公式出错:",l),F.error("编辑公式时发生错误")}finally{p.value=!1}},N=async()=>{n.value&&n.value.validate(async l=>{l&&(m.value?await h():await y(),r())})};H(()=>u.value,async l=>{l!=null&&l.id&&await V()},{immediate:!0});const _=()=>{i.value=!1,r()},C=l=>{o.value.formula=l},I=l=>{o.value.formula+=l};t({open:S});const Y=f(null),R=f([]);function ye(l){o.value.formula+=l.replace("x",Y.value)}async function K(){try{return(await ae({company_id:Z().userCompany.id})).data}catch(l){console.error("获取表计列表失败:",l),fe({title:"错误",message:"获取表计列表失败",type:"error"})}}q(async()=>{R.value=await K()});const ve=L(()=>{const l=o.value.usage;if(!l)return R.value;let P=0;return l.includes("水")&&(P=1),l.includes("电")&&(P=2),l.includes("气")&&(P=3),R.value.filter(z=>z.type===P)}),X={emit:e,props:k,formRef:n,id:m,visibleContainer:i,loading:p,currentCompany:u,rules:v,setParam:o,formulaList:T,loadFormulaList:V,open:S,resetForm:r,addFormula:y,editFormula:h,submitForm:N,handleClose:_,handleFormulaSelect:C,insertSymbol:I,currentMeterId:Y,meterList:R,insertMeterSymbol:ye,fetchMeterList:K,filterMeterList:ve,get useCompanyStore(){return j},ref:f,watch:H,onMounted:q,computed:L,get addFormulaApi(){return $},get editFormulaApi(){return ee},get getFormulaApi(){return W},get storeToRefs(){return Q},get symbolList(){return he},get usageOptions(){return Ie},get getMeterInfoApi(){return ae},get useUserStore(){return Z}};return Object.defineProperty(X,"__isScriptSetup",{enumerable:!1,value:!0}),X}},He={class:"formula-help"},qe={class:"symbol-table-container"},We={key:0,class:"symbol-cell"},Je={key:1,class:"symbol-cell"};function Ke(D,t,w,e,k,n){const m=Me,i=ue,p=De,u=Ae,v=de,o=ce,T=pe,V=me,S=ie;return c(),M(S,{modelValue:e.visibleContainer,"onUpdate:modelValue":t[4]||(t[4]=r=>e.visibleContainer=r),title:e.id?"编辑公式":"新增公式",size:"50%","before-close":e.handleClose},{default:s(()=>[a(V,{ref:"formRef",model:e.setParam,rules:e.rules,"label-width":"100px","label-position":"top",class:"custom-form"},{default:s(()=>[a(i,{label:"公式名称",prop:"name"},{default:s(()=>[a(m,{modelValue:e.setParam.name,"onUpdate:modelValue":t[0]||(t[0]=r=>e.setParam.name=r),placeholder:"请输入公式名称",clearable:"",maxlength:50,"show-word-limit":""},null,8,["modelValue"])]),_:1}),a(i,{label:"根据选择已有公式快速添加"},{default:s(()=>[a(u,{placeholder:"选择已有公式",onChange:e.handleFormulaSelect,clearable:"",class:"w-full"},{default:s(()=>[(c(!0),E(B,null,J(e.formulaList,r=>(c(),M(p,{key:r.id,label:r.name,value:r.formula},null,8,["label","value"]))),128))]),_:1})]),_:1}),a(i,{label:"使用标识",prop:"usage"},{default:s(()=>[a(u,{modelValue:e.setParam.usage,"onUpdate:modelValue":t[1]||(t[1]=r=>e.setParam.usage=r),placeholder:"请选择使用标识",clearable:""},{default:s(()=>[(c(!0),E(B,null,J(e.usageOptions,r=>(c(),M(p,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(i,{label:"公式内容",prop:"formula"},{default:s(()=>[a(m,{modelValue:e.setParam.formula,"onUpdate:modelValue":t[2]||(t[2]=r=>e.setParam.formula=r),type:"textarea",rows:4,placeholder:"请输入公式内容",clearable:""},null,8,["modelValue"]),d("div",He,[t[7]||(t[7]=d("div",{class:"help-header"},[d("span",{class:"text-gray-600"},"支持基础运算符(+,-,*,/,%,^)及常见数学函数")],-1)),d("div",qe,[a(T,{data:e.symbolList,border:"",stripe:"",size:"small",style:{width:"100%"},height:"400"},{default:s(()=>[a(o,{prop:"symbol",label:"符号",align:"center"},{default:s(r=>[r.row.symbol!=="meter(x,START,END)"?(c(),E("div",We,[d("span",null,A(r.row.symbol),1),a(v,{type:"primary",link:"",onClick:y=>e.insertSymbol(r.row.symbol)},{default:s(()=>t[5]||(t[5]=[b("插入")])),_:2},1032,["onClick"])])):(c(),E("div",Je,[d("span",null,[a(u,{style:{width:"8rem"},modelValue:e.currentMeterId,"onUpdate:modelValue":t[3]||(t[3]=y=>e.currentMeterId=y),placeholder:"选择表计"},{default:s(()=>[(c(!0),E(B,null,J(e.filterMeterList,y=>(c(),M(p,{key:y.id,label:y.meter_code,value:y.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),a(v,{type:"primary",link:"",onClick:y=>e.insertMeterSymbol(r.row.symbol)},{default:s(()=>t[6]||(t[6]=[b("插入")])),_:2},1032,["onClick"])]))]),_:1}),a(o,{prop:"explanation",label:"解释",align:"left"}),a(o,{prop:"example",label:"使用案例",align:"left"})]),_:1},8,["data"])])])]),_:1}),a(i,null,{default:s(()=>[a(v,{type:"primary",onClick:e.submitForm,loading:e.loading},{default:s(()=>[b(A(e.id?"保存":"确定"),1)]),_:1},8,["loading"]),a(v,{onClick:e.handleClose},{default:s(()=>t[8]||(t[8]=[b("取消")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}const Xe=ne(je,[["render",Ke],["__scopeId","data-v-7ee8bf37"],["__file","D:/临时存放/green-carbon-1.0/src/views/SystemManagement/FormulaManagement/components/setFormula.vue"]]),Ge={__name:"index",setup(D,{expose:t}){t();const w=j(),e=w.currentCompany.id,k=f([]),n=f(!1),m=async(_=e)=>{n.value=!0;try{const C=await W(_);k.value=C.data}catch(C){console.error("Error getting formula:",C),fe({title:"错误",type:"error",message:"获取公式失败，请稍后再试"})}finally{n.value=!1}};H(()=>w.currentCompany,()=>{let _=w.currentCompany.id;m(_)});const i=f(!1),p=f(null),u=f({startTime:O().subtract(1,"day").valueOf(),endTime:O().valueOf()}),v=f(null),o=f(!1),T=_=>{p.value=_,i.value=!0,v.value=null,u.value={startTime:O().subtract(1,"day").valueOf(),endTime:O().valueOf()}},V=async()=>{if(!u.value.startTime||!u.value.endTime){F.warning("请选择开始和结束时间");return}o.value=!0;try{const _={id:p.value.id,start_time:new Date(u.value.startTime).getTime(),end_time:new Date(u.value.endTime).getTime()},C=await le(_);C.code===200?(v.value=C.data,F.success("计算成功")):F.error(C.message||"计算失败")}catch(_){console.error("Error computing formula:",_),F.error("计算失败，请稍后再试")}finally{o.value=!1}};q(()=>{m()});const S=f(),N={companyStore:w,companyId:e,data:k,loading:n,getFormula:m,testDialogVisible:i,currentFormula:p,testForm:u,testResult:v,computing:o,testFormula:T,computeFormula:V,formulaAdd:S,addFormula:()=>{S.value.open()},editFormula:_=>{S.value.open(_)},deleteFormula:async _=>{const C={id:String(_.id)};try{await Oe.confirm("此操作将永久删除该公式, 是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const I=await te(C);I.code===200?(k.value=k.value.filter(Y=>Y.id!==_.id),F({message:"删除成功",type:"success"})):F({message:`删除失败: ${I.message||"未知错误"}`,type:"error"})}catch(I){I!=="cancel"?(console.error("Error deleting formula:",I),F({message:"删除失败，请稍后再试",type:"error"})):console.log("用户取消删除操作")}},onMounted:q,ref:f,watch:H,SetFormula:Xe,get delFormulaApi(){return te},get getFormulaApi(){return W},get computeFormulaApi(){return le},get useCompanyStore(){return j},get dayjs(){return O}};return Object.defineProperty(N,"__isScriptSetup",{enumerable:!1,value:!0}),N}},Qe={class:"page-title",style:{display:"flex","justify-content":"space-between","align-items":"center"}},Ze={class:"formula-management"},$e={class:"test-formula-container"},et={class:"formula-info"},tt={class:"test-parameters"},lt={key:0,class:"test-result"},at={class:"dialog-footer"};function ot(D,t,w,e,k,n){const m=de,i=ce,p=pe,u=Te,v=ue,o=me,T=ze,V=ie,S=Se;return c(),E(B,null,[d("div",Qe,[t[5]||(t[5]=b(" 公式管理 ")),a(m,{style:{"margin-left":"16px"},type:"primary",icon:"plus",onClick:e.addFormula},{default:s(()=>t[4]||(t[4]=[b("添加公式")])),_:1})]),d("div",Ze,[se((c(),M(p,{data:e.data,border:"",stripe:"",class:"custom-table"},{default:s(()=>[a(i,{prop:"name",label:"公式名称",align:"center",width:"200"}),a(i,{prop:"usage",label:"使用标识",align:"center",width:"200"}),a(i,{prop:"formula",label:"公式内容",align:"center"}),a(i,{label:"操作",align:"center",width:"280"},{default:s(r=>[a(m,{onClick:y=>e.editFormula(r.row),type:"primary",size:"small",class:"action-button"},{default:s(()=>t[6]||(t[6]=[b(" 编辑 ")])),_:2},1032,["onClick"]),a(m,{onClick:y=>e.testFormula(r.row),type:"success",size:"small",class:"action-button"},{default:s(()=>t[7]||(t[7]=[b(" 测试 ")])),_:2},1032,["onClick"]),a(m,{onClick:y=>e.deleteFormula(r.row),type:"danger",size:"small",class:"action-button"},{default:s(()=>t[8]||(t[8]=[b(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[S,e.loading]]),a(e.SetFormula,{ref:"formulaAdd",onUpdateFormula:e.getFormula},null,512),a(V,{modelValue:e.testDialogVisible,"onUpdate:modelValue":t[3]||(t[3]=r=>e.testDialogVisible=r),title:"测试公式"},{footer:s(()=>[d("span",at,[a(m,{onClick:t[2]||(t[2]=r=>e.testDialogVisible=!1)},{default:s(()=>t[14]||(t[14]=[b("取 消")])),_:1}),a(m,{type:"primary",onClick:e.computeFormula,loading:e.computing},{default:s(()=>[b(A(e.computing?"计算中...":"计算"),1)]),_:1},8,["loading"])])]),default:s(()=>{var r,y;return[d("div",$e,[d("div",et,[t[11]||(t[11]=d("h3",null,"公式信息",-1)),d("p",null,[t[9]||(t[9]=d("strong",null,"公式名称：",-1)),b(A((r=e.currentFormula)==null?void 0:r.name),1)]),d("p",null,[t[10]||(t[10]=d("strong",null,"公式内容：",-1)),b(A((y=e.currentFormula)==null?void 0:y.formula),1)])]),d("div",tt,[t[12]||(t[12]=d("h3",null,"测试参数",-1)),a(o,{model:e.testForm,"label-width":"120px"},{default:s(()=>[a(v,{label:"开始时间"},{default:s(()=>[a(u,{modelValue:e.testForm.startTime,"onUpdate:modelValue":t[0]||(t[0]=h=>e.testForm.startTime=h),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),a(v,{label:"结束时间"},{default:s(()=>[a(u,{modelValue:e.testForm.endTime,"onUpdate:modelValue":t[1]||(t[1]=h=>e.testForm.endTime=h),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),e.testResult!=null?(c(),E("div",lt,[t[13]||(t[13]=d("h3",null,"计算结果",-1)),a(T,{title:`计算结果: ${e.testResult}`,type:"success",closable:!1,"show-icon":""},null,8,["title"])])):U("",!0)])]}),_:1},8,["modelValue"])])],64)}const Qt=ne(Ge,[["render",ot],["__scopeId","data-v-221ba961"],["__file","D:/临时存放/green-carbon-1.0/src/views/SystemManagement/FormulaManagement/index.vue"]]);export{Qt as default};
