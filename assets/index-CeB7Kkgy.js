import{_ as q,r as _,F as N,a as G,w as B,o as H,m as b,c as F,d as M,e as A,i as n,j as m,f as g,X as K,J as T,g as x,I as c,T as Q,U as Y,V as Z,v as I}from"./index-oALI6hjD.js";import{E as ee}from"./button-CW4VZptJ.js";import{E as te}from"./checkbox-eAiA7KBF.js";import{_ as oe}from"./导出-BMYnDY6G.js";import{d as R}from"./dayjs.min-VPOC9PSa.js";import{u as re,c as V,a as ae,f as O,b as le,d as se,t as ie}from"./meter-GWsXRyue.js";import{C as ne}from"./CustomDatePicker-BcsvcsJp.js";import{u as ue}from"./area-DGez3_R7.js";import{f as ce,a as me,r as de,c as fe,h as pe}from"./tableStyleConfig-B0fO-oaJ.js";import{g as _e,a as ve}from"./formula-CvS6Q7AW.js";/* empty css             *//* empty css                        */import{E as k}from"./index-BFWR71cx.js";import"./index-DXOgsKzf.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-GdZBC0LW.js";import"./use-form-item-CJ5jT23N.js";import"./icon-DFUaFmZd.js";import"./index-Ci2yyUHC.js";import"./isEqual-DERyOhzh.js";import"./_Uint8Array-Cyhry7Ym.js";import"./date-picker-DSsGajNu.js";import"./popper-8tqvLSZz.js";import"./aria-BUADUvnR.js";import"./focus-trap-B9jhWFgs.js";import"./input-_j8YarB1.js";import"./index-BTnVmvBQ.js";import"./scrollbar-BwLVa3O8.js";import"./index-Civq4TP6.js";import"./index-CPa7yTdP.js";/* empty css                 */import"./index-CV7ElbEQ.js";import"./formula-C00PoDkf.js";import"./handleError-BVJ6YTlw.js";const he={class:"meter-report-container"},ge={class:"meter-report-header"},we={__name:"index",setup(ye){const d=re(),P=ue(),$=_(null),f=_([R().startOf("month").valueOf(),R().endOf("month").valueOf()]),U={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"水表日统计报表",sheetName:"表计报表",modes:["current"]},w=_([]),j=N(()=>{const t={},e={};let i=0,s=0;p.value.forEach((l,a)=>{t[`usage_${a}`]=0,e[`usage_${a}`]=0}),w.value.forEach(l=>{!l.parent_id&&!l.meter_code.includes("不明水率")&&(p.value.forEach((a,r)=>{t[`usage_${r}`]+=Number(l[`usage_${r}`]||0)}),i+=Number(l.sum||0)),l.children&&l.children.forEach(a=>{a.meter_code.includes("不明水率")||(p.value.forEach((r,u)=>{e[`usage_${u}`]+=Number(a[`usage_${u}`]||0)}),s+=Number(a.sum||0))})});const o={};p.value.forEach((l,a)=>{const r=t[`usage_${a}`],u=e[`usage_${a}`];o[`usage_${a}`]=V(r,u)});let v=[{meter_code:"一级表合计",...t,sum:i.toFixed(2)},{meter_code:"二级表合计",...e,sum:s.toFixed(2)},{meter_code:"一级表不明率",...o,sum:V(i,s)}];return C.value.forEach(l=>{v.push({meter_code:l.name,...l,sum:0})}),v}),y=_(!1),D=_(!1),W=G({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:t})=>z(t)}),p=N(()=>ae(f.value[0],f.value[1])),C=_([]);async function S(){if(!y.value)try{w.value=[],y.value=!0;let t=Z().currentCompany.id;C.value=await _e(t,"用水日报表"),C.value=await ve(C.value,p.value);const e=d.treeDataForChart.map(o=>L(o)),i=await Promise.all(e);w.value=i.filter(Boolean);const s=$.value;for(let o=0;o<2;o++)await(s==null?void 0:s.setAllTreeExpand(!0))}catch(t){k({type:"error",title:"Error",message:t.message||"获取水表数据失败"}),console.error("Failed to fetch meter report:",t)}finally{y.value=!1}}async function L(t){try{const e=await se({id:t.id,start_time:f.value[0],end_time:R(f.value[1]).add(1,"day").valueOf(),interval:"day"});return ie(t,e)}catch(e){return k({type:"error",title:"Error",message:e.message||"获取水表数据失败"}),console.error(`Failed to fetch data for meter ${t.meter_code}:`,e),null}}const E=_(!1);async function z(t){try{const e=t.customChildren.map(o=>L(o)),s=(await Promise.all(e)).filter(Boolean);return E.value&&s.push(await J(t,s)),s}catch(e){return k({type:"error",title:"Error",message:e.message||"获取水表数据失败"}),console.error("Failed to load child nodes:",e),[]}}async function J(t,e){const i={};return p.value.forEach((s,o)=>{const v=t[`usage_${o}`]||0,l=e.reduce((a,r)=>r.meter_code.includes("不明水率")?a:a+(Number(r[`usage_${o}`])||0),0);i[`usage_${o}`]=V(v,l)}),{meter_code:t.meter_code+"不明水率",...i,sum:0}}async function X(){try{D.value=!0;const t=$.value;for(let e=0;e<d.meterLevels.length;e++)await(t==null?void 0:t.setAllTreeExpand(!0));await(t==null?void 0:t.openExport({includeFooter:!0}))}finally{D.value=!1}}return B([()=>f.value,()=>d.treeDataForChart],()=>{S()},{deep:!0}),B([()=>E.value],()=>{S()},{deep:!0}),H(async()=>{(!d.treeDataForChart.length||d.currentSelectedType!==1)&&(d.setCurrentSelectedType(1),await d.fetchMeterList()),S()}),(t,e)=>{const i=te,s=ee,o=b("vxe-column"),v=b("vxe-colgroup"),l=b("vxe-table"),a=I;return F(),M("div",he,[A("div",ge,[n(ne,{border:"",round:"",modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=r=>f.value=r)},null,8,["modelValue"]),n(i,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=r=>E.value=r),label:"显示子表的不明水率"},null,8,["modelValue"]),n(s,{style:{"margin-left":"auto"},type:"success",loading:D.value,onClick:X},{icon:m(()=>e[2]||(e[2]=[A("img",{src:oe,width:"14",height:"14",alt:"",srcset:""},null,-1)])),default:m(()=>[e[3]||(e[3]=g(" 导出 "))]),_:1},8,["loading"])]),K((F(),T(l,{"show-overflow":"",style:{"font-weight":"500"},"footer-cell-style":c(ce),"footer-row-style":c(me),"row-style":c(de),"cell-style":c(fe),"header-row-style":c(pe),height:"94%","show-footer":"",ref_key:"tableRef",ref:$,border:"",align:"center",data:w.value,"tree-config":W,"footer-data":j.value,"export-config":U},{default:m(()=>[n(o,{"tree-node":"",fixed:"left",field:"meter_code",title:"表计编号",width:"200"}),n(o,{fixed:"left",width:"100","show-overflow":"tooltip",title:"所供区域"},{default:m(({row:r})=>[g(x(c(P).getAreaNameById(r.area_id)||"-"),1)]),_:1}),n(o,{width:"120","how-overflow":"tooltip",field:"installation_location",title:"安装位置"}),n(o,{field:"specification",width:"100",title:"规格"}),n(o,{width:"100",field:"startReading",title:"启读数"}),(F(!0),M(Q,null,Y(p.value,(r,u)=>(F(),T(v,{key:r,title:r},{default:m(()=>[n(o,{width:"100",field:`usage_${u}`,title:"流量"},{default:m(({row:h})=>[g(x(c(O)(h[`usage_${u}`])||"-"),1)]),footer:m(({row:h})=>[g(x(c(O)(h[`usage_${u}`])||"-"),1)]),_:2},1032,["field"]),n(o,{width:"100",field:`reading_${u}`,title:"读数"},{default:m(({row:h})=>[g(x(c(le)(h[`reading_${u}`])),1)]),_:2},1032,["field"])]),_:2},1032,["title"]))),128)),n(o,{fixed:"right",field:"sum",width:"100",title:"总流量"})]),_:1},8,["footer-cell-style","footer-row-style","row-style","cell-style","header-row-style","data","tree-config","footer-data"])),[[a,y.value]])])}}},tt=q(we,[["__scopeId","data-v-8f1c1b94"]]);export{tt as default};
