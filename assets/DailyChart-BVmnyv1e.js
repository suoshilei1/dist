import{ab as I,r as u,W as T,F as z,_ as F,ag as M,al as O,w as R,Y as W,c as A,d as V,J as $,h as q,T as H,v as N}from"./index-DWtISIBF.js";import{u as k,b as Y,r as J}from"./meter-BWYCtTLu.js";import{g as Z,f as E}from"./date-C99jBCbl.js";import{d as x}from"./dayjs.min-t3tQ4ZJg.js";import{B as G}from"./BaseChart-BeO_gFFx.js";const K={1:"water",2:"electricity",3:"gas"},b=()=>({daily:{total:0,data:[]},week:{total:0,data:[]},monthly:{total:0,data:[]},yearly:{total:0,data:[]}}),B=I("report",()=>{const f=u(!1),m=u(b()),c=u(b()),s=u([{name:"本周",data:[]},{name:"前一周",data:[]},{name:"前二周",data:[]},{name:"前三周",data:[]}]),l=T(),p=k(),h=()=>p.currentMeter?{id:p.currentMeter.id,api:Y}:{id:l.currentCompany.id,api:J};function n(e){return Object.entries(K).reduce((t,[a,o])=>(t[o]=parseInt(a),t),{})[e]}const y=async(e="daily",r=!1,t={isAddStore:!0,type:"water"})=>{const{id:a,api:o}=h(),i=Z(e,r),v=t.isAddStore?p.currentSelectedType:n(t.type);try{const d=await o({id:a,...i,type:v});if(d.code===200){const P=r?c:m,S=d.aggregated_data||[];if(t.isAddStore){if(e==="weekly"){const C=r?1:0;s.value[C].data=S}const L=S.reduce((C,j)=>C+ +j.Value,0);P.value[e]={total:L,data:[...S]}}return S}throw new Error(d.message)}catch(d){throw console.error(`Error fetching ${e} report data:`,d),d}},_=async()=>{const{id:e,api:r}=h(),t=[2,3].map(a=>({start_time:x().subtract(a,"week").startOf("week").valueOf(),end_time:x().subtract(a,"week").endOf("week").valueOf(),interval:"day"}));try{const a=t.map(i=>r({id:e,...i,type:`[${p.currentSelectedType}]`})),o=await Promise.all(a);if(o.every(i=>i.code===200))return o.forEach((i,v)=>{const d=v+2;s.value[d].data=[...i.aggregated_data||[]]}),o;throw new Error("Some requests failed")}catch(a){throw a}};function g(){m.value=b(),c.value=b()}const D=async()=>{if(!f.value){f.value=!0,g();try{const e=["daily","weekly","monthly","yearly"],t=[];for(let a=0;a<e.length;a+=3){const i=e.slice(a,a+3).flatMap(v=>[y(v,!1),y(v,!0)]);t.push(i)}t.push([_()]);for(const a of t)await Promise.all(a)}catch(e){throw e}finally{f.value=!1}}},w=z(()=>(e,r=!1)=>({...(r?c.value:m.value)[e]}));return{isLoading:f,companyReportData:m,lastCompanyReportData:c,fourWeekData:s,fetchReportData:y,fetchAllReportsData:D,resetReportData:g,getReportDataList:w}}),Q={__name:"DailyChart",props:{chartType:{type:String,default:"bar"},meterType:{type:String,default:null}},setup(f,{expose:m}){m();const c=u(!1),{t:s}=M(),l=B(),p=T(),h=u(null);let n=f;const y=e=>(n.meterType||(e=e.data),e.length?e.map(r=>({time:E(r.start_time,"HH:mm"),value:Number(r.Value||0).toFixed(2)})):[]),_=O({});async function g(){c.value=!0;const e=u(null),r=u(null);if(n.meterType){k().setCurrentMeter(null);let t=await Promise.all([l.fetchReportData("daily",!1,{isAddStore:!1,type:n.meterType}),l.fetchReportData("daily",!0,{isAddStore:!1,type:n.meterType})]);e.value=t[0],r.value=t[1]}else e.value=l.getReportDataList("daily"),r.value=l.getReportDataList("daily",!0);D(e.value,r.value),c.value=!1}R(()=>l.getReportDataList("daily"),g),R([()=>n.meterType,()=>n.chartType,()=>p.currentCompany],g,{immediate:!0});function D(e,r){const t=y(e),a=y(r);if(!t.length&&!a.length){_.value={};return}_.value={xAxisData:t.map(o=>o.time),series:[{name:s("date.label.dayBefore"),data:a.map(o=>o.value),type:n.chartType},{name:s("date.label.yesterday"),data:t.map(o=>o.value),type:n.chartType}],customColors:["#7dafff","#409EFF"],showMarkLine:!0,showZoom:!0}}const w={loading:c,t:s,reportStore:l,companyStore:p,baseChartRef:h,get props(){return n},set props(e){n=e},formatChartData:y,chartOption:_,renderChart:g,setChartOption:D,ref:u,watch:R,shallowRef:O,watchEffect:H,get useReportStore(){return B},get useI18n(){return M},BaseChart:G,get formatDate(){return E},get useMeterStore(){return k},get useCompanyStore(){return T}};return Object.defineProperty(w,"__isScriptSetup",{enumerable:!1,value:!0}),w}},U={class:"chart-wrapper"};function X(f,m,c,s,l,p){const h=N;return W((A(),V("div",U,[s.chartOption?(A(),$(s.BaseChart,{key:0,ref:"baseChartRef",height:"100%",width:"100%",options:s.chartOption},null,8,["options"])):q("",!0)])),[[h,s.loading]])}const ee=F(Q,[["render",X],["__scopeId","data-v-847fe9de"],["__file","D:/临时存放/green-carbon-1.0/src/components/chart/DailyChart.vue"]]),ne=Object.freeze(Object.defineProperty({__proto__:null,default:ee},Symbol.toStringTag,{value:"Module"}));export{ee as D,ne as a,B as u};
