import{_ as I,r as f,F as P,a as j,w as H,o as U,m as A,c as E,d as W,e as C,i,j as p,f as x,Y as $,J as z,g as M,I as _,v as G,W as J}from"./index-Bx6Y8L80.js";import{E as q}from"./button-8bviUT_H.js";import{_ as K}from"./导出-BMYnDY6G.js";import{d as n}from"./dayjs.min-Cd48fqZ9.js";import{C as Q}from"./CustomDatePicker-CX6MdPmZ.js";import{u as X,f as Z,g as S,m as V}from"./meter-5sbrBbgq.js";import{h as m}from"./handleError-DD4JYoq7.js";import{g as ee,c as te}from"./formula-SHWkc_ME.js";import{f as re,a as ae}from"./tableStyleConfig-B0fO-oaJ.js";import"./index-A4BGBRGh.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-AkNVqhGZ.js";import"./use-form-item-50hJ8Ppj.js";import"./icon-6zrsquxY.js";import"./date-picker-CfUXe-Kp.js";import"./popper-DBn8ulUn.js";import"./index-CuyxIfpa.js";import"./aria-BUADUvnR.js";import"./focus-trap-Ddg061Nm.js";import"./input-CFaQgGx5.js";import"./index-iw6eP590.js";import"./scrollbar-DuXO1tWo.js";import"./index-DLcTS03G.js";import"./index-zrRcpBp4.js";import"./isEqual-BM-Gj-iT.js";import"./_Uint8Array-B6mJ0Xm4.js";/* empty css             *//* empty css                 */import"./index-KJp6TXG9.js";/* empty css                        */import"./index-CWCMyxJA.js";const oe={class:"meter-report-container"},le={class:"meter-report-header"},ie={class:"meter-report-body"},ne="用水日抄表",se={__name:"index",setup(de){const k=()=>({backgroundColor:"#416AB5",color:"#fff"}),O=({row:e,column:t})=>t.field==="Value"?{color:"#0D45AC"}:{color:"#21333f"},B=({row:e,rowIndex:t})=>{switch(e.level){case 1:return{backgroundColor:"#AFCAF7"};case 2:return{backgroundColor:"#D4E2FF"};case 3:return{backgroundColor:"#EBF0FA"};case 4:return{backgroundColor:"#F8FAFD"};default:return{backgroundColor:"#fff"}}},s=X(),D=f(null),d=f(n().subtract(1,"day").valueOf()),c=P(()=>{const e=n(d.value).startOf("day").valueOf(),t=n(d.value).endOf("day").valueOf();return[e,t]}),Y={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"水表日抄表",sheetName:"表计报表",modes:["current"]},h=f([]),y=f(!1),g=f(!1),R=j({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:e})=>L(e)});let w=f([]),v=f([]);const T=async()=>{const{currentCompany:e}=J();if(!(e!=null&&e.id))throw new Error("需要公司ID");try{const{data:t}=await ee(e.id),r=t.filter(l=>l.usage===ne);if(!r.length){v.value=[],w.value=[];return}const a=n(c.value[1]).format("YYYY/MM/DD");v.value=await Promise.all(r.map(async l=>{try{const o={id:l.id,start_time:c.value[0],end_time:c.value[1]},{data:u}=await te(o);return{meter_code:l.name,current_reading_time:a,Value:u}}catch(o){return m(o,"计算公式失败"),{meter_code:l.name,current_reading_time:a,Value:0}}})),w.value=r}catch(t){m(t,"获取公式失败"),v.value=[],w.value=[]}};async function F(){if(!y.value)try{await T(),h.value=[],y.value=!0;let e=await b(s.treeDataForChart);h.value=e.filter(Boolean)}catch(e){m(e,"获取数据失败")}finally{y.value=!1}}async function b(e){const t=e.map(r=>r.id).toString();try{const r=await S({id:`[${t}]`,start_time:c.value[0],end_time:c.value[1]});if(r.code!==200)return m(r,"获取水表数据失败"),[];const a=V(e,r.meter_readings,"current_reading",!0,c.value[1]),l=await S({id:`[${t}]`,start_time:n(d.value).subtract(1,"day").startOf("day").valueOf(),end_time:n(d.value).subtract(1,"day").endOf("day").valueOf()});return l.code!==200?(m(l,"获取水表数据失败"),[]):V(a,l.meter_readings,"yesterday_reading",!0,n(d.value).subtract(1,"day").endOf("day")).map(o=>({...o,Value:Math.max(0,o.current_reading-o.yesterday_reading),hasChild:Array.isArray(o.children)&&o.children.length>0,customChild:o.children}))}catch(r){return m(r,"转换数据失败"),[]}}async function L(e){try{return(await b(e.customChild)).filter(Boolean)}catch(t){return console.error("Failed to load child nodes:",t),[]}}async function N(){try{g.value=!0;const e=D.value;for(let t=0;t<s.meterLevels.length;t++)await(e==null?void 0:e.setAllTreeExpand(!0));await(e==null?void 0:e.openExport({includeFooter:!0}))}finally{g.value=!1}}return H([()=>c.value,()=>s.treeDataForChart],()=>{F()},{deep:!0}),U(async()=>{(!s.treeDataForChart.length||s.currentSelectedType!==1)&&(s.setCurrentSelectedType(1),await s.fetchMeterList()),F()}),(e,t)=>{const r=q,a=A("vxe-column"),l=A("vxe-table"),o=G;return E(),W("div",oe,[C("div",le,[i(Q,{border:"",isRange:!1,modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=u=>d.value=u)},null,8,["modelValue"]),i(r,{style:{"margin-left":"auto"},type:"success",loading:g.value,onClick:N},{icon:p(()=>t[1]||(t[1]=[C("img",{src:K,width:"14",height:"14",alt:"",srcset:""},null,-1)])),default:p(()=>[t[2]||(t[2]=x(" 导出 "))]),_:1},8,["loading"])]),C("div",ie,[$((E(),z(l,{style:{"font-weight":"500"},"show-footer":!0,"footer-data":_(v),"footer-cell-style":_(re),"footer-row-style":_(ae),"cell-style":O,"header-row-style":k,"row-style":B,height:"600px",ref_key:"tableRef",ref:D,border:"",align:"center",data:h.value,"tree-config":R,"export-config":Y},{default:p(()=>[i(a,{"tree-node":"",fixed:"left",field:"meter_code",title:"编号"}),i(a,{fixed:"left",field:"id",title:"表号"}),i(a,{field:"specification",title:"规格"}),i(a,{field:"yesterday_reading",title:"上次读数"}),i(a,{field:"current_reading",title:"本次读数"}),i(a,{field:"current_reading_time",title:"时间"},{default:p(({row:u})=>[x(M(_(n)(u.current_reading_time).format("YYYY/MM/DD HH:mm:ss")),1)]),_:1}),i(a,{fixed:"right",field:"Value",title:"流量"},{default:p(({row:u})=>[x(M(_(Z)(u.Value)),1)]),_:1})]),_:1},8,["footer-data","footer-cell-style","footer-row-style","data","tree-config"])),[[o,y.value]])])])}}},je=I(se,[["__scopeId","data-v-8157f463"]]);export{je as default};
