import{_ as M,aa as N,r as x,F as V,w as L,o as P,ab as ae,c as y,d as w,i as c,j as h,U as $,V as B,J as z,e as b,g as S,f as R,ac as oe,I as D,Y as j,a2 as G,N as F,h as O,K as re,b as ne,ad as se,W as le,ae as J}from"./index-Bx6Y8L80.js";import{E as ie,a as ce}from"./col-TrHbeXFY.js";import{E as ue}from"./card-fNeABwz5.js";/* empty css            */import{_ as pe}from"./AnimatedNumber-BnUE5Cda.js";import{E as me,a as de}from"./skeleton-item-rsqgV45v.js";import{u as U}from"./meter-5sbrBbgq.js";import{u as A,D as he}from"./DailyChart-DBNo4Chm.js";import{f as W}from"./date-Cgy1PrMx.js";import{E as ye}from"./index-aFn2MKle.js";import{u as fe,i as _e,a as ve,b as ge,c as be}from"./installCanvasRenderer-7dDAEUGk.js";import{E as K}from"./button-8bviUT_H.js";import{B as Y}from"./BaseChart-DcPP-dUj.js";import{d as we}from"./dayjs.min-Cd48fqZ9.js";import{E as Ce}from"./dialog-Dt2QUqOw.js";import"./overlay-04qnzRyj.js";import{E as De}from"./scrollbar-DuXO1tWo.js";import{E as Ee,a as ke}from"./radio-group-i8YIvWc2.js";/* empty css              */import{M as Te}from"./MeterTree-CoH_k643.js";import{E as xe}from"./index-A4BGBRGh.js";import{E as Se}from"./index-CWCMyxJA.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-iw6eP590.js";import"./index-CuyxIfpa.js";/* empty css                */import"./popper-DBn8ulUn.js";import"./aria-BUADUvnR.js";import"./focus-trap-Ddg061Nm.js";import"./use-form-item-50hJ8Ppj.js";import"./index-AkNVqhGZ.js";import"./icon-6zrsquxY.js";import"./DebounceAndThrottle-B_grFKK4.js";import"./index-DZY-cmUL.js";import"./scroll-BawlEUY1.js";import"./vnode-DK7gyQZj.js";import"./refs-Bp53MkJS.js";import"./MeterDialog-C3DuWE-y.js";import"./form-item-CWYWsPGl.js";import"./castArray-CrUPC_Z8.js";import"./_Uint8Array-B6mJ0Xm4.js";import"./_initCloneObject-nnMrnZRY.js";import"./input-CFaQgGx5.js";import"./checkbox-LjaCbo-5.js";import"./isEqual-BM-Gj-iT.js";import"./date-picker-CfUXe-Kp.js";import"./index-DLcTS03G.js";import"./index-zrRcpBp4.js";import"./select-BmMHn9PT.js";import"./_baseIteratee-CkjM3wkz.js";import"./area-COPnz-hV.js";import"./formula-ClsumsYI.js";import"./formula-SHWkc_ME.js";import"./handleError-DD4JYoq7.js";/* empty css             *//* empty css                        */import"./index-KJp6TXG9.js";import"./constant-Dm8qiNaG.js";import"./constants-NVab_QuI.js";/* empty css                 */import"./tree-Bp6m8vKT.js";const Me={class:"stats-scroll-container"},Re={class:"card-content"},Ve={class:"stat-info"},$e={class:"mini-chart-skeleton"},Le={class:"stat-info"},Ae=["title"],We={class:"stat-value"},Ne={class:"stat-time"},Fe={class:"stat-comparison"},Ie={__name:"EnergyStatsCards",props:{loading:{type:Boolean,default:!1}},setup(d){fe([_e,ve,ge]);const{t:e}=N(),i=x([]),n=d,t=A(),m=U(),p=u=>u.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),a=V(()=>({1:{unit:"m³",name:e("dashboard.water")},2:{unit:"kWh",name:e("dashboard.electricity")},3:{unit:"m³",name:e("dashboard.gas")}})[m.currentSelectedType]||{unit:"",name:e("dashboard.usage")}),s=(u,g)=>!g||g===0?0:Number(((u-g)/g*100).toFixed(2)),o=V(()=>{var u,g,E;return n.loading||t.isLoading?Array(3).fill({title:"",total:0,timeRange:"",data:new Array(24).fill(0),change:0,compareText:""}):[{title:e("dashboard.yesterdayTotal",{type:a.value.name}),total:t.companyReportData.daily.total||0,timeRange:W(new Date,"yyyy-MM-dd"),data:((u=t.companyReportData.daily.data)==null?void 0:u.map(k=>k.Value))||[],change:s(t.companyReportData.daily.total,t.lastCompanyReportData.daily.total),compareText:e("dashboard.comparedToLast")},{title:e("dashboard.monthlyTotal",{type:a.value.name}),total:t.companyReportData.monthly.total||0,timeRange:W(new Date,"yyyy-MM"),data:((g=t.companyReportData.monthly.data)==null?void 0:g.map(k=>k.Value))||[],change:s(t.companyReportData.monthly.total,t.lastCompanyReportData.monthly.total),compareText:e("dashboard.comparedToLast")},{title:e("dashboard.yearlyTotal",{type:a.value.name}),total:t.companyReportData.yearly.total||0,timeRange:W(new Date,"yyyy"),data:((E=t.companyReportData.yearly.data)==null?void 0:E.map(k=>k.Value))||[],change:s(t.companyReportData.yearly.total,t.lastCompanyReportData.yearly.total),compareText:e("dashboard.comparedToLast")}]}),l=(u=[])=>({animation:!1,grid:{top:5,right:5,bottom:5,left:5,containLabel:!1},xAxis:{type:"category",show:!1,boundaryGap:!1},yAxis:{type:"value",show:!1,scale:!0},series:[{type:"line",data:u,smooth:!0,symbol:"none",lineStyle:{width:2,color:"#409EFF"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(64, 158, 255, 0.3)"},{offset:1,color:"rgba(64, 158, 255, 0.1)"}]}}}]});let f=[];const r=async()=>{n.loading||(f.forEach(u=>u==null?void 0:u.dispose()),f=[],await oe(),i.value.forEach((u,g)=>{if(u&&o.value[g]){const E=be(u);E.setOption(l(o.value[g].data)),f.push(E)}}))},_=()=>{f.forEach(u=>u==null?void 0:u.resize())};let C=null;const v=()=>{C&&clearTimeout(C),C=setTimeout(async()=>{await r()},300)};return L([o,()=>m.currentSelectedType],v,{deep:!0}),P(()=>{window.addEventListener("resize",_),v()}),ae(()=>{window.removeEventListener("resize",_),C&&clearTimeout(C),f.forEach(u=>u==null?void 0:u.dispose()),f=[]}),(u,g)=>{const E=me,k=de,q=pe,H=ye,Q=ue,X=ie,ee=ce;return y(),w("div",Me,[c(ee,{gutter:16,class:"energy-stats"},{default:h(()=>[(y(!0),w($,null,B(o.value,(T,te)=>(y(),z(X,{span:8,key:te},{default:h(()=>[c(Q,{shadow:"hover"},{default:h(()=>[b("div",Re,[d.loading?(y(),w($,{key:0},[b("div",Ve,[c(k,{animated:"",rows:3},{template:h(()=>[c(E,{variant:"h3",style:{width:"80%","margin-bottom":"12px"}}),c(E,{variant:"p",style:{width:"70%",margin:"12px 0"}}),c(E,{variant:"text",style:{width:"50%"}})]),_:1})]),b("div",$e,[c(k,{animated:""},{template:h(()=>[c(E,{variant:"image",style:{width:"200px",height:"100px"}})]),_:1})])],64)):(y(),w($,{key:1},[b("div",Le,[b("h3",{class:"stat-title",title:T.title},S(T.title),9,Ae),b("p",We,[c(q,{value:T.total,formatter:p},null,8,["value"])]),b("p",Ne,S(T.timeRange),1),b("p",Fe,[c(H,{type:T.change>0?"danger":"success",size:"small"},{default:h(()=>[R(S(T.compareText)+S(T.change>0?"+":"")+S(T.change)+"% ",1)]),_:2},1032,["type"])])]),b("div",{class:"mini-chart",ref_for:!0,ref_key:"chartRefs",ref:i},null,512)],64))])]),_:2},1024)]),_:2},1024))),128))]),_:1})])}}},Be=M(Ie,[["__scopeId","data-v-e23c13bb"]]),Z="chart_config";function Oe(){const d=()=>{try{const t=localStorage.getItem(Z);return t?JSON.parse(t):null}catch(t){return console.error("Error loading config:",t),null}},e=t=>{try{localStorage.setItem(Z,JSON.stringify(t))}catch(m){console.error("Error saving config:",m)}},i={showChartTypes:!0,showPeriodSelector:!0,enabledChartTypes:["line","bar"],enabledPeriods:["daily","weekly","monthly","yearly"]},n=x(d()||i);return L(n,t=>{e(t)},{deep:!0}),{config:n}}const Pe={class:"chart-selector"},ze={key:0,class:"button-group"},Ue={key:1,class:"button-group"},Ye={__name:"ChartSelect",props:{modelValue:{type:Object,required:!0,default:()=>({chartType:"bar",period:"daily"})},chartId:{type:String,default:"default"}},emits:["update:modelValue"],setup(d,{emit:e}){const i=d,{config:n}=Oe(i.chartId),t=e,m=[{value:"line",icon:"fa fa-line-chart",label:"折线图"},{value:"bar",icon:"fa fa-bar-chart",label:"柱状图"}],p=[{value:"daily",label:"日"},{value:"weekly",label:"周"},{value:"monthly",label:"月"},{value:"yearly",label:"年"}],a=o=>{n.value.enabledChartTypes.includes(o)&&t("update:modelValue",{...i.modelValue,chartType:o})},s=o=>{n.value.enabledPeriods.includes(o)&&t("update:modelValue",{...i.modelValue,period:o})};return(o,l)=>{const f=K;return y(),w("div",Pe,[D(n).showChartTypes&&D(n).enabledChartTypes.length>0?(y(),w("div",ze,[(y(),w($,null,B(m,r=>j(c(f,{key:r.value,class:F({"is-active":d.modelValue.chartType===r.value}),onClick:_=>a(r.value),round:""},{icon:h(()=>[b("i",{class:F(r.icon)},null,2)]),_:2},1032,["class","onClick"]),[[G,D(n).enabledChartTypes.includes(r.value)]])),64))])):O("",!0),D(n).showPeriodSelector&&D(n).enabledPeriods.length>0?(y(),w("div",Ue,[(y(),w($,null,B(p,r=>j(c(f,{key:r.value,class:F({"is-active":d.modelValue.period===r.value}),onClick:_=>s(r.value),round:""},{default:h(()=>[R(S(r.label),1)]),_:2},1032,["class","onClick"]),[[G,D(n).enabledPeriods.includes(r.value)]])),64))])):O("",!0)])}}},je=M(Ye,[["__scopeId","data-v-d90f590b"]]),Ge={class:"chart-wrapper"},Je={__name:"WeeklyChart",props:{chartType:{type:String,default:"bar"}},setup(d){const{t:e}=N(),i=A(),n=d,t=a=>{const s=[e("date.week[0]"),e("date.week[1]"),e("date.week[2]"),e("date.week[3]"),e("date.week[4]"),e("date.week[5]"),e("date.week[6]")],o=new Date(a);return s[o.getDay()]},m=a=>{var s;return(s=a==null?void 0:a.data)!=null&&s.length?a.data.map(o=>({time:t(o.start_time),value:Number(o.Value||0).toFixed(2)})):[]},p=V(()=>{const a=i.fourWeekData[0],s=i.fourWeekData[1],o=i.fourWeekData[2],l=i.fourWeekData[3],f=m(a),r=m(s),_=m(o),C=m(l);return!f.length&&!r.length&&!_.length&&!C.length?null:{title:e("date.title.weekly"),xAxisData:f.map(v=>v.time),series:[{name:e("date.label.threeWeeksAgo"),data:C.map(v=>v.value),type:n.chartType,showExtremum:!0},{name:e("date.label.twoWeeksAgo"),data:_.map(v=>v.value),type:n.chartType,showExtremum:!0},{name:e("date.label.lastWeek"),data:r.map(v=>v.value),type:n.chartType,showExtremum:!0},{name:e("date.label.thisWeek"),data:f.map(v=>v.value),type:n.chartType,showExtremum:!0}],showMarkLine:!0,showZoom:!1}});return(a,s)=>(y(),w("div",Ge,[c(Y,{height:"100%",options:p.value},null,8,["options"])]))}},Ze={class:"chart-wrapper",style:{height:"100%",width:"100%"}},Ke={__name:"MonthlyChart",props:{chartType:{type:String,default:"bar"}},setup(d){const{t:e}=N(),i=A(),n=d,t=p=>{var a;return(a=p==null?void 0:p.data)!=null&&a.length?p.data.map(s=>({time:we(s.start_time).format("DD"),value:Number(s.Value||0).toFixed(2)})):[]},m=V(()=>{const p=i.getReportDataList("monthly"),a=i.getReportDataList("monthly",!0),s=t(p),o=t(a);return!s.length&&!o.length?null:{title:e("date.title.monthly"),xAxisData:s.map(l=>l.time),series:[{name:e("date.label.lastMonth"),data:o.map(l=>l.value),type:n.chartType,showExtremum:!0},{name:e("date.label.thisMonth"),data:s.map(l=>l.value),type:n.chartType,showExtremum:!0}],customColors:["#DEEEFF","#409EFF"],showMarkLine:!0,showZoom:!1}});return(p,a)=>(y(),w("div",Ze,[c(Y,{height:"100%",options:m.value},null,8,["options"])]))}},qe=M(Ke,[["__scopeId","data-v-a059eebc"]]),He={class:"chart-wrapper"},Qe={__name:"YearlyChart",props:{chartType:{type:String,default:"bar"}},setup(d){const{t:e}=N(),i=A(),n=d,t=p=>{var a;return(a=p==null?void 0:p.data)!=null&&a.length?p.data.map(s=>({time:W(s.start_time,"MM"),value:Number(s.Value||0).toFixed(2)})):[]},m=V(()=>{const p=i.getReportDataList("yearly"),a=i.getReportDataList("yearly",!0),s=t(p),o=t(a);return!s.length&&!o.length?null:{title:e("date.title.yearly"),xAxisData:s.map(l=>l.time),series:[{name:e("date.label.lastYear"),data:o.map(l=>l.value),type:n.chartType,showExtremum:!0},{name:e("date.label.thisYear"),data:s.map(l=>l.value),type:n.chartType,showExtremum:!0}],customColors:["#d7ebff","#409EFF"],showMarkLine:!0,showZoom:!1}});return(p,a)=>(y(),w("div",He,[c(Y,{height:"100%",options:m.value},null,8,["options"])]))}},Xe=M(Qe,[["__scopeId","data-v-56dbb3bf"]]),et={class:"chart-scroll-container"},tt={class:"chart-container"},at={class:"chart-header"},ot={__name:"EnergyChart",setup(d){const e=x({chartType:"bar",period:"daily"}),i=V(()=>({daily:he,weekly:Je,monthly:qe,yearly:Xe})[e.value.period]);return(n,t)=>(y(),w("div",et,[b("div",tt,[b("div",at,[c(je,{"chart-id":"water",modelValue:e.value,"onUpdate:modelValue":t[0]||(t[0]=m=>e.value=m)},null,8,["modelValue"])]),(y(),z(re(i.value),{chartType:e.value.chartType,class:"charts"},null,8,["chartType"]))])]))}},rt=M(ot,[["__scopeId","data-v-5d903fd8"]]),nt={class:"meter-selector"},st={class:"meter-selector__content"},lt={class:"select-all-option"},it={class:"dialog-footer"},ct={__name:"MeterSelector",props:{type:{type:Number,default:1}},setup(d){const e=U(),i=x(!1),n=x(!1),t=x(e.currentMeter?"specific":"all"),m=d,p=o=>{o==="all"&&e.setCurrentMeter(null)},a=()=>{t.value==="all"&&e.setCurrentMeter(null),n.value=!1},s=async()=>{try{i.value=!0,await e.fetchMeterList({type:m.type})}catch(o){console.error("Error fetching meters:",o)}finally{i.value=!1}};return L(()=>e.currentMeter,o=>{t.value=o?"specific":"all"}),P(()=>{s()}),ne(()=>{e.setCurrentMeter(null)}),(o,l)=>{const f=xe,r=K,_=Ee,C=ke,v=De,u=Ce;return y(),w("div",nt,[c(r,{type:"primary",onClick:l[0]||(l[0]=g=>n.value=!0)},{icon:h(()=>[c(f,null,{default:h(()=>[c(D(se))]),_:1})]),default:h(()=>[R(" "+S(D(e).currentMeter?D(e).currentMeter.meter_code:"全部"),1)]),_:1}),c(u,{modelValue:n.value,"onUpdate:modelValue":l[2]||(l[2]=g=>n.value=g),title:"当前表计:"+(D(e).currentMeter?D(e).currentMeter.meter_code:"全部"),width:"600px"},{footer:h(()=>[b("span",it,[c(r,{type:"primary",onClick:a},{default:h(()=>l[5]||(l[5]=[R(" 确认 ")])),_:1})])]),default:h(()=>[b("div",st,[b("div",lt,[c(C,{modelValue:t.value,"onUpdate:modelValue":l[1]||(l[1]=g=>t.value=g),onChange:p},{default:h(()=>[c(_,{label:"all"},{default:h(()=>l[3]||(l[3]=[R("全部")])),_:1}),c(_,{label:"specific"},{default:h(()=>l[4]||(l[4]=[R("选择具体表计")])),_:1})]),_:1},8,["modelValue"])]),c(v,{height:"400px"},{default:h(()=>[c(Te,{data:D(e).treeDataForChart,disabled:t.value==="all"},null,8,["data","disabled"])]),_:1})])]),_:1},8,["modelValue","title"])])}}},ut=M(ct,[["__scopeId","data-v-ef90e19a"]]),pt={class:"dashboard"},mt={class:"dashboard-header page-title"},I=2,dt={__name:"index",setup(d){const e=U(),i=A(),n=le(),{currentMeter:t,currentSelectedType:m}=J(e),{currentCompany:p}=J(n),a=x(!1),s=x(!1),o=r=>{console.error(r),Se({title:"数据加载失败",message:(r==null?void 0:r.message)||"数据加载失败",type:"error"})},l=async()=>{if(!a.value)try{a.value=!0,await i.fetchAllReportsData()}catch(r){o(r)}finally{a.value=!1}},f=async()=>{if(!a.value)try{a.value=!0,e.setCurrentMeter(null),e.setCurrentSelectedType(I),await e.fetchMeterList(),await i.fetchAllReportsData()}catch(r){o(r)}finally{a.value=!1}};return L([t,m],async([r,_],[C,v])=>{if(!s.value){r&&_&&(s.value=!0,await l());return}(r!==C||_!==v)&&await l()},{deep:!0}),L(p,async(r,_)=>{if(!(!r||r===_))try{a.value=!0,e.setCurrentSelectedType(I),e.setCurrentMeter(null),await i.fetchAllReportsData()}catch(C){o(C)}finally{a.value=!1}}),P(()=>{f()}),(r,_)=>(y(),w("div",pt,[b("div",mt,[c(ut,{type:I})]),c(Be,{loading:a.value},null,8,["loading"]),a.value?O("",!0):(y(),z(rt,{key:0,style:{"margin-top":"16px"}}))]))}},wa=M(dt,[["__scopeId","data-v-1024a9f4"]]);export{wa as default};
