import{_ as q,r as f,F as A,w as F,o as I,m as h,c as M,d as J,e as C,i as s,j as g,f as b,X as w,J as L,g as N,a1 as T,v as U}from"./index-oALI6hjD.js";import{E as $}from"./button-CW4VZptJ.js";import{_ as X}from"./导出-BMYnDY6G.js";import{g as G}from"./meter-GWsXRyue.js";import{d as v}from"./dayjs.min-VPOC9PSa.js";import{C as K}from"./CustomDatePicker-BcsvcsJp.js";import{E as D}from"./index-CV7ElbEQ.js";import{E as Q}from"./index-BFWR71cx.js";import"./index-DXOgsKzf.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-GdZBC0LW.js";import"./use-form-item-CJ5jT23N.js";import"./icon-DFUaFmZd.js";import"./date-picker-DSsGajNu.js";import"./popper-8tqvLSZz.js";import"./index-Ci2yyUHC.js";import"./aria-BUADUvnR.js";import"./focus-trap-B9jhWFgs.js";import"./input-_j8YarB1.js";import"./index-BTnVmvBQ.js";import"./scrollbar-BwLVa3O8.js";import"./index-Civq4TP6.js";import"./index-CPa7yTdP.js";import"./isEqual-DERyOhzh.js";import"./_Uint8Array-Cyhry7Ym.js";/* empty css             *//* empty css                 */const W={class:"table-container"},Z={class:"filter-container"},ee={__name:"MeterReportDailyDetail",props:{currentMeter:{type:Object,required:!0}},setup(z){const d=z,c=f([]),u=f({field:"",order:""}),m=f(!1),_=f(!1),x=f(null),r=f({currentPage:1,pageSize:10,total:0}),P=[v().subtract(2,"day").startOf("day").valueOf(),v().subtract(1,"day").endOf("day").valueOf()],p=f(P);function E(t){if(!Array.isArray(t)||t.length===0)return[];const e=t.sort((a,l)=>v(a.time).valueOf()-v(l.time).valueOf());return e.map((a,l)=>{const i=l>0?e[l-1].value:null,n=i!==null?Number(a.value)-Number(i):null;return{...a,time:v(a.time).format("MM-DD HH:mm"),usage:n!==null?n.toFixed(2):"--"}})}const O=A(()=>{let t=[...c.value];u.value.field&&u.value.order&&t.sort((l,i)=>{const n=l[u.value.field],y=i[u.value.field],o=u.value.order==="desc"?-1:1;return u.value.field==="usage"&&(n===null||y===null)?n===null?1:-1:n>y?o:-o});const e=(r.value.currentPage-1)*r.value.pageSize,a=e+r.value.pageSize;return t.slice(e,a)});F([()=>d.currentMeter,()=>p.value],async([t,e],[a,l])=>{if(!t)return;const i=!a||t.id!==a.id,n=!l||e[0]!==l[0]||e[1]!==l[1];(i||n)&&await S()});async function S(){var t;if((t=d.currentMeter)!=null&&t.id){m.value=!0,c.value=[];try{const e=await G({id:d.currentMeter.id,start_time:p.value[0].valueOf(),end_time:p.value[1].valueOf()});if(e.code===200){const a=E(e.meter_readings||[]);c.value=a,r.value.total=a.length,r.value.currentPage=1,a.length===0&&D.warning("所选时间范围内无数据")}else throw new Error(e.message||"获取数据失败")}catch(e){console.error("获取表计数据失败:",e),Q({title:"请求失败",message:e.message||"服务器错误，请稍后重试",type:"error",duration:5e3})}finally{m.value=!1}}}function V({currentPage:t,pageSize:e}){r.value.currentPage=t,r.value.pageSize=e}function k({property:t,order:e}){u.value.field=t,u.value.order=e}function B(){p.value=P,u.value={field:"",order:""},r.value.currentPage=1;const t=x.value;t==null||t.clearSort()}async function H(){var t;if(!c.value.length){D.warning("暂无数据可导出");return}try{_.value=!0;const e=x.value;await(e==null?void 0:e.exportData({filename:`${((t=d==null?void 0:d.currentMeter)==null?void 0:t.meter_code)||"未知表计"}_${v().format("YYYY-MM-DD")}_统计报表`,type:"xlsx",mode:"all",useStyle:!0,data:c.value}))}catch(e){console.error("导出失败:",e),D.error("导出失败，请重试")}finally{_.value=!1}}function R(t){return t==null||t===""?"--":Number(t).toFixed(2)}function Y(t){return t?v(t).format("MM-DD HH:mm"):"--"}function j({rowIndex:t}){return(r.value.currentPage-1)*r.value.pageSize+t+1}return I(()=>{d.currentMeter&&S()}),(t,e)=>{const a=$,l=h("vxe-column"),i=h("vxe-table"),n=h("vxe-pager"),y=U;return M(),J("div",W,[C("div",Z,[s(K,{modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=o=>p.value=o),"max-days":4,disabled:m.value},null,8,["modelValue","disabled"]),s(a,{onClick:B,type:"danger",disabled:m.value},{default:g(()=>e[3]||(e[3]=[b("重置")])),_:1},8,["disabled"]),s(a,{style:{"margin-left":"auto"},loading:_.value,disabled:_.value||m.value||!c.value.length,onClick:H,type:"success"},{icon:g(()=>e[4]||(e[4]=[C("img",{src:X,width:"14",height:"14",alt:"",srcset:""},null,-1)])),default:g(()=>[e[5]||(e[5]=b(" 导出 "))]),_:1},8,["loading","disabled"])]),w((M(),L(i,{align:"center",ref_key:"tableRef",ref:x,data:O.value,"empty-text":m.value?"加载中...":"暂无数据",onSortChange:k},{default:g(()=>[s(l,{type:"seq",width:"70","seq-method":j}),s(l,{sortable:"",field:"value",title:"读数"},{default:g(({row:o})=>[b(N(R(o.value)),1)]),_:1}),s(l,{sortable:"",field:"usage",title:"流量"}),s(l,{sortable:"",field:"time",title:"时间"},{default:g(({row:o})=>[b(N(Y(o.time)),1)]),_:1})]),_:1},8,["data","empty-text"])),[[y,m.value]]),w(s(n,{currentPage:r.value.currentPage,"onUpdate:currentPage":e[1]||(e[1]=o=>r.value.currentPage=o),pageSize:r.value.pageSize,"onUpdate:pageSize":e[2]||(e[2]=o=>r.value.pageSize=o),total:r.value.total,layouts:["Home","PrevJump","PrevPage","Number","NextPage","NextJump","End","Sizes","Total"],onPageChange:V},null,8,["currentPage","pageSize","total"]),[[T,c.value.length>0]])])}}},Ne=q(ee,[["__scopeId","data-v-5a558e51"]]);export{Ne as default};
