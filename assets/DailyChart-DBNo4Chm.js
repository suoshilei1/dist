import{a6 as B,r as f,W as M,F as L,_ as P,aa as j,af as z,w as R,Y as F,c as T,d as I,J as W,h as V,v as $}from"./index-Bx6Y8L80.js";import{u as A,d as q,r as H}from"./meter-5sbrBbgq.js";import{g as N,f as Y}from"./date-Cgy1PrMx.js";import{d as k}from"./dayjs.min-Cd48fqZ9.js";import{B as J}from"./BaseChart-DcPP-dUj.js";const Z={1:"water",2:"electricity",3:"gas"},S=()=>({daily:{total:0,data:[]},week:{total:0,data:[]},monthly:{total:0,data:[]},yearly:{total:0,data:[]}}),G=B("report",()=>{const y=f(!1),i=f(S()),m=f(S()),c=f([{name:"本周",data:[]},{name:"前一周",data:[]},{name:"前二周",data:[]},{name:"前三周",data:[]}]),C=M(),h=A(),s=()=>h.currentMeter?{id:h.currentMeter.id,api:q}:{id:C.currentCompany.id,api:H};function g(e){return Object.entries(Z).reduce((t,[a,p])=>(t[p]=parseInt(a),t),{})[e]}const u=async(e="daily",o=!1,t={isAddStore:!0,type:"water"})=>{const{id:a,api:p}=s(),l=N(e,o),v=t.isAddStore?h.currentSelectedType:g(t.type);try{const d=await p({id:a,...l,type:v});if(d.code===200){const E=o?m:i,_=d.aggregated_data||[];if(t.isAddStore){if(e==="weekly"){const b=o?1:0;c.value[b].data=_}const O=_.reduce((b,x)=>b+ +x.Value,0);E.value[e]={total:O,data:[..._]}}return _}throw new Error(d.message)}catch(d){throw console.error(`Error fetching ${e} report data:`,d),d}},w=async()=>{const{id:e,api:o}=s(),t=[2,3].map(a=>({start_time:k().subtract(a,"week").startOf("week").valueOf(),end_time:k().subtract(a,"week").endOf("week").valueOf(),interval:"day"}));try{const a=t.map(l=>o({id:e,...l,type:`[${h.currentSelectedType}]`})),p=await Promise.all(a);if(p.every(l=>l.code===200))return p.forEach((l,v)=>{const d=v+2;c.value[d].data=[...l.aggregated_data||[]]}),p;throw new Error("Some requests failed")}catch(a){throw a}};function D(){i.value=S(),m.value=S()}const r=async()=>{if(!y.value){y.value=!0,D();try{const e=["daily","weekly","monthly","yearly"],t=[];for(let a=0;a<e.length;a+=3){const l=e.slice(a,a+3).flatMap(v=>[u(v,!1),u(v,!0)]);t.push(l)}t.push([w()]);for(const a of t)await Promise.all(a)}catch(e){throw e}finally{y.value=!1}}},n=L(()=>(e,o=!1)=>({...(o?m.value:i.value)[e]}));return{isLoading:y,companyReportData:i,lastCompanyReportData:m,fourWeekData:c,fetchReportData:u,fetchAllReportsData:r,resetReportData:D,getReportDataList:n}}),K={class:"chart-wrapper"},Q={__name:"DailyChart",props:{chartType:{type:String,default:"bar"},meterType:{type:String,default:null}},setup(y){const i=f(!1),{t:m}=j(),c=G(),C=M(),h=f(null);let s=y;const g=r=>(s.meterType||(r=r.data),r.length?r.map(n=>({time:Y(n.start_time,"HH:mm"),value:Number(n.Value||0).toFixed(2)})):[]),u=z({});async function w(){i.value=!0;const r=f(null),n=f(null);if(s.meterType){A().setCurrentMeter(null);let e=await Promise.all([c.fetchReportData("daily",!1,{isAddStore:!1,type:s.meterType}),c.fetchReportData("daily",!0,{isAddStore:!1,type:s.meterType})]);r.value=e[0],n.value=e[1]}else r.value=c.getReportDataList("daily"),n.value=c.getReportDataList("daily",!0);D(r.value,n.value),i.value=!1}R(()=>c.getReportDataList("daily"),w),R([()=>s.meterType,()=>s.chartType,()=>C.currentCompany],w,{immediate:!0});function D(r,n){const e=g(r),o=g(n);if(!e.length&&!o.length){u.value={};return}u.value={xAxisData:e.map(t=>t.time),series:[{name:m("date.label.dayBefore"),data:o.map(t=>t.value),type:s.chartType},{name:m("date.label.yesterday"),data:e.map(t=>t.value),type:s.chartType}],customColors:["#7dafff","#409EFF"],showMarkLine:!0,showZoom:!0}}return(r,n)=>{const e=$;return F((T(),I("div",K,[u.value?(T(),W(J,{key:0,ref_key:"baseChartRef",ref:h,height:"100%",width:"100%",options:u.value},null,8,["options"])):V("",!0)])),[[e,i.value]])}}},U=P(Q,[["__scopeId","data-v-32e0d5d0"]]),oe=Object.freeze(Object.defineProperty({__proto__:null,default:U},Symbol.toStringTag,{value:"Module"}));export{U as D,oe as a,G as u};
