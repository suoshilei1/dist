import{_ as U,r as n,a as j,F as q,w as k,o as z,m as x,c as p,d as V,e as B,i as r,j as a,f as c,Y as J,J as M,g as h,I as v,U as Y,V as G,v as H}from"./index-Bx6Y8L80.js";import{E as K}from"./button-8bviUT_H.js";import{d as C}from"./dayjs.min-Cd48fqZ9.js";import{u as Q,a as W,f as R,b as X,d as Z,t as I}from"./meter-5sbrBbgq.js";import{C as ee}from"./CustomDatePicker-CX6MdPmZ.js";import{u as te}from"./area-COPnz-hV.js";/* empty css             *//* empty css                        */import{E as F}from"./index-CWCMyxJA.js";import"./index-A4BGBRGh.js";import"./plugin-vue_export-helper-CqGSI99y.js";import"./index-AkNVqhGZ.js";import"./use-form-item-50hJ8Ppj.js";import"./icon-6zrsquxY.js";import"./date-picker-CfUXe-Kp.js";import"./popper-DBn8ulUn.js";import"./index-CuyxIfpa.js";import"./aria-BUADUvnR.js";import"./focus-trap-Ddg061Nm.js";import"./input-CFaQgGx5.js";import"./index-iw6eP590.js";import"./scrollbar-DuXO1tWo.js";import"./index-DLcTS03G.js";import"./index-zrRcpBp4.js";import"./isEqual-BM-Gj-iT.js";import"./_Uint8Array-B6mJ0Xm4.js";/* empty css                 */import"./index-KJp6TXG9.js";const re={class:"meter-report-container"},oe={class:"meter-report-header"},ae={__name:"index",setup(ie){const i=Q(),S=te(),E=n(null),l=n([C().startOf("year").valueOf(),C().endOf("year").valueOf()]),b={type:"xlsx",includeFooter:!0,useStyle:!0,isFooter:!0,isColgroup:!0,isAllExpand:!0,filename:"电表月统计报表",sheetName:"表计报表",modes:["current"]},_=n([]),m=n(!1),g=n(!1),N=j({transform:!0,rowField:"id",parentField:"parent_id",lazy:!0,hasChild:"hasChild",showLine:!0,loadMethod:({row:t})=>$(t)}),A=q(()=>W(l.value[0],l.value[1],"month"));async function y(){if(!m.value)try{_.value=[],m.value=!0;const t=i.treeDataForChart.map(f=>D(f)),e=await Promise.all(t);_.value=e.filter(Boolean)}catch(t){F({type:"error",title:"Error",message:t.message||"获取电表数据失败"}),console.error("Failed to fetch meter report:",t)}finally{m.value=!1}}async function D(t){try{const e=await Z({id:t.id,start_time:l.value[0],end_time:C(l.value[1]).valueOf(),interval:"month"});return I(t,e)}catch(e){return F({type:"error",title:"Error",message:e.message||"获取电表数据失败"}),console.error(`Failed to fetch data for meter ${t.meter_code}:`,e),null}}const L=n(!1);async function $(t){try{const e=t.customChildren.map(w=>D(w));return(await Promise.all(e)).filter(Boolean)}catch(e){return F({type:"error",title:"Error",message:e.message||"获取电表数据失败"}),console.error("Failed to load child nodes:",e),[]}}async function O(){try{g.value=!0;const t=E.value;for(let e=0;e<i.meterLevels.length;e++)await(t==null?void 0:t.setAllTreeExpand(!0));await(t==null?void 0:t.openExport({includeFooter:!0}))}finally{g.value=!1}}return k([()=>l.value,()=>i.treeDataForChart],()=>{y()},{deep:!0}),k([()=>L.value],()=>{y()},{deep:!0}),z(async()=>{(!i.treeDataForChart.length||i.currentSelectedType!==2)&&(i.setCurrentSelectedType(2),await i.fetchMeterList()),y()}),(t,e)=>{const f=K,o=x("vxe-column"),w=x("vxe-colgroup"),T=x("vxe-table"),P=H;return p(),V("div",re,[B("div",oe,[r(ee,{maxDays:365*2,border:"","is-month-picker":!0,round:"",modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=s=>l.value=s)},null,8,["modelValue"]),r(f,{style:{"margin-left":"auto"},type:"success",loading:g.value,onClick:O},{icon:a(()=>e[1]||(e[1]=[B("i",{class:"fa fa-download"},null,-1)])),default:a(()=>[e[2]||(e[2]=c(" 导出 "))]),_:1},8,["loading"])]),J((p(),M(T,{ref_key:"tableRef",ref:E,height:"92%",border:"",align:"center",data:_.value,"tree-config":N,"export-config":b},{default:a(()=>[r(o,{type:"seq",width:"60"}),r(o,{fixed:"left","tree-node":"",field:"meter_code",title:"表计编号",width:"120"}),r(o,{width:"100","show-overflow":"tooltip",title:"所供区域"},{default:a(({row:s})=>[c(h(v(S).getAreaNameById(s.area_id)||"-"),1)]),_:1}),r(o,{width:"120","show-overflow":"tooltip",field:"installation_location",title:"安装位置"}),r(o,{field:"specification",width:"100",title:"规格"}),r(o,{width:"100",field:"startReading",title:"启读数"}),(p(!0),V(Y,null,G(A.value,(s,d)=>(p(),M(w,{key:s,title:s},{default:a(()=>[r(o,{width:"100",field:`usage_${d}`,title:"用量"},{default:a(({row:u})=>[c(h(v(R)(u[`usage_${d}`])),1)]),footer:a(({row:u})=>[c(h(v(R)(u[`usage_${d}`])),1)]),_:2},1032,["field"]),r(o,{width:"100",field:`reading_${d}`,title:"读数"},{default:a(({row:u})=>[c(h(v(X)(u[`reading_${d}`])),1)]),_:2},1032,["field"])]),_:2},1032,["title"]))),128)),r(o,{fixed:"right",field:"sum",width:"100",title:"总用量"})]),_:1},8,["data","tree-config"])),[[P,m.value]])])}}},Ae=U(ae,[["__scopeId","data-v-bc0caa8e"]]);export{Ae as default};
