import{z as be,cx as ke,D as le,aR as we,E as Ee,r as v,F as H,c as d,J as T,j as a,Y as te,e as i,N as I,I as m,K as Ce,h as L,d as C,M as Z,f as _,g as $,U as z,i as t,a2 as Ve,bl as Te,O as Fe,_ as ae,ae as Se,W as oe,w as se,o as re,V as X,q as $e,v as he}from"./index-Bx6Y8L80.js";import{E as ne}from"./drawer-C6VChdbn.js";import"./overlay-04qnzRyj.js";import{E as ie,a as ue}from"./form-item-CWYWsPGl.js";import{E as xe}from"./date-picker-CfUXe-Kp.js";import{E as De}from"./input-CFaQgGx5.js";import"./scrollbar-DuXO1tWo.js";import"./popper-DBn8ulUn.js";import{E as me}from"./button-8bviUT_H.js";import{E as de,a as ce}from"./table-column-DjUxz4le.js";import"./checkbox-LjaCbo-5.js";/* empty css                *//* empty css            */import{E as Me,a as Ie}from"./select-BmMHn9PT.js";import{g as pe,a as Ae,e as Ue,c as Be,d as Ne}from"./formula-SHWkc_ME.js";import{u as Oe,s as Ye}from"./constants-NVab_QuI.js";import{e as Le}from"./meter-5sbrBbgq.js";/* empty css             *//* empty css                 *//* empty css                        */import{E as g}from"./index-KJp6TXG9.js";import{E as fe}from"./index-CWCMyxJA.js";import{d as q}from"./dayjs.min-Cd48fqZ9.js";/* empty css                   */import{E as ze}from"./index-slq3sC_j.js";import{E as ee}from"./index-A4BGBRGh.js";import{a as ve,T as Re}from"./icon-6zrsquxY.js";import{_ as Pe}from"./plugin-vue_export-helper-CqGSI99y.js";import"./index-DZY-cmUL.js";import"./index-CuyxIfpa.js";import"./scroll-BawlEUY1.js";import"./vnode-DK7gyQZj.js";import"./index-AkNVqhGZ.js";import"./focus-trap-Ddg061Nm.js";import"./aria-BUADUvnR.js";import"./use-form-item-50hJ8Ppj.js";import"./castArray-CrUPC_Z8.js";import"./_Uint8Array-B6mJ0Xm4.js";import"./_initCloneObject-nnMrnZRY.js";import"./index-DLcTS03G.js";import"./index-zrRcpBp4.js";import"./index-iw6eP590.js";import"./isEqual-BM-Gj-iT.js";import"./_baseIteratee-CkjM3wkz.js";import"./index-aFn2MKle.js";import"./validator-ulZFuTQV.js";const qe=["light","dark"],He=be({title:{type:String,default:""},description:{type:String,default:""},type:{type:String,values:ke(ve),default:"info"},closable:{type:Boolean,default:!0},closeText:{type:String,default:""},showIcon:Boolean,center:Boolean,effect:{type:String,values:qe,default:"light"}}),je={close:B=>B instanceof MouseEvent},We=le({name:"ElAlert"}),Je=le({...We,props:He,emits:je,setup(B,{emit:h}){const x=B,{Close:V}=Re,w=we(),s=Ee("alert"),b=v(!0),y=H(()=>ve[x.type]),c=H(()=>[s.e("icon"),{[s.is("big")]:!!x.description||!!w.default}]),F=H(()=>({"with-description":x.description||w.default})),r=n=>{b.value=!1,h("close",n)};return(n,A)=>(d(),T(Te,{name:m(s).b("fade"),persisted:""},{default:a(()=>[te(i("div",{class:I([m(s).b(),m(s).m(n.type),m(s).is("center",n.center),m(s).is(n.effect)]),role:"alert"},[n.showIcon&&m(y)?(d(),T(m(ee),{key:0,class:I(m(c))},{default:a(()=>[(d(),T(Ce(m(y))))]),_:1},8,["class"])):L("v-if",!0),i("div",{class:I(m(s).e("content"))},[n.title||n.$slots.title?(d(),C("span",{key:0,class:I([m(s).e("title"),m(F)])},[Z(n.$slots,"title",{},()=>[_($(n.title),1)])],2)):L("v-if",!0),n.$slots.default||n.description?(d(),C("p",{key:1,class:I(m(s).e("description"))},[Z(n.$slots,"default",{},()=>[_($(n.description),1)])],2)):L("v-if",!0),n.closable?(d(),C(z,{key:2},[n.closeText?(d(),C("div",{key:0,class:I([m(s).e("close-btn"),m(s).is("customed")]),onClick:r},$(n.closeText),3)):(d(),T(m(ee),{key:1,class:I(m(s).e("close-btn")),onClick:r},{default:a(()=>[t(m(V))]),_:1},8,["class"]))],64)):L("v-if",!0)],2)],2),[[Ve,b.value]])]),_:3},8,["name"]))}});var Ke=Pe(Je,[["__file","alert.vue"]]);const Ge=Fe(Ke),Qe={class:"formula-help"},Xe={class:"symbol-table-container"},Ze={key:0,class:"symbol-cell"},el={key:1,class:"symbol-cell"},ll={__name:"setFormula",props:{formulaOptions:{type:Array,default:()=>[]}},emits:["update-formula"],setup(B,{expose:h,emit:x}){const V=x,w=v(null),s=v(null),b=v(!1),y=v(!1),{currentCompany:c}=Se(oe()),F={name:[{required:!0,message:"请输入公式名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符之间",trigger:"blur"}],formula:[{required:!0,message:"请输入公式内容",trigger:"blur"}],usage:[{required:!0,message:"请选择使用标识",trigger:"change"}]},r=v({company_id:c.value.id,name:"",formula:"",usage:"",id:null}),n=v([]),A=async()=>{try{y.value=!0;const e=await pe(c.value.id);e.code===200?n.value=e.data||[]:g.error("获取公式列表失败")}catch(e){console.error("加载公式列表出错:",e),g.error("加载公式列表时发生错误")}finally{y.value=!1}},N=e=>{b.value=!0,e?(r.value={company_id:c.value.id,name:e.name||"",formula:e.formula||"",usage:e.usage||"",id:e.id?Number(e.id):null},s.value=e.id?Number(e.id):null):O()},O=()=>{w.value&&w.value.resetFields(),r.value={company_id:c.value.id,name:"",formula:"",usage:"",id:null},s.value=null},j=async()=>{try{y.value=!0;const{id:e,...o}=r.value,f=await Ae({...o});f.code===200?(g.success("添加成功"),await A(),b.value=!1,V("update-formula")):g.error(f.message||"添加失败")}catch(e){console.error("添加公式出错:",e),g.error("添加公式时发生错误")}finally{y.value=!1}},W=async()=>{try{y.value=!0;const e=await Ue({...r.value});e.code===200?(g.success("修改成功"),await A(),b.value=!1,V("update-formula")):g.error(e.message||"修改失败")}catch(e){console.error("编辑公式出错:",e),g.error("编辑公式时发生错误")}finally{y.value=!1}},p=async()=>{w.value&&w.value.validate(async e=>{e&&(s.value?await W():await j(),O())})};se(()=>c.value,async e=>{e!=null&&e.id&&await A()},{immediate:!0});const l=()=>{b.value=!1,O()},k=e=>{r.value.formula=e},S=e=>{r.value.formula+=e};h({open:N});const Y=v(null),U=v([]);function R(e){r.value.formula+=e.replace("x",Y.value)}async function J(){try{return(await Le({company_id:$e().userCompany.id})).data}catch(e){console.error("获取表计列表失败:",e),fe({title:"错误",message:"获取表计列表失败",type:"error"})}}re(async()=>{U.value=await J()});const K=H(()=>{const e=r.value.usage;if(!e)return U.value;let o=0;return e.includes("水")&&(o=1),e.includes("电")&&(o=2),e.includes("气")&&(o=3),U.value.filter(f=>f.type===o)});return(e,o)=>{const f=De,E=ie,D=Me,G=Ie,P=me,Q=de,ye=ce,_e=ue,ge=ne;return d(),T(ge,{modelValue:b.value,"onUpdate:modelValue":o[4]||(o[4]=u=>b.value=u),title:s.value?"编辑公式":"新增公式",size:"50%","before-close":l},{default:a(()=>[t(_e,{ref_key:"formRef",ref:w,model:r.value,rules:F,"label-width":"100px","label-position":"top",class:"custom-form"},{default:a(()=>[t(E,{label:"公式名称",prop:"name"},{default:a(()=>[t(f,{modelValue:r.value.name,"onUpdate:modelValue":o[0]||(o[0]=u=>r.value.name=u),placeholder:"请输入公式名称",clearable:"",maxlength:50,"show-word-limit":""},null,8,["modelValue"])]),_:1}),t(E,{label:"根据选择已有公式快速添加"},{default:a(()=>[t(G,{placeholder:"选择已有公式",onChange:k,clearable:"",class:"w-full"},{default:a(()=>[(d(!0),C(z,null,X(n.value,u=>(d(),T(D,{key:u.id,label:u.name,value:u.formula},null,8,["label","value"]))),128))]),_:1})]),_:1}),t(E,{label:"使用标识",prop:"usage"},{default:a(()=>[t(G,{modelValue:r.value.usage,"onUpdate:modelValue":o[1]||(o[1]=u=>r.value.usage=u),placeholder:"请选择使用标识",clearable:""},{default:a(()=>[(d(!0),C(z,null,X(m(Oe),u=>(d(),T(D,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(E,{label:"公式内容",prop:"formula"},{default:a(()=>[t(f,{modelValue:r.value.formula,"onUpdate:modelValue":o[2]||(o[2]=u=>r.value.formula=u),type:"textarea",rows:4,placeholder:"请输入公式内容",clearable:""},null,8,["modelValue"]),i("div",Qe,[o[7]||(o[7]=i("div",{class:"help-header"},[i("span",{class:"text-gray-600"},"支持基础运算符(+,-,*,/,%,^)及常见数学函数")],-1)),i("div",Xe,[t(ye,{data:m(Ye),border:"",stripe:"",size:"small",style:{width:"100%"},height:"400"},{default:a(()=>[t(Q,{prop:"symbol",label:"符号",align:"center"},{default:a(u=>[u.row.symbol!=="meter(x,START,END)"?(d(),C("div",Ze,[i("span",null,$(u.row.symbol),1),t(P,{type:"primary",link:"",onClick:M=>S(u.row.symbol)},{default:a(()=>o[5]||(o[5]=[_("插入")])),_:2},1032,["onClick"])])):(d(),C("div",el,[i("span",null,[t(G,{style:{width:"8rem"},modelValue:Y.value,"onUpdate:modelValue":o[3]||(o[3]=M=>Y.value=M),placeholder:"选择表计"},{default:a(()=>[(d(!0),C(z,null,X(K.value,M=>(d(),T(D,{key:M.id,label:M.meter_code,value:M.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t(P,{type:"primary",link:"",onClick:M=>R(u.row.symbol)},{default:a(()=>o[6]||(o[6]=[_("插入")])),_:2},1032,["onClick"])]))]),_:1}),t(Q,{prop:"explanation",label:"解释",align:"left"}),t(Q,{prop:"example",label:"使用案例",align:"left"})]),_:1},8,["data"])])])]),_:1}),t(E,null,{default:a(()=>[t(P,{type:"primary",onClick:p,loading:y.value},{default:a(()=>[_($(s.value?"保存":"确定"),1)]),_:1},8,["loading"]),t(P,{onClick:l},{default:a(()=>o[8]||(o[8]=[_("取消")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}},tl=ae(ll,[["__scopeId","data-v-d39907d0"]]),al={class:"page-title",style:{display:"flex","justify-content":"space-between","align-items":"center"}},ol={class:"formula-management"},sl={class:"test-formula-container"},rl={class:"formula-info"},nl={class:"test-parameters"},il={key:0,class:"test-result"},ul={class:"dialog-footer"},ml={__name:"index",setup(B){const h=oe(),x=h.currentCompany.id,V=v([]),w=v(!1),s=async(p=x)=>{w.value=!0;try{const l=await pe(p);V.value=l.data}catch(l){console.error("Error getting formula:",l),fe({title:"错误",type:"error",message:"获取公式失败，请稍后再试"})}finally{w.value=!1}};se(()=>h.currentCompany,()=>{let p=h.currentCompany.id;s(p)});const b=v(!1),y=v(null),c=v({startTime:q().subtract(1,"day").valueOf(),endTime:q().valueOf()}),F=v(null),r=v(!1),n=p=>{y.value=p,b.value=!0,F.value=null,c.value={startTime:q().subtract(1,"day").valueOf(),endTime:q().valueOf()}},A=async()=>{if(!c.value.startTime||!c.value.endTime){g.warning("请选择开始和结束时间");return}r.value=!0;try{const p={id:y.value.id,start_time:new Date(c.value.startTime).getTime(),end_time:new Date(c.value.endTime).getTime()},l=await Be(p);l.code===200?(F.value=l.data,g.success("计算成功")):g.error(l.message||"计算失败")}catch(p){console.error("Error computing formula:",p),g.error("计算失败，请稍后再试")}finally{r.value=!1}};re(()=>{s()});const N=v(),O=()=>{N.value.open()},j=p=>{N.value.open(p)},W=async p=>{const l={id:String(p.id)};try{await ze.confirm("此操作将永久删除该公式, 是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const k=await Ne(l);k.code===200?(V.value=V.value.filter(S=>S.id!==p.id),g({message:"删除成功",type:"success"})):g({message:`删除失败: ${k.message||"未知错误"}`,type:"error"})}catch(k){k!=="cancel"?(console.error("Error deleting formula:",k),g({message:"删除失败，请稍后再试",type:"error"})):console.log("用户取消删除操作")}};return(p,l)=>{const k=me,S=de,Y=ce,U=xe,R=ie,J=ue,K=Ge,e=ne,o=he;return d(),C(z,null,[i("div",al,[l[5]||(l[5]=_(" 公式管理 ")),t(k,{style:{"margin-left":"16px"},type:"primary",icon:"plus",onClick:O},{default:a(()=>l[4]||(l[4]=[_("添加公式")])),_:1})]),i("div",ol,[te((d(),T(Y,{data:V.value,border:"",stripe:"",class:"custom-table"},{default:a(()=>[t(S,{prop:"name",label:"公式名称",align:"center",width:"200"}),t(S,{prop:"usage",label:"使用标识",align:"center",width:"200"}),t(S,{prop:"formula",label:"公式内容",align:"center"}),t(S,{label:"操作",align:"center",width:"280"},{default:a(f=>[t(k,{onClick:E=>j(f.row),type:"primary",size:"small",class:"action-button"},{default:a(()=>l[6]||(l[6]=[_(" 编辑 ")])),_:2},1032,["onClick"]),t(k,{onClick:E=>n(f.row),type:"success",size:"small",class:"action-button"},{default:a(()=>l[7]||(l[7]=[_(" 测试 ")])),_:2},1032,["onClick"]),t(k,{onClick:E=>W(f.row),type:"danger",size:"small",class:"action-button"},{default:a(()=>l[8]||(l[8]=[_(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[o,w.value]]),t(tl,{ref_key:"formulaAdd",ref:N,onUpdateFormula:s},null,512),t(e,{modelValue:b.value,"onUpdate:modelValue":l[3]||(l[3]=f=>b.value=f),title:"测试公式"},{footer:a(()=>[i("span",ul,[t(k,{onClick:l[2]||(l[2]=f=>b.value=!1)},{default:a(()=>l[14]||(l[14]=[_("取 消")])),_:1}),t(k,{type:"primary",onClick:A,loading:r.value},{default:a(()=>[_($(r.value?"计算中...":"计算"),1)]),_:1},8,["loading"])])]),default:a(()=>{var f,E;return[i("div",sl,[i("div",rl,[l[11]||(l[11]=i("h3",null,"公式信息",-1)),i("p",null,[l[9]||(l[9]=i("strong",null,"公式名称：",-1)),_($((f=y.value)==null?void 0:f.name),1)]),i("p",null,[l[10]||(l[10]=i("strong",null,"公式内容：",-1)),_($((E=y.value)==null?void 0:E.formula),1)])]),i("div",nl,[l[12]||(l[12]=i("h3",null,"测试参数",-1)),t(J,{model:c.value,"label-width":"120px"},{default:a(()=>[t(R,{label:"开始时间"},{default:a(()=>[t(U,{modelValue:c.value.startTime,"onUpdate:modelValue":l[0]||(l[0]=D=>c.value.startTime=D),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),t(R,{label:"结束时间"},{default:a(()=>[t(U,{modelValue:c.value.endTime,"onUpdate:modelValue":l[1]||(l[1]=D=>c.value.endTime=D),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),F.value!=null?(d(),C("div",il,[l[13]||(l[13]=i("h3",null,"计算结果",-1)),t(K,{title:`计算结果: ${F.value}`,type:"success",closable:!1,"show-icon":""},null,8,["title"])])):L("",!0)])]}),_:1},8,["modelValue"])])],64)}}},at=ae(ml,[["__scopeId","data-v-82198207"]]);export{at as default};
